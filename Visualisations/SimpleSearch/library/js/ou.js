var OU=new function(){this.obj={};this.head=document.getElementsByTagName("head")[0];this.requiredFiles=0;this.__mini=!0;this._buttonCount=this.fileCount=0;this.IS_IPAD=navigator.userAgent.match(/iPad/i);this.IS_IPHONE=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i);this.util=function(){};this.activity=function(){};this.menus=[];this.controllers=[];this._tabbables=[];this.FileLoaded={};this.preOnLoad=[];this.preLoadImg=[];this._debug=/debug/.test(window.location);var a=window.location.toString();
try{this.makeWidget=void 0!==makeWidgetOU?!0:!1}catch(b){this.makeWidget=!1}try{this.makeApp=cordova?!0:!1}catch(c){this.makeApp=!1}!a.match(/^https:/)&&!a.match(/^http:/)&&!a.match(/^file:/)||this.makeWidget?(this.widget=!0,this.libPath="library/js/"):this.makeApp?(this.widget=!1,this.libPath="library/js/"):(this.widget=!1,this.libPath="../library/js/");this.loadingTicks=0;this.dpr=1;if(2===window.devicePixelRatio&&window===window.top&&(a=document.querySelector('meta[name="viewport"]')))a.content=
"width=device-width, minimum-scale=0.505, maximum-scale=0.505, initial-scale=0.505",this.dpr=2;this.controlHeight=40*this.dpr;return this};OU._enableResize=!0;OU.LOADING=0;OU.PAUSED=1;OU.RUNNING=2;OU.DATA_LEVEL=20;OU.CONTROL_LEVEL=50;OU.CONTROLLER_LEVEL=90;OU.OVERLAY_CONTROLLER_LEVEL=8E3;OU.POP_UP_LEVEL=9E3;OU.CLOSE_LEVEL=9500;OU.DEBUG_LEVEL=1E4;OU.ABSOLUTE_TOP=5E4;
OU.inherits=function(a,b){var c=function(){};c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};
OU.base=function(a,b,c){var d=arguments.callee.caller;if(d.superClass_)return d.superClass_.constructor.apply(a,Array.prototype.slice.call(arguments,1));for(var e=Array.prototype.slice.call(arguments,2),f=!1,g=a.constructor;g;g=g.superClass_&&g.superClass_.constructor)if(g.prototype[b]===d)f=!0;else if(f)return g.prototype[b].apply(a,e);if(a[b]===d)return a.constructor.prototype[b].apply(a,e);throw Error("OU.base called from a method of one name ("+a[b]+") to a method of a different name:"+d);};
OU.log=function(a){this._debug?this.debugDiv?(this._cachedDebug&&(a=this._cachedDebug+a+"<br/>",this._cachedDebug=null),this.debugDiv.innerHTML+=a+"<br/>"):this._cachedDebug=this._cachedDebug?this._cachedDebug+(a+"<br/>"):a+"<br/>":console.log(a)};
OU.require=function(a){var b,c=a.toLowerCase().replace(/\./g,"/"),d=c.replace(/^ou\//,this.libPath)+".js";if((!this.__mini||!a.match(/^OU\.util/))&&!this.FileLoaded[c])this.FileLoaded[c]=!0,this.requiredFiles++,b=document.createElement("script"),b.src=d,b.type="text/javascript",document.all?b.onreadystatechange=function(){("complete"===b.readyState||"loaded"===b.readyState)&&OU.fileCount++}:b.onload=function(){OU.fileCount++},this.head.appendChild(b)};
OU.loadTheme=function(){var a=data.theme||"default",b=document.createElement("script");this.loadCSS(this.widget?"library/css/themes/"+a+".css":"../library/css/themes/"+a+".css");OU.requiredFiles++;b.src=this.libPath+"themes/"+a+".js";b.type="text/javascript";document.all?b.onreadystatechange=function(){("complete"===b.readyState||"loaded"===b.readyState)&&OU.fileCount++}:b.onload=function(){OU.fileCount++};this.head.appendChild(b)};
OU.loadFonts=function(){var a,b="",c="",d=data.font;if(d){for(var e=OU.fontsDone=0;e<d.length;e++)a=d[e].name,b=b+"@font-face {font-family:"+a+"; src: url( "+d[e].url+" ) format('truetype');}\n",c=c+"."+a+"{font-family:'"+a+"';}\n";a=document.createElement("style");a.innerHTML=b+c;a.type="text/css";a.async="true";b=document.getElementsByTagName("style")[0]?document.getElementsByTagName("style")[0]:document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}};
OU.bakeFonts=function(){var a,b,c="",d=data.font;if(d){for(a=OU.fontsDone=0;a<d.length;a++)b=d[a].name,c=c+"<span class='"+b+"'>LOADING...</span>";a=document.createElement("div");a.id="fontcacher";a.innerHTML=c;document.body.appendChild(a);setTimeout("OU.waitFonts()",2500)}};OU.waitFonts=function(){OU.fontsDone=1};OU.preLoad=function(){var a=data.preload;if(a)for(var b=OU.preloadDone=0;b<a.length;b++)""!==a[b]?(this.preLoadImg[b]=new Image,this.preLoadImg[b].src=a[b]):this.preLoadImg.push("")};
OU.loadCSS=function(a){var b=document.createElement("link");b.href=a;b.rel="stylesheet";b.type="text/css";this.head.appendChild(b)};
OU.onLoad=function(a){a?(this.onLoadFn=a,OU.loadingTicks=0):(a=this.onLoadFn,OU.loadingTicks++);if(this.fileCount>=this.requiredFiles||100<this.loadingTicks){100<this.loadingTicks&&OU.log("Problem loading all required files - loaded "+this.fileCount+" of "+this.requiredFiles);for(var b=this.preOnLoad.length;b--;)this.preOnLoad[b]();a()}else setTimeout("OU.onLoad();",40)};
OU.initPage=function(){document.body.innerHTML="";window.scrollTo(0,0);OU._closeBDone=!1;if(this._debug){var a=this.debugDiv=document.createElement("div");a.style.zIndex="500000";a.style.background="#fff";a.style.position="absolute";a.style.border="1px solid #c00";a.style.padding="10px";a.height=500;a.style.overflow="auto";document.body.appendChild(a)}};
OU.removeActivity=function(a,b){var c,d=OU.controllers[b].section;OU.clean(a);for(c=d.activityObjects.length;c--;)d.activityObjects[c]&&d.activityObjects[c]._zOffset===a&&(d.activityObjects[c].remove&&d.activityObjects[c].remove(),delete d.activityObjects[c],d.activityObjects[c]=null);for(c=d.activities.length;c--;)d.activities[c]._zOffset===a&&d.activities.splice(c,1)};
OU.clean=function(a){var b,c;for(b=OU.removables.length;b--;)if((c=OU.removables[b])&&(void 0===a||c._clicktype===a))c.remove(),delete c,OU.removables[b]=null};OU.addRemovable=function(a,b){var c;a&&(a.controller?c=a.controller:a.container&&a.container.controller&&(c=a.container.controller),c=c?c.instance:"nocontroller",a._controllerInstance=c,OU.removables.push(a,b))};
OU.cleanSection=function(a){var b,c;for(b=OU.removables.length;b--;)if((c=OU.removables[b])&&c._controllerInstance===a.instance)OU.obj[c.instance]&&(OU.obj[c.instance]=null),c.remove(),delete c,OU.removables[b]=null};OU.stepMenu=function(a,b,c){OU.menus[a].step(b,c);return!1};OU.storeOverride=function(a){void 0===OU._overrideArray&&(OU._overrideArray=[]);OU._overrideArray.push(a);return OU._overrideArray.length-1};
OU.replaceActivity=function(a,b,c){OU.removeActivity(b,c.controllerId);a=OU._overrideArray[a];void 0!==a&&c.addActivity(a,!0);return!1};OU.preventDefault=function(a){a.preventDefault()};OU.nobbleDoneBar=function(a){a.addEventListener("touchstart",OU.preventDefault,!1);a.addEventListener("touchend",OU.preventDefault,!1);a.addEventListener("touchmove",OU.preventDefault,!1)};OU.util.TypedArray=function(){Array.call(this);this.prototype=[];this.base=Array.prototype};
OU.util.TypedArray.prototype.push=function(a,b){void 0!==b&&(a._clicktype=b);this.base.push.call(this,a)};OU.util.TypedArray.prototype.removeType=function(a){var b;for(b=this.length;b--;)this[b]&&this[b]._clicktype===a&&(this[b]=null)};OU.util.TypedArray.prototype.removeIdx=function(a){this[a]=null;this.base.splice.call(this,a,1)};OU.removables=new OU.util.TypedArray;OU.disableResize=function(){OU._enableResize=!1};OU.enableResize=function(){OU._enableResize=!0};
OU.onOrientChange=function(a){OU._OCHandlerSet||(OU._OCHandlerSet=!0,OU._oldInnerWidth=window.innerWidth,OU._oldOuterWidth=window.outerWidth,OU._oldInnerHeight=window.innerHeight,OU._oldOuterHeight=window.outerHeight,OU._onOChangeInterval&&window.clearInterval(OU._onOChangeInterval),OU._onOChangeInterval=window.setInterval(function(){try{if(OU._enableResize&&(OU._oldInnerWidth!==window.innerWidth||OU._oldOuterWidth!==window.outerWidth||OU._oldInnerHeight!==window.innerHeight||OU._oldOuterHeight!==
window.outerHeight))OU._closeButtonDone=!1,a();OU._oldInnerWidth=window.innerWidth;OU._oldOuterWidth=window.outerWidth;OU._oldInnerHeight=window.innerHeight;OU._oldOuterHeight=window.outerHeight}catch(b){if(OU._enableResize&&(OU._oldInnerWidth!==window.innerWidth||OU._oldInnerHeight!==window.innerHeight))OU._closeButtonDone=!1,a();OU._oldInnerWidth=window.innerWidth;OU._oldInnerHeight=window.innerHeight}},40),window.onorientationchange=a)};
OU.supportsLocalStorage=function(){return localStorage?!0:!1};OU._localStorage=OU.supportsLocalStorage();OU.LocalStorage=OU._localStorage?{save:function(a,b){localStorage[a]=b},load:function(a){return localStorage[a]}}:{save:function(a,b){document.cookie=a+"="+encodeURIComponent(b)},load:function(a){var b="; "+document.cookie+";",c=b.indexOf("; "+a+"=");if(0>c)return"";c=c+a.length+3;a=b.indexOf(";",c+1);return decodeURIComponent(b.substring(c,a))}};
OU.VLEget=function(a,b,c,d,e,f,g){if(VLE&&VLE.serverversion)VLE.get_server_data(a,b,c||function(){},d||function(){},e,f,g);else{a=[];for(d=b.length;d--;)a[b[d]]=OU.LocalStorage.load(b[d]);c&&c(a)}};OU.VLEset=function(a,b,c,d,e,f,g,h,i){VLE&&VLE.serverversion&&VLE.set_server_data(a,b,c||function(){},d||function(){},e,f,g,h,i);for(var j in b)OU.LocalStorage.save(j,""+b[j])};
OU.resizeCloseButton=function(a){var b=45*OU.dpr;a.closeLayer&&(a.closeLayer.resize({x:a.w-b,y:0,w:b,h:b}),a.closeLayer.context.closeIcon({x:(b-15*OU.dpr)/2,y:(b-15*OU.dpr)/2,r:15*OU.dpr}),a.closeLayer.events.clickable.length=0,a.closeLayer.events.clickable.push(new OU.util.InvisibleButton({x:0,y:0,w:b,h:b,onClick:function(){window.location=OU.epubBack}})))};OU.loadBackRef=function(){var a=document.createElement("script");a.src="data/back.js";a.type="text/javascript";this.head.appendChild(a)};
OU.closeButton=function(a){var b=/back=(.*)/i,c=window.location.toString();OU._closeBDone||(OU._closeBDone=!0,this.widget&&!window.widget&&(this.epubBack||(this.epubBack="../chunk001.html",(b=b.exec(c))?this.epubBack=b[1]:OU.loadBackRef()),a.closeLayer=new OU.util.Layer({container:a,x:a.w-45,y:0,w:45,h:45,id:"_closeLayer",hasEvents:!0,zIndex:OU.CLOSE_LEVEL,dontRegister:!0}),a.closeLayer.context.closeIcon({x:15,y:15,r:15}),a.closeLayer.events.clickable.push(new OU.util.InvisibleButton({x:0,y:0,w:45,
h:45,onClick:function(){window.location=OU.epubBack}}))))};
OU.combineMouseTouch=function(a){if(void 0!==a.touches&&void 0!==a.touches[0])return{pageX:a.touches[0].pageX,pageY:a.touches[0].pageY,touches:a.touches};void 0!==a.targetTouches&&void 0!==a.targetTouches[0]&&(a=a.targetTouches[0]);if(void 0!==a.pageX&&void 0!==a.pageY)return{pageX:a.pageX,pageY:a.pageY};var b=!document.compatMode||"CSS1Compat"===document.compatMode?document.documentElement:document.body;return{pageX:a.clientX+b.scrollLeft,pageY:a.clientY+b.scrollTop}};
OU.distance2D=function(a){var b=a.x2-a.x1,a=a.y2-a.y1;return Math.sqrt(b*b+a*a)};OU.font=function(a){this.size=a.size||OU.theme.fontSize;this.weight=a.weight||"";this.style=a.style||"";this.family=void 0!==a.family?a.family+","+OU.theme.font:OU.theme.font;this.str=function(){return this.style+" "+this.weight+" "+this.size+"px "+this.family}};
OU.getUrlVars=function(){if(OU._urlVars)return OU._urlVars;OU._urlVars=[];window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,b,c){OU._urlVars[b]=c});return OU._urlVars};
if("object"===typeof CanvasRenderingContext2D||"function"===typeof CanvasRenderingContext2D)CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e){var f=Math.PI/180;c<2*e&&(e=c/2);d<2*e&&(e=d/2);this.beginPath();this.moveTo(a+e,b);this.lineTo(a+c-e,b);this.arc(a+c-e,b+e,e,270*f,360*f,!1);this.lineTo(a+c,b+d-e);this.arc(a+c-e,b+d-e,e,0*f,90*f,!1);this.lineTo(a+e,b+d);this.arc(a+e,b+d-e,e,90*f,180*f,!1);this.lineTo(a,b+e);this.arc(a+e,b+e,e,180*f,270*f,!1);this.closePath()},CanvasRenderingContext2D.prototype.roundRectTLC=
function(a,b,c,d,e){var f=Math.PI/180;c<2*e&&(e=c/2);d<2*e&&(e=d/2);this.beginPath();this.moveTo(a,b);this.lineTo(a+c-e,b);this.arc(a+c-e,b+e,e,270*f,360*f,!1);this.lineTo(a+c,b+d-e);this.arc(a+c-e,b+d-e,e,0*f,90*f,!1);this.lineTo(a+e,b+d);this.arc(a+e,b+d-e,e,90*f,180*f,!1);this.lineTo(a,b);this.closePath()},CanvasRenderingContext2D.prototype.gradRect=function(a){void 0===a&&(a={});var b=a.x||0,c=a.y||0,d=a.w||this.canvas.width,e=a.h||this.canvas.height,f=a.radius||0,g=a.col1||OU.theme.bgGradTopCol,
h=a.col2||OU.theme.bgGradBotCol,i=this.createLinearGradient(b,c,b,c+e);i.addColorStop(0,g);i.addColorStop(1,h);this.save();void 0!==a.alpha&&(this.globalAlpha=a.alpha);this.fillStyle=i;this.roundRect(b,c,d,e,f);this.fill();this.restore()},CanvasRenderingContext2D.prototype.background=function(a,b){if(void 0!==a){var c=b.x,d=b.y,e=b.w,f=b.h,g=null,h=a.alpha||1;a.clear&&this.clearRect(c,d,e,f);if(a.img)this.clearRect(c,d,e,f),this.drawImage(a.img,c,d,e,f);else if(a.col&&(g=a.col),a.RGB&&(g="rgba("+
a.RGB+","+h+")"),a.gradient&&(g=a.gradient),g)this.save(),this.beginPath(),a.shadow&&(this.shadowOffsetY=this.shadowOffsetX=2,this.shadowBlur=20,this.shadowColor="#666"),a.padding&&(c+=a.padding,d+=a.padding,e-=2*a.padding,f-=2*a.padding),this.fillStyle=g,void 0!==a.radius?(this.roundRect(c,d,e,f,a.radius),this.fill()):(this.fillRect(c,d,e,f),void 0!==a.borderCol&&this.rect(c,d,e,f)),a.gloss&&(c=this.createLinearGradient(c,d,c,d+f),c.addColorStop(0,"rgba(255,255,255,0.52)"),c.addColorStop(0.49,"rgba(255,255,255,0.26)"),
c.addColorStop(0.5,"rgba(255,255,255,0.13)"),c.addColorStop(1,"rgba(255,255,255,0.01)"),this.fillStyle=c,this.fill()),void 0!==a.borderCol&&(this.strokeStyle=a.borderCol,this.stroke()),this.closePath(),this.restore()}};Date.prototype.incYear=function(a){this.setFullYear(parseInt(this.getFullYear())+(a||1))};Date.prototype.incMonth=function(a){var a=parseInt(this.getMonth())+(a||1),b=a/12|0;1<=b?(this.incYear(b),this.setMonth(a%12)):this.setMonth(a)};
Date.prototype.incDay=function(a){this.setTime(this.valueOf()+864E5*(a||1))};Date.prototype.decYear=function(a){this.setFullYear(parseInt(this.getFullYear())-(a||1))};Date.prototype.decMonth=function(a){a=parseInt(this.getMonth())-(a||1);0>a?(this.decYear(Math.abs(a)/12|0),this.setMonth(12-Math.abs(a)%12)):this.setMonth(a)};Date.prototype.decDay=function(a){this.setTime(this.valueOf()-864E5*(a||1))};Number.prototype.nDecimals=function(a){a=Math.pow(10,a);return(this*a+(0<this?0.5:-0.5)|0)/a};
String.prototype.breaker=function(a){for(var b=this.split(a),a=0;a<b.length;a++)b[a]=b[a].trim();return b};function typeOf(a){return"object"===typeof a?a.length?"array":"object":typeof a}OU.registerMessenger=function(a){OU._messengerRegister||(OU._messengerRegister=[]);var b=OU._messengerRegister.length;OU._messengerRegister[b]=a;a.__messengerArrayIndex=b;a.__messengerParams=[];a.defineActivityAPI=function(b){OU.addMessengerParams(b,this)}};
OU.addMessengerParams=function(a,b){var c;if("object"===typeOf(a))b.__messengerParams.push(a);else for(c=a.length;c--;)b.__messengerParams.push(a[c])};OU.removeMessenger=function(a){OU._messengerRegister[a.__messengerArrayIndex]=null};
OU.listMessengers=function(){var a,b,c,d=0,e,f,g=[],h;for(b=OU._messengerRegister.length;b--;)if(a=OU._messengerRegister[b]){e=a.__messengerParams;f=[];for(c=e.length;c--;)f.push({name:e[c].name,gettable:null!==e[c].getFunction&&void 0!==e[c].getFunction,settable:null!==e[c].setFunction&&void 0!==e[c].setFunction});a.controllerActivity&&(h=a.controllerActivity.type);0<e.length&&(d++,g.push({id:b,instance:a.instance,type:h,params:f}))}return 0===d?"No Activities":g};
OU._getSetMessengerParamMessaging=function(a,b){var c,d,e,f="Invalid Activity ID";if(c=OU._messengerRegister[a.activityId]){d=c.__messengerParams;for(e=d.length;e--;)if(c=d[e],c.name===a.param){if("set"===a.action){if(c.setFunction)return c.setFunction(a.value),"Success";f="Parameter not settable"}if("get"===a.action){if(c.getFunction)return c.getFunction(a.value);f="Parameter not gettable"}if("monitor"===a.action){if(c.monitor)return a.value||(a.value={}),a.value.callback=function(c){var e={};e.action=
a.action;e.param=a.param;e.content=c;b.source.postMessage(e,b.origin)},c.monitor(a.value);f="Parameter not monitorable"}}f="Invalid Parameter name"}return"Failed: "+f};
OU._getSetMessengerParamInternal=function(a){var b,c,d;b="Invalid Activity ID";if(c=OU._messengerRegister[a.activityId]){c=c.__messengerParams;for(d=c.length;d--;)if(b=c[d],b.name===a.param){if("set"===a.action&&b.setFunction)return b.setFunction(a.value),"Success";if("get"===a.action&&b.getFunction)return b.getFunction(a.value);if("monitor"===a.action&&b.monitor&&a.value)return b.monitor(a.value)}b="Invalid Parameter name"}return"Failed: "+b};
OU._msgRecieve=function(a){var b=a.data,c;if(b&&b.action){c={action:b.action,param:b.param};switch(b.action){default:case "list":c.content=OU.listMessengers();break;case "get":case "set":case "monitor":c.content=OU._getSetMessengerParamMessaging(b,a);break;case "hello":c.content="hiya"}a.source.postMessage(c,a.origin)}};window.addEventListener("message",OU._msgRecieve);
OU.util.Activity=function(a,b,c){this.instance=b||"a1";this.data=a||{};this._prefO=a.preferredOrientation;this.controller=c;this.state=OU.LOADING;this.controller&&this.controller.activityDefs[this.instance]?(this.controllerActivity=this.controller.activityDefs[this.instance],this.dataDir=this.controllerActivity.data,this.zOffset=this.controllerActivity._zOffset):(this.dataDir="data/",this.zOffset=0);this.init();this.data.css&&this.loadCSSFile(this.data.css);this._resizeable=!0;this._resizeNeeded&&
this.resize()};OU.util.Activity.prototype.init=function(){var a=this;OU.initPage();OU.addRemovable(this,this.zOffset);OU.registerMessenger(this);!/accessible/.test(window.location)&&document.createElement("canvas").getContext?(this.getsize_(),this.forceController_(),"function"===typeof this.canvasView&&this.canvasView(),this.data.header&&this.header(this.data.header),OU.onOrientChange(function(){a.resize()})):this.accessibleView()};
OU.util.Activity.prototype.forceController_=function(){var a="";void 0===this.baseController&&void 0===this.controller&&(this.controller=OU.baseController?OU.baseController:new OU.util.Controller({sections:[{activities:[]}]}),this.controller.section.activityObjects.push(this),this.constructor&&this.constructor.toString&&(a=/(OU\..*)\.prototype/.exec(this.constructor.toString())[1]),this.controllerActivity={data:"data/",type:a},this.controller.section.activities.push(this.controllerActivity))};
OU.util.Activity.prototype.header=function(a){OU.baseController.header(a)};OU.util.Activity.prototype.canvasView=function(){};OU.util.Activity.prototype.remove=function(){OU.removeMessenger(this)};OU.util.Activity.prototype.accessibleView=function(){if(void 0!==this.data.description){var a=document.createElement("div");a.innerHTML='<div id="accessibleView">'+this.data.description+"</div>";document.body.appendChild(a)}};
OU.util.Activity.prototype.resize=function(a){this.getsize_(a);OU.resizeCloseButton(this);this._prefO&&("landscape"===this._prefO&&this.h>this.w||"portrait"===this._prefO&&this.h<this.w?(OU._oWarn?OU._oWarn.resize():OU._oWarn=new OU.util.Layer({container:this,zIndex:OU.ABSOLUTE_TOP}),a=OU._oWarn.context,a.fillStyle="#fff",a.fillRect(0,0,this.w,this.h),new OU.util.DynText({x:0.1*this.w,w:0.8*this.w,h:this.h,txt:["This activity is best","viewed in "+this._prefO+" mode."],colour:"#666",align:"center",
context:a})):OU._oWarn&&(OU._oWarn.remove(),OU._oWarn=null))};OU.util.Activity.prototype.loadCSSFile=function(a){OU.loadCSS(this.dataDir+a)};OU.util.Activity.prototype.getsize_=function(a){a=a||{};if(void 0!==this.controllerActivity){var b=this.controllerActivity;if(b._dims){this.x=a.x||b._dims.x;this.y=a.y||b._dims.y;this.w=a.w||b._dims.w;this.h=a.h||b._dims.h;return}}this.x=a.x||0;this.y=a.y||0;this.w=a.w||window.innerWidth||480;this.h=a.h||window.innerHeight||360};
OU.util.Tabbable=function(a){this.txt=a.tabbableText||a.txt||"button";this.tabIndex=a.tabIndex||100;OU.util.Tabbable.prototype.initTabbable=function(){var b;this._tabbable=!0;this._tabCount=OU._tabCount=(OU._tabCount||0)+1;OU._tabbables[this._tabCount]=this;OU.__tabsDiv||(OU.__tabsDiv=document.createElement("div"),OU.__tabsDiv.setAttribute("id","__tabsDiv"),document.body.appendChild(OU.__tabsDiv));document.getElementById("__tabsDiv")||document.body.appendChild(OU.__tabsDiv);b=document.createElement("input");
b.setAttribute("id","_tabbable_"+this._tabCount);b.setAttribute("value",a.txt);b.setAttribute("tabIndex",this.tabIndex);b.setAttribute("onKeyDown","return OU._tabbables["+this._tabCount+"]._key(event);");b.setAttribute("onFocus","return OU._tabbables["+this._tabCount+"].focus();");b.setAttribute("onBlur","return OU._tabbables["+this._tabCount+"].blur();");OU.__tabsDiv.appendChild(b);this.hiddenObj=b;OU.addRemovable(this);delete b};OU.util.Tabbable.prototype.remove=function(){OU.__tabsDiv&&this.hiddenObj&&
(OU.__tabsDiv.removeChild(this.hiddenObj),this.hiddenObj=null,!OU.__tabsDiv.hasChildNodes()&&OU.__tabsDiv.parentNode&&OU.__tabsDiv.parentNode.removeChild(OU.__tabsDiv),this.hiddenObj=null)};OU.util.Tabbable.prototype.setFocus=function(b){!1===b?this.hiddenObj.blur():this.hiddenObj.focus()};OU.util.Tabbable.prototype.focus=function(){};OU.util.Tabbable.prototype.blur=function(){};OU.util.Tabbable.prototype.hit=function(){return!1};OU.util.Tabbable.prototype.arrowKey=function(){};OU.util.Tabbable.prototype._key=
function(b){var a=null;window.event?a=window.event.keyCode:b&&(a=b.which||b.keyCode);13===a||32===a?this.hit():36<b.keyCode&&41>b.keyCode&&(b._dealtWith=this.arrowKey(b.keyCode))};a.disableTab||this.initTabbable()};OU.loadTheme();OU.loadFonts();OU.preLoad();
OU.util.Ajax=function(a){this.server=a.server;this.onSuccess=a.onSuccess;OU.util.Ajax.prototype.postRequest=function(b,a){this._SendRequest("POST",this.server+b,a)};OU.util.Ajax.prototype.getRequest=function(b,a){this._SendRequest("GET",this.server+b,a)};OU.util.Ajax.prototype._OnUninitialize=function(){};OU.util.Ajax.prototype._OnLoading=function(){};OU.util.Ajax.prototype._OnLoaded=function(){};OU.util.Ajax.prototype._OnInteractive=function(){};OU.util.Ajax.prototype._OnSuccess=function(){var b=
JSON.parse(this.http.responseText);if(this.onSuccess)this.onSuccess(b)};OU.util.Ajax.prototype._OnFailure=function(){};OU.util.Ajax.prototype._stateHandler=function(){console.log(this.http.readyState+" : "+this.http.status);console.log("responseText:"+this.http.responseText);switch(this.http.readyState){case 0:setTimeout("void(0)",100);this._OnUninitialize();break;case 1:setTimeout("void(0)",100);this._OnLoading();break;case 2:setTimeout("void(0)",100);this._OnLoaded();break;case 3:setTimeout("void(0)",
100);this._OnInteractive();break;case 4:200===this.http.status?this._OnSuccess():this._OnFailure()}};OU.util.Ajax.prototype._SendRequest=function(b,a,d,e){var f=this;if(this.http=this._InitRequest()){this.http.onreadystatechange=function(){f._stateHandler()};switch(2){case 2:this.http.open(b,a);break;case 3:this.http.open(b,a,d);break;case 4:this.http.open(b,a,d,e)}this.http.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");this.http.send(null)}};OU.util.Ajax.prototype._InitRequest=
function(){var b;try{b=new XMLHttpRequest}catch(a){try{b=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){return!1}}return b}};
OU.util.Anchor=function(a){var b=this;this.container=a.container;this.parent=a.parent;this.txt=a.txt||"";this.onClick=a.onClick||function(){};this.touch=function(a){0<OU.combineMouseTouch(a).pageX&&b.onClick.call(b.a)};this.a=document.createElement("a");a.id&&this.a.setAttribute("id",a.id);a.classes&&this.a.setAttribute("class",a.classes);this.parent.appendChild(this.a);this.a.innerHTML=a.img?"<img src='"+a.img+"' alt='"+this.txt+"' title='"+this.txt+"'/>":this.txt;a.onClick&&(this._handlersSet=!0,
this.a.addEventListener("mousedown",this.onClick,!1),this.a.addEventListener("touchstart",this.touch,!1));OU.util.Anchor.prototype.focus=function(){this.a.setAttribute("style","background: #c00;color:#fff");return false};OU.util.Anchor.prototype.blur=function(){this.a.setAttribute("style","");return false};OU.util.Anchor.prototype.hit=function(){this.onClick.call(this.a);return false};OU.util.Anchor.prototype.remove=function(){OU.util.Anchor.superClass_.remove.call(this);if(this._handlersSet){this.a.removeEventListener("mousedown",
this.onClick,false);this.a.removeEventListener("touchstart",this.touch,false)}};OU.base(this,a)};OU.inherits(OU.util.Anchor,OU.util.Tabbable);
OU.util.Blur=function(a){var b=a.context,c=Math.abs(a.radius||0),d=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,
347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,
302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],e=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,
23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];if(!(isNaN(c)||1>c)){var f=function(){this.a=this.b=this.g=this.r=0;this.next=null},g=function(b,a,c,g,k,p){var p=p|0,x;try{try{x=b.getImageData(a,c,g,k)}catch(P){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),
x=b.getImageData(a,c,g,k)}catch(z){throw console.log("Cannot access local image"),Error("unable to access local image data: "+z);}}}catch(A){throw console.log("Cannot access image"),Error("unable to access image data: "+A);}var l=x.data,B,G,n,q,o,Q,u,v,w,y,J,K,H,I,C,D,E,F,L;B=p+p+1;var N=g-1,O=k-1,s=p+1,R=s*(s+1)/2,U=new f,t=U;for(n=1;n<B;n++)if(t=t.next=new f,n==s)var M=t;t.next=U;t=n=null;Q=o=0;var S=d[p],T=e[p];for(G=0;G<k;G++){H=I=C=u=v=w=0;y=s*(D=l[o]);J=s*(E=l[o+1]);K=s*(F=l[o+2]);u+=R*D;v+=
R*E;w+=R*F;t=U;for(n=0;n<s;n++)t.r=D,t.g=E,t.b=F,t=t.next;for(n=1;n<s;n++)q=o+((N<n?N:n)<<2),u+=(t.r=D=l[q])*(L=s-n),v+=(t.g=E=l[q+1])*L,w+=(t.b=F=l[q+2])*L,H+=D,I+=E,C+=F,t=t.next;n=U;t=M;for(B=0;B<g;B++)l[o]=u*S>>T,l[o+1]=v*S>>T,l[o+2]=w*S>>T,u-=y,v-=J,w-=K,y-=n.r,J-=n.g,K-=n.b,q=Q+((q=B+p+1)<N?q:N)<<2,H+=n.r=l[q],I+=n.g=l[q+1],C+=n.b=l[q+2],u+=H,v+=I,w+=C,n=n.next,y+=D=t.r,J+=E=t.g,K+=F=t.b,H-=D,I-=E,C-=F,t=t.next,o+=4;Q+=g}for(B=0;B<g;B++){I=C=H=v=w=u=0;o=B<<2;y=s*(D=l[o]);J=s*(E=l[o+1]);K=s*
(F=l[o+2]);u+=R*D;v+=R*E;w+=R*F;t=U;for(n=0;n<s;n++)t.r=D,t.g=E,t.b=F,t=t.next;q=g;for(n=1;n<=p;n++)o=q+B<<2,u+=(t.r=D=l[o])*(L=s-n),v+=(t.g=E=l[o+1])*L,w+=(t.b=F=l[o+2])*L,H+=D,I+=E,C+=F,t=t.next,n<O&&(q+=g);o=B;n=U;t=M;for(G=0;G<k;G++)q=o<<2,l[q]=u*S>>T,l[q+1]=v*S>>T,l[q+2]=w*S>>T,u-=y,v-=J,w-=K,y-=n.r,J-=n.g,K-=n.b,q=B+((q=G+s)<O?q:O)*g<<2,u+=H+=n.r=l[q],v+=I+=n.g=l[q+1],w+=C+=n.b=l[q+2],n=n.next,y+=D=t.r,J+=E=t.g,K+=F=t.b,H-=D,I-=E,C-=F,t=t.next,o+=g}b.putImageData(x,a,c)};a.blurAlphaChannel?
function(b,a,c,g,k,p){if(!(isNaN(p)||1>p)){var p=p|0,x;try{try{x=b.getImageData(a,c,g,k)}catch(P){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),x=b.getImageData(a,c,g,k)}catch(z){throw console.log("Cannot access local image"),Error("unable to access local image data: "+z);}}}catch(A){throw console.log("Cannot access image"),Error("unable to access image data: "+A);}var l=x.data,B,G,n,q,o,Q,u,v,w,y,J,K,H,I,C,D,E,F,L,N,O,s,R;B=p+p+1;var U=g-1,t=k-1,M=p+1,S=M*(M+1)/2,
T=new f,r=T;for(n=1;n<B;n++)if(r=r.next=new f,n===M)var X=r;r.next=T;r=n=null;Q=o=0;var V=d[p],W=e[p];for(G=0;G<k;G++){C=D=E=F=u=v=w=y=0;J=M*(L=l[o]);K=M*(N=l[o+1]);H=M*(O=l[o+2]);I=M*(s=l[o+3]);u+=S*L;v+=S*N;w+=S*O;y+=S*s;r=T;for(n=0;n<M;n++)r.r=L,r.g=N,r.b=O,r.a=s,r=r.next;for(n=1;n<M;n++)q=o+((U<n?U:n)<<2),u+=(r.r=L=l[q])*(R=M-n),v+=(r.g=N=l[q+1])*R,w+=(r.b=O=l[q+2])*R,y+=(r.a=s=l[q+3])*R,C+=L,D+=N,E+=O,F+=s,r=r.next;n=T;r=X;for(B=0;B<g;B++)l[o+3]=s=y*V>>W,0!==s?(s=255/s,l[o]=(u*V>>W)*s,l[o+1]=
(v*V>>W)*s,l[o+2]=(w*V>>W)*s):l[o]=l[o+1]=l[o+2]=0,u-=J,v-=K,w-=H,y-=I,J-=n.r,K-=n.g,H-=n.b,I-=n.a,q=Q+((q=B+p+1)<U?q:U)<<2,C+=n.r=l[q],D+=n.g=l[q+1],E+=n.b=l[q+2],F+=n.a=l[q+3],u+=C,v+=D,w+=E,y+=F,n=n.next,J+=L=r.r,K+=N=r.g,H+=O=r.b,I+=s=r.a,C-=L,D-=N,E-=O,F-=s,r=r.next,o+=4;Q+=g}for(B=0;B<g;B++){D=E=F=C=v=w=y=u=0;o=B<<2;J=M*(L=l[o]);K=M*(N=l[o+1]);H=M*(O=l[o+2]);I=M*(s=l[o+3]);u+=S*L;v+=S*N;w+=S*O;y+=S*s;r=T;for(n=0;n<M;n++)r.r=L,r.g=N,r.b=O,r.a=s,r=r.next;q=g;for(n=1;n<=p;n++)o=q+B<<2,u+=(r.r=
L=l[o])*(R=M-n),v+=(r.g=N=l[o+1])*R,w+=(r.b=O=l[o+2])*R,y+=(r.a=s=l[o+3])*R,C+=L,D+=N,E+=O,F+=s,r=r.next,n<t&&(q+=g);o=B;n=T;r=X;for(G=0;G<k;G++)q=o<<2,l[q+3]=s=y*V>>W,0<s?(s=255/s,l[q]=(u*V>>W)*s,l[q+1]=(v*V>>W)*s,l[q+2]=(w*V>>W)*s):l[q]=l[q+1]=l[q+2]=0,u-=J,v-=K,w-=H,y-=I,J-=n.r,K-=n.g,H-=n.b,I-=n.a,q=B+((q=G+M)<t?q:t)*g<<2,u+=C+=n.r=l[q],v+=D+=n.g=l[q+1],w+=E+=n.b=l[q+2],y+=F+=n.a=l[q+3],n=n.next,J+=L=r.r,K+=N=r.g,H+=O=r.b,I+=s=r.a,C-=L,D-=N,E-=O,F-=s,r=r.next,o+=g}b.putImageData(x,a,c)}}(b,0,
0,b.canvas.width,b.canvas.height,c):g(b,0,0,b.canvas.width,b.canvas.height,c)}};
OU.util.brighten=function(a){var b,c=a.context,a=a.factor||1,d=c.canvas.width,e=c.canvas.height;if(1!==a){try{try{b=c.getImageData(0,0,d,e)}catch(f){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),b=c.getImageData(0,0,d,e)}catch(g){throw console.log("Cannot access local image"),Error("unable to access local image data: "+g);}}}catch(h){throw console.log("Cannot access image"),Error("unable to access image data: "+h);}d=b.data;for(e=0;e<d.length;e+=4)d[e]*=a,d[e+1]*=
a,d[e+2]*=a;c.putImageData(b,0,0)}};OU.UNSELECTED=0;OU.SELECTED=1;OU.CORRECT=2;OU.INCORRECT=3;
OU.util.BaseButton=function(a){a.fontSize=a.fontSize||OU.theme.fontSize*OU.dpr;this.params=a;this.onClickParam=a.onClickParam;this.layer=a.layer;this.container=a.layer.container;this.context=this.layer.context;this.glyph=a.glyph||this.glyph;this.background=a.background;a.background=void 0;this.visiblePadding=a.visiblePadding;this.visibleDims={};this.textParams=this.params;this.renderStyle=a.renderStyle||0;this._state=!1;this.instanceId="_button_"+OU._buttonCount++;void 0===a.layer&&OU.log("Bad use of Button class - no Layer given");
var b=a.group||"defaultGroup";OU._buttonGroups=OU._buttonGroups||[];this._group=OU._buttonGroups[b]=OU._buttonGroups[b]||[];this._group.push(this);this._group.minFont&&this._group.minFont<this.textParams.fontSize&&(this.textParams.fontSize=this._group.minFont);OU.util.BaseButton.prototype.init=function(){this.textParams.context=this.layer.context;this.resize(this.params);this.textParams.colour=this.textParams.colour||OU.theme.buttonTextCol;this.onClick=a.onClick||function(){};if(this.background)this.background.gloss=
a.gloss||true;this.layer.events.clickable.push(this,this.instanceId);OU.addRemovable(this,this.instanceId);this.render()};OU.util.BaseButton.prototype.modify=function(b){if(b.txt)this.textParams.txt=b.txt;if(b.onClick)this.onClick=b.onClick;if(b.onClickParam)this.onClickParam=b.onClickParam;this.render()};OU.util.BaseButton.prototype.renderFlat=function(){var b=this.context;if(b){b.save();if(this.params.disabled)b.globalAlpha=0.5;this.background?b.background(this.background,this.visibleDims):b.clearRect(this.visibleDims.x-
1,this.visibleDims.y-1,this.visibleDims.w+2,this.visibleDims.h+2);if(this.params.txt&&this.params.txt!=="")this._dyntext=new OU.util.DynText(this.textParams);this.glyph&&b.glyph(this.glyph);this.hasFocus&&this.focusOutline();b.restore()}};OU.util.BaseButton.prototype.focusOutline=function(){var b=this.context;if(b){b.save();b.strokeStyle="#c00";b.lineWidth=3;b.roundRect(this.visibleDims.x+2,this.visibleDims.y+2,this.visibleDims.w-4,this.visibleDims.h-4,this.background?this.background.radius:0);b.stroke();
b.restore()}};OU.util.BaseButton.prototype.renderNew=function(){var b=this.context,a,e,f={},g={},h;b.save();a=this.textParams.colour;e=this.textParams.y;h=this.background.col;if(!h||h==="transparent")h=0;else{if(h.length===4){f=(h.substr(1,1),16)|0;g=(h.substr(2,1),16)|0;h=(h.substr(3,1),16)|0}else{f=(h.substr(1,2),16)|0;g=(h.substr(3,2),16)|0;h=(h.substr(5,2),16)|0}h=0.2126*(f/255)+0.7152*(g/255)+0.0722*(h/255)}f={col:"rgba(0,0,0,0.1)",radius:this.background.radius};g={x:this.visibleDims.x-2,y:this.visibleDims.y-
2,w:this.visibleDims.w+4,h:this.visibleDims.h+4};this.textParams.y=this.textParams.y-1;this.textParams.colour="rgba(100,100,100,0.7)";if(this.params.disabled)b.globalAlpha=0.5;b.background(f,g);b.background(this.background,this.visibleDims);if(this.params.txt&&this.params.txt!==""){if(h>0.5){this.textParams.colour="#ffffff";this._dyntext=new OU.util.DynText(this.textParams);this.textParams.colour=a}else{this._dyntext=new OU.util.DynText(this.textParams);this.textParams.colour="#ffffff"}this.textParams.y=
e;new OU.util.DynText(this.textParams)}this.glyph&&b.glyph(this.glyph);this.hasFocus&&this.focusOutline();b.restore()};OU.util.BaseButton.prototype.render=function(b){b&&this.resize(b);this.renderStyle===0?this.renderFlat():this.renderNew();if(this._dyntext&&(!this._group.minFont||this._dyntext.font.size<this._group.minFont)){this._group.minFont=this._dyntext.font.size;for(b=this._group.length;b--;)if(this._group[b].render){this._group[b].textParams.fontSize=this._group.minFont;this._group[b].render()}}};
OU.util.BaseButton.prototype.origrender=function(){var b=this.context,a;b.save();a=this.textParams.y;this.textParams.y=this.textParams.y-1;this.textParams.colour="rgba(100,100,100,0.7)";if(this.params.disabled)b.globalAlpha=0.5;b.background(this.background,this.visibleDims);if(this.params.txt&&this.params.txt!==""){new OU.util.DynText(this.textParams);this.textParams.colour="#ffffff";this.textParams.y=a;new OU.util.DynText(this.textParams)}this.glyph&&b.glyph(this.glyph);b.restore()};OU.util.BaseButton.prototype.move=
function(b){return this.resize(b)};OU.util.BaseButton.prototype.resize=function(b){this.visibleDims.x=this.x=b.x||this.x||0;this.visibleDims.y=this.y=b.y||this.y||0;this.visibleDims.w=this.w=b.w||this.w||100;this.visibleDims.h=this.h=b.h||this.h||40;if(this.visiblePadding){this.visibleDims.w=this.visibleDims.w*(1-2*this.visiblePadding);this.visibleDims.h=this.visibleDims.h*(1-2*this.visiblePadding);this.visibleDims.x=this.visibleDims.x+this.w*this.visiblePadding;this.visibleDims.y=this.visibleDims.y+
this.h*this.visiblePadding}this.textParams.x=this.visibleDims.x;this.textParams.y=this.visibleDims.y;this.textParams.w=this.visibleDims.w;this.textParams.h=this.visibleDims.h;if(this.glyph){switch(this.glyph.align.toLowerCase()){case "right":this.glyph.x=this.textParams.x+this.textParams.w-(this.glyph.w+5);this.textParams.w=this.textParams.w-(this.glyph.w+10);this.textParams.align="right";break;case "center":case "middle":this.glyph.x=this.textParams.x+(this.textParams.w-this.glyph.w)/2;break;default:this.glyph.x=
this.textParams.x+5;this.textParams.x=this.textParams.x+(this.glyph.w+10);this.textParams.w=this.textParams.w-(this.glyph.w+10);this.textParams.align="left"}this.glyph.y=this.textParams.y+(this.textParams.h-this.glyph.h)/2}if(this.params.autoWidth){this.textParams.measureOnly=true;b=new OU.util.DynText(this.textParams);this.textParams.measureOnly=false;this.textParams.autoWidth=false;this.textParams.w=this.w=this.visibleDims.w=b.w+40}};OU.util.BaseButton.prototype.isHit=function(b,a,e){if(e){if(b<
this.x||b>this.x+this.w||a<this.y||a>this.y+this.h)return false;this.hit();return true}return false};OU.util.BaseButton.prototype.enable=function(){this.params.disabled=false;this.render()};OU.util.BaseButton.prototype.disable=function(){this.params.disabled=true;this.render()};OU.util.BaseButton.prototype.hit=function(){if(this.params.disabled!==true){this.defaultAction&&this.defaultAction();this.onClick(this.onClickParam)}return false};OU.util.BaseButton.prototype.enable=function(){this.params.disabled=
false;this.render()};OU.util.BaseButton.prototype.disable=function(){this.params.disabled=true;this.render()};OU.util.BaseButton.prototype.focus=function(){this.hasFocus=true;this.render();return false};OU.util.BaseButton.prototype.blur=function(){this.hasFocus=void 0;this.render();return false};OU.util.BaseButton.prototype.remove=function(){if(this.layer&&this.layer.events&&this.layer.events.clickable){this.layer.events.clickable.removeType(this.instanceId);if(this.onClick){delete this.onClick;this.onClick=
null}if(this.context){delete this.context;this.context=null}if(this.container){delete this.container;this.container=null}if(this.layer){delete this.layer;this.layer=null}}OU.util.BaseButton.superClass_.remove.call(this);OU.removables.removeType(this.instanceId)};OU.base(this,a);this.init()};OU.inherits(OU.util.BaseButton,OU.util.Tabbable);
OU.util.Button=function(a){var b=(28<a.h?24:a.h-4)*OU.dpr;a.visiblePadding=void 0===a.visiblePadding?0.1:a.visiblePadding;a.colour=a.colour||"#222";a.align="center";a.renderStyle=0;a.glyph&&(a.glyph.w=b,a.glyph.h=b);a.background||(a.background={col:"#76787F",radius:3,borderCol:"#999"});OU.base(this,a)};OU.inherits(OU.util.Button,OU.util.BaseButton);
OU.util.ControlButton=function(a){a.visiblePadding=0.1;void 0===a.background&&(a.background={col:OU.theme.buttonBgCol,radius:3,borderCol:OU.theme.buttonBorderCol});OU.base(this,a)};OU.inherits(OU.util.ControlButton,OU.util.BaseButton);OU.util.InfoButton=function(a){a.txt="";a.w=a.w||32*OU.dpr;a.h=a.h||32*OU.dpr;a.padding=0;a.visiblePadding=0;a.glyph={type:"infoIcon",align:"center",w:30*OU.dpr,h:30*OU.dpr};OU.base(this,a)};OU.inherits(OU.util.InfoButton,OU.util.BaseButton);
OU.util.NextButton=function(a){var b=(28<a.h?24:a.h-4)*OU.dpr;a.visiblePadding=void 0;a.background=void 0;a.colour="#000";a.glyph={type:"rightArrow",align:"right",w:b,h:b};OU.base(this,a)};OU.inherits(OU.util.NextButton,OU.util.BaseButton);OU.util.PrevButton=function(a){var b=(28<a.h?24:a.h-4)*OU.dpr;a.visiblePadding=void 0;a.background=void 0;a.colour="#000";a.glyph={type:"leftArrow",align:"left",w:b,h:b};OU.base(this,a)};OU.inherits(OU.util.PrevButton,OU.util.BaseButton);
OU.util.RadioButton=function(a){var b=(28<a.h?24:a.h-4)*OU.dpr;a.visiblePadding=0.1;a.colour="#000";a.glyph=void 0;this.glyph={type:"radioButton",align:"left",w:b,h:b};a.group=a.group||"radioGroup";OU.util.RadioButton.prototype.defaultAction=function(){for(var b=this._group.length;b--;)this._group[b].state&&this._group[b].state(!1);this.state(!0);for(b=this._group.length;b--;)this._group[b].render&&this._group[b].render()};OU.util.RadioButton.prototype.state=function(b){this._state=b;switch(b){default:case OU.UNSELECTED:case !1:this.glyph.type=
"radioButton";break;case OU.SELECTED:case !0:this.glyph.type="radioButtonSelected";break;case OU.CORRECT:this.glyph.type="radioButtonCorrect";break;case OU.INCORRECT:this.glyph.type="radioButtonIncorrect"}};this.state(a.state);OU.base(this,a)};OU.inherits(OU.util.RadioButton,OU.util.BaseButton);
OU.util.CheckBoxButton=function(a){var b=(28<a.h?24:a.h-4)*OU.dpr;a.visiblePadding=0.03;a.background=void 0;a.colour="#000";a.glyph=void 0;this.glyph={type:"checkbox",align:"left",w:b,h:b};OU.util.CheckBoxButton.prototype.defaultAction=function(){this._state=!this._state;this.state(this._state);this.render()};OU.util.CheckBoxButton.prototype.state=function(b){this._state=b;switch(b){default:case OU.UNSELECTED:case !1:this.glyph.type="checkbox";break;case OU.SELECTED:case !0:this.glyph.type="checkboxSelected";
break;case OU.CORRECT:this.glyph.type="tickBox";break;case OU.INCORRECT:this.glyph.type="crossBox"}};this.state(a.state);OU.base(this,a)};OU.inherits(OU.util.CheckBoxButton,OU.util.BaseButton);
OU.util.InvisibleButton=function(a){this.x=a.x||0;this.y=a.y||0;this.w=a.w||200;this.h=a.h||100;this.onClick=a.onClick||function(){};this.onClickParam=a.onClickParam;a.layer&&a.layer.events.clickable.push(this);OU.util.InvisibleButton.prototype.isHit=function(b,a,d){if(d&&!(b<this.x||b>this.x+this.w))if(!(a<this.y||a>this.y+this.h))this.onClick(this.onClickParam)};return this};
OU.util.CanvasTable=function(a){void 0===a.container?console.log("ERROR: CanvasTable requires a container"):void 0===a.layer?console.log("ERROR: CanvasTable requires a layer"):void 0===a.sections?console.log("ERROR: CanvasTable requires sections"):(this.container=a.container,this.layer=a.layer,this.context=a.layer.context,this.x=a.x||0,this.y=a.y||0,this.w=a.w||this.container.w,this.h=a.h||this.container.h,this.sections=a.sections,this.borderColour=a.borderColour||"#000",this.bgColour=a.bgColour||
"#fff",this.titleTextColour=a.titleTextColour||"#fff",this.titleBgColour=a.titleBgColour||"#000",this.hasInfo=a.hasInfo||!1,this.totalItems=0,OU.util.CanvasTable.prototype.init=function(){var b;for(b=this.sections.length;b--;)this.sections[b]._items=[];this.resize()},OU.util.CanvasTable.prototype.render=function(){var b,a,d,e,f=this.context,g=this.x,h=1E3;f.strokeStyle=this.borderColour;f.fillStyle=this.bgColour;f.lineWidth=6;f.rect(g,this.y,this.w,this.h);f.stroke();f.fill();for(a=0;a<this.sections.length;a++){f.lineWidth=
6;b=this.sections[a];b.sectionIndex=a;f.rect(g,this.y,this.columnWidth*b.columns,this.h-this.rowHeight-this.titleHeight);f.stroke();f.save();f.lineWidth=1;for(e=b.columns;e--;){f.beginPath();f.moveTo(g+e*this.columnWidth,this.y);f.lineTo(g+e*this.columnWidth,this.y+this.totalRows*this.rowHeight);f.stroke();for(d=b.rows+1;d--;)f.beginPath(),f.moveTo(g,this.y+d*this.rowHeight),f.lineTo(g+b.columns*this.columnWidth,this.y+d*this.rowHeight),f.stroke()}f.save();f.fillStyle=this.titleBgColour;f.fillRect(g,
this.y+this.h-this.titleHeight,this.columnWidth*b.columns,this.titleHeight);f.fillStyle=this.titleTextColour;d=new OU.util.DynText({context:f,txt:b.title,fontSize:0.8*this.titleHeight,x:g,y:this.y+this.h-this.titleHeight,w:this.columnWidth*b.columns,h:this.titleHeight,measureOnly:!0});f.restore();d.font.size<h&&(h=d.font.size);g+=b.columns*this.columnWidth;f.restore()}this.titleFontSize=h;g=this.x;f.save();f.fillStyle=this.titleTextColour;for(a=0;a<this.sections.length;a++)b=this.sections[a],b._x=
g,new OU.util.DynText({context:f,txt:b.title,fontSize:h,x:g,y:this.y+this.h-this.titleHeight,w:this.columnWidth*b.columns,h:this.titleHeight}),g+=b.columns*this.columnWidth;f.restore()},OU.util.CanvasTable.prototype.resize=function(b){var a,d,e=!1;void 0===b&&(b={});this.x=b.x||this.x;this.y=b.y||this.y;this.w=b.w||this.w;this.h=b.h||this.h;this.totalRows=this.totalColumns=0;for(b=this.sections.length;b--;){d=this.sections[b];this.totalColumns+=d.columns;d.rows>this.totalRows&&(this.totalRows=d.rows);
d.title&&""!==d.title&&(e=!0);for(a=d._items.length;a--;)this.setTargetPosition(d._items[a])}this.columnWidth=this.w/this.totalColumns;this.titleHeight=e?OU.controlHeight:0;this.rowHeight=this.hasInfo?(this.h-this.titleHeight)/(this.totalRows+1):(this.h-this.titleHeight)/this.totalRows;this.render()},OU.util.CanvasTable.prototype.addItemIfOver=function(b){var a,d=b.x+b.w/2;a=b.y+b.h/2;var e;if(d<this.x||d>this.x+this.w||a<this.y||a>this.y+this.h)return!1;for(a=0;a<this.sections.length;a++)if(e=this.sections[a],
d>e._x&&d<e._x+e.columns*this.columnWidth)return this.addItemToSection(e,b),!0;return!1},OU.util.CanvasTable.prototype.info=function(b){new OU.util.DynText({context:this.context,txt:b,colour:this.container.data.validationColour,fontSize:this.titleFontSize,background:{clear:!0},x:this.x,y:this.y+this.h-this.titleHeight-this.rowHeight,w:this.w,h:this.rowHeight})},OU.util.CanvasTable.prototype.addItem=function(b,a){this.addItemToSection(this.sections[a],b)},OU.util.CanvasTable.prototype.switchItem=function(b,
a){this.removeItem(b);this.addItem(b,a)},OU.util.CanvasTable.prototype.setTargetPosition=function(b){var a=b.tableInfo.section,d=b.tableInfo.itemIndex,e=d%a.columns,d=(d-e)/a.columns;b.tableInfo.targetX=a._x+this.columnWidth*e+(this.columnWidth-b.w)/2;b.tableInfo.targetY=this.y+this.rowHeight*d+(this.rowHeight-b.h)/2},OU.util.CanvasTable.prototype.addItemToSection=function(b,a){var d=b._items.length;b._items[d]=a;a.tableInfo={section:b,itemIndex:d};this.totalItems++;this.setTargetPosition(a)},OU.util.CanvasTable.prototype.removeItem=
function(b){var a=b.tableInfo.section;a._items.splice(b.tableInfo.itemIndex,1);b.tableInfo=null;this.totalItems--;for(b=0;b<a._items.length;b++)a._items[b].tableInfo.itemIndex=b,this.setTargetPosition(a._items[b]);return!0},OU.util.CanvasTable.prototype.moveItem=function(b){var a,d;a=b.tableInfo.targetX-b.x;d=b.tableInfo.targetY-b.y;if(0===a&&0===d)return!1;a=2>Math.abs(a)?b.tableInfo.targetX:b.x+a/6;d=2>Math.abs(d)?b.tableInfo.targetY:b.y+d/6;b.move(a,d);return!0},this.init())};
OU.util.ChemString=function(a){this.params=a;this.elements=[[1,"H"],[2,"He"],[3,"Li"],[4,"Be"],[5,"B"],[6,"C"],[7,"N"],[8,"O"],[9,"F"],[10,"Ne"],[11,"Na"],[12,"Mg"],[13,"Al"],[14,"Si"],[15,"P"],[16,"S"],[17,"Cl"],[18,"Ar"],[19,"K"],[20,"Ca"],[21,"Sc"],[22,"Ti"],[23,"V"],[24,"Cr"],[25,"Mn"],[26,"Fe"],[27,"Co"],[28,"Ni"],[29,"Cu"],[30,"Zn"],[31,"Ga"],[32,"Ge"],[33,"As"],[34,"Se"],[35,"Br"],[36,"Kr"],[37,"Rb"],[38,"Sr"],[39,"Y"],[40,"Zr"],[41,"Nb"],[42,"Mo"],[43,"Tc"],[44,"Ru"],[45,"Rh"],[46,"Pd"],[47,
"Ag"],[48,"Cd"],[49,"In"],[50,"Sn"],[51,"Sb"],[52,"Te"],[53,"I"],[54,"Xe"],[55,"Cs"],[56,"Ba"],[57,"La"],[58,"Ce"],[59,"Pr"],[60,"Nd"],[61,"Pm"],[62,"Sm"],[63,"Eu"],[64,"Gd"],[65,"Tb"],[66,"Dy"],[67,"Ho"],[68,"Er"],[69,"Tm"],[70,"Yb"],[71,"Lu"],[72,"Hf"],[73,"Ta"],[74,"W"],[75,"Re"],[76,"Os"],[77,"Ir"],[78,"Pt"],[79,"Au"],[80,"Hg"],[81,"Tl"],[82,"Pb"],[83,"Bi"],[84,"Po"],[85,"At"],[86,"Rn"],[87,"Fr"],[88,"Ra"],[89,"Ac"],[90,"Th"],[91,"Pa"],[92,"U"],[93,"Np"],[94,"Pu"],[95,"Am"],[96,"Cm"],[97,"Bk"],
[98,"Cf"],[99,"Es"],[100,"Fm"],[101,"Md"],[102,"No"],[103,"Lr"],[104,"Rf"],[105,"Db"],[106,"Sg"],[107,"Bh"],[108,"Hs"],[109,"Mt"],[110,"Ds"],[111,"Rg"],[112,"Cn"],[113,"Uut"],[114,"Uuq"],[115,"Uup"],[116,"Uuh"],[117,"Uus"],[118,"Uuo"]];this.arrows=["\u2192","\u21d2","\u21e2","\u21e8"];this.currentFormula=this.params.formula;this.clusters=[];this.cluster=[];this.htmlString="";this.rebuiltString=null;this.strings=[];OU.util.ChemString.prototype.processEquation=function(){var b,a=[];b=this.currentFormula.breaker("=");
for(var d=0;d<b.length;d++)a.push(b[d].breaker(" + "));for(d=this.clusters.length=0;d<a.length;d++)this.clusters.push(this.parseClusters(a[d]))};OU.util.ChemString.prototype.parseClusters=function(b){var a,d,e=[];for(a=0;a<b.length;a++)d=b[a],d=this.clusterBreaker(d),d.m=1,e.push(d);return e};OU.util.ChemString.prototype.validateElement=function(b){var a,d=!1;for(a=0;a<this.elements.length;a++)if(this.elements[a][1]==b){d={el:this.elements[a][2],l:a};break}return d};OU.util.ChemString.prototype.clusterBreaker=
function(b){var a=[],d,e,f,g,h,i,j;e=0;i=h=f="";for(j=!1;e<b.length;){if(65<=b.charCodeAt(e)&&90>=b.charCodeAt(e)){f+=b[e];97<=b.charCodeAt(e+1)&&122>=b.charCodeAt(e+1)&&(f+=b[e+1]);1<f.length&&e++;if(48<=b.charCodeAt(e+1)&&57>=b.charCodeAt(e+1)){for(g=1;48<=b.charCodeAt(e+g)&&57>=b.charCodeAt(e+g);)h+=b[e+g],g++;e+=g-1}if(123==b.charCodeAt(e+1)){e++;g=1;for(d="";125!=b.charCodeAt(e+g);)d+=b[e+g],g++;0<d.length&&(i=d);e+=g}g=this.validateElement(f);i=0<i.length?i:0;h=0<h.length?h:1;d={el:f,sub:h,
sup:i,plus:!1,bracket:j,n:g}}else if(40==b.charCodeAt(e)){g=0;for(e++;41!=b.charCodeAt(e+g);)f+=b[e+g],g++;d=this.clusterBreaker(f);e+=g+1;if(48<=b.charCodeAt(e)&&57>=b.charCodeAt(e)){for(g=0;48<=b.charCodeAt(e+g)&&57>=b.charCodeAt(e+g);)h+=b[e+g],g++;d.sub=h;e+=g}}else if(123==b.charCodeAt(e)){e++;g=0;for(d="";125!=b.charCodeAt(e+g);)d+=b[e+g],g++;e+=g;"-"==d&&(d="e");d={el:d,sub:"",sup:"",plus:!1,bracket:j,n:"electron"}}a.push(d);e++;i=h=f="";j=!1}return a};OU.util.ChemString.prototype.goesTo=function(){var b=
"",a=[],d=[];this.htmlString=this.rebuilder(this.clusters);for(var e=0;e<this.clusters.length;e++)d.push(this.rebuilder(this.clusters[e])),a=this.runnerBuilder(this.clusters[e],a);b+=d[0];b+=" "+this.arrows[1]+" ";b+=d[1];this.currentChem=a;this.htmlString=b;this.strings=d;return{currentChem:a,htmlString:b,clusters:this.clusters,strings:d}};OU.util.ChemString.prototype.runnerBuilder=function(b,a){for(var d=0;d<b.length;d++)0<a.length&&a.push(null),a.push(b[d]);return a};OU.util.ChemString.prototype.rebuilder=
function(b,a){var d,e="",f=a||0;if(5<f)throw"loopy";for(d=0;d<b.length;d++)if("array"==typeOf(b[d])&&(0==f&&0<e.length&&(e+=" + "),void 0!=b[d].m&&1<b[d].m&&(e+=b[d].m),e+=this.rebuilder(b[d],f+1),void 0!=b[d].sub&&1<b[d].sub&&(e+="<sub>"+b[d].sub+"</sub>")),"object"==typeOf(b[d]))e+=b[d].el,""!=b[d].sub&&1<b[d].sub&&(e+="<sub>"+b[d].sub+"</sub>"),""!=b[d].sup&&(e+="<sup>"+b[d].sup+"</sup>");1<a&&(e="("+e+")");return e}};
OU.util.Controller=function(a,b,c){OU.util.Controller.prototype.canvasView=function(){this.controllerId=OU.controllers.length;OU.controllers[this.controllerId]=this;OU.initPage=function(){};this.padding=this.tabHeight=this.footerHeight=this.headerHeight=this.menuHeight=0;this.menus=[];this.activities=[];this.activityDefs={};this.sections=this.data.sections||[{activities:[]}];this.dontsave=this.data.dontsave||!1;this.chgSectionMaxCountdown=1500;this.bgLayer=new OU.util.Layer({dontRegister:!this.controller,
container:this,id:"controllerBg"});this.bgLayer.context.gradRect();this.audioDiv=null;this.initSections();this.audioStep=1;this.watchAudio();OU.addRemovable(this,this.bgLayer.zOffset)};OU.util.Controller.prototype.remove=function(){void 0!==this.controller&&(this.clearSection(),this.bgLayer&&this.bgLayer.canvas&&this.bgLayer.remove(),this.audioDiv&&this.audioDiv.remove());OU.controllers[this.controllerId]=null};OU.util.Controller.prototype.initSections=function(){var b,a;b=this.numSections=this.sections.length;
var c=this;for(this.sectionNum=0;b--;)a=this.sections[b],a.sectionId=b,this.initSection(a,b);this.dontsave||(this.sectionNum=parseInt(OU.LocalStorage.load("OU.control.sectionID."+this.instance+"."+this.data.SaveID)||0));this.subtitleson_="true"===OU.LocalStorage.load("OU.control.subtitlesOn");void 0===this.sections[this.sectionNum]&&(this.sectionNum=0);this.section=this.sections[this.sectionNum];OU.onLoad(function(){c.loadSection()})};OU.util.Controller.prototype.initSection=function(b,a){var c,d;
void 0===a&&(a="x");void 0===b.options&&(b.options={});b.activityObjects=[];for(c=b.activities.length;c--;)d=b.activities[c],d._instName="_act"+a+"_"+c,d._dataLoaded=!1,OU.require(d.type),this.activities.push(d);b.options.chgSectionMaxCountdown&&(this.chgSectionMaxCountdown=b.options.chgSectionMaxCountdown)};OU.util.Controller.prototype.resizeSection=function(b){var a,c,d=this.h-this.menuHeight-this.headerHeight-this.footerHeight-this.tabHeight-2*this.padding,i=this.y+this.menuHeight+this.headerHeight+
this.tabHeight+this.padding;if(0<b.activities.length)for(a=b.activities.length;a--;)c=b.activities[a],c._dims=void 0!==c&&void 0!==c.dims?this.w>this.h||!0===b.options.maintainLayout?c.dims.landscape?{x:this.x+this.w*(c.dims.landscape.x||0)+this.padding,y:i+d*(c.dims.landscape.y||0),w:this.w*(c.dims.landscape.w||1)-2*this.padding,h:d*(c.dims.landscape.h||1)}:{x:this.x+this.w*(c.dims.x||0)+this.padding,y:i+d*(c.dims.y||0),w:this.w*(c.dims.w||1)-2*this.padding,h:d*(c.dims.h||1)}:c.dims.portrait?{x:this.x+
this.w*(c.dims.portrait.x||0)+this.padding,y:i+d*(c.dims.portrait.y||0),w:this.w*(c.dims.portrait.w||1)-2*this.padding,h:d*(c.dims.portrait.h||1)}:{x:this.x+this.w*(c.dims.y||0)+this.padding,y:i+d*(c.dims.x||0),w:this.w*(c.dims.h||1)-2*this.padding,h:d*(c.dims.w||1)}:{x:this.x+this.padding,y:i,w:this.w-2*this.padding,h:d}};OU.util.Controller.prototype.resizeSections=function(){var b,a;this.headerDiv&&this.headerDiv.resize({w:this.w,h:this.headerHeight});this.resizeSection(this.section);if(void 0!==
this.sections&&0<this.sections.length)for(b=this.sections.length;b--;)a=this.sections[b],a!==this.section&&0<a.activityObjects.length&&this.resizeSection(a)};OU.util.Controller.prototype.resize=function(){OU.util.Controller.superClass_.resize.call(this);var b=OU.controlHeight,a,c=this.section;this.bgLayer.resize();this.bgLayer.context.gradRect();this.headerDiv&&this.headerDiv.resize({w:this.w,h:"auto"});this.audioDiv&&this.audioDiv.resize({x:this.x+40,y:this.y+this.h-b,w:this.w/2,h:b});this.subtitleDiv&&
this.subtitleDiv.resize({x:OU.baseController.x+20,y:OU.baseController.y+0.8*OU.baseController.h,w:OU.baseController.w-40,h:"auto"});this.resizeSections();for(a=c.activityObjects.length;a--;)null!==c.activityObjects[a]&&(b=c.activityObjects[a],b._resizeable?b.resize():b._resizeNeeded=!0);for(a=c.activities.length;a--;)b=c.activities[a],void 0!==b.frame&&b.frame.resize({x:b._dims.x-2*OU.dpr,y:b._dims.y-42*OU.dpr,w:b._dims.w,h:b._dims.h+40*OU.dpr})};OU.util.Controller.prototype.render=function(){};OU.util.Controller.prototype.recallOverride=
function(b){b=OU._overrideArray[b];void 0!==b&&this.overrideSection(b);return!1};OU.util.Controller.prototype.recallPopup=function(b){b=OU._overrideArray[b];void 0!==b&&this.addActivity(b);return!1};OU.util.Controller.prototype.overrideSection=function(b){void 0!==b&&(this.clearSection(),this.section=b,this.initSection(this.section),this.loadSection())};OU.util.Controller.prototype.loadSection=function(){var b,a,c=this.section,d=this;OU.LocalStorage.save("OU.control.sectionID."+this.instance+"."+
this.data.SaveID,this.sectionNum);for(a=c.activities.length;a--;)if(b=c.activities[a],b._zOffset=this.zOffset+100*(a+1),!b._dataLoaded){this.loadData(b);return}OU.requiredFiles>OU.fileCount?setTimeout(function(){d.loadSection()},40):(this.render(),this.startSection())};OU.util.Controller.prototype.startSection=function(){var b,a,c,d=this.section;this.header(d.header);for(b=d.activities.length;b--;)a=d.activities[b],this.activityDefs[a._instName]=a,c=eval(a.type),d.activityObjects.push(c=new c(a._data,
a._instName,this)),a.objRef=c,c.controllerActivity=a,c._zOffset=a._zOffset,void 0!==a.frame&&this.activityFrame(a);this.resize();this.audioStep=1;void 0!==d.audio?this.insertAudio(d.audio[0]):this.removeAudio()};OU.util.Controller.prototype.loadData=function(b){var a=this;b._dataLoaded=!1;if(b.inline)b._data=b.inline,b._dataLoaded=!0,a.loadSection();else{var c=document.createElement("script");c.src=b.data+"data.js";c.type="text/javascript";document.all?c.onreadystatechange=function(){if("complete"===
c.readyState||"loaded"===c.readyState)b._data=data,b._dataLoaded=!0,a.loadSection()}:c.onload=function(){b._data=data;b._dataLoaded=!0;a.loadSection()};OU.head.appendChild(c)}};OU.util.Controller.prototype.addActivity=function(b,a){var c,d=this.section,i=d.activities.length,j=d.sectionId,m=this,k=this.h-this.menuHeight-this.headerHeight-this.footerHeight-this.tabHeight-2*this.padding,p=this.y+this.menuHeight+this.headerHeight+this.tabHeight+this.padding;c=d.activities[i]=b;c._instName="_act"+j+"_"+
i;c._dataLoaded=!1;c._zOffset=this.zOffset+100*(i+1);OU.require(c.type);this.activityDefs[c._instName]=c;c.dims?c._dims=this.w>this.h||!0===d.options.maintainLayout?{x:this.x+this.w*(c.dims.x||0),y:p+k*(c.dims.y||0),w:this.w*(c.dims.w||1),h:k*(c.dims.h||1)}:{x:this.x+this.w*(c.dims.y||0),y:p+k*(c.dims.x||0),w:this.w*(c.dims.h||1),h:k*(c.dims.w||1)}:void 0!==d.options.fullScreen&&!d.options.fullScreen&&(c._dims={x:this.x,y:p,w:this.w,h:k});(void 0===a||!1===a)&&this.activityFrame(c);OU.onLoad(function(){var b=
document.createElement("script");b.src=c.data+"data.js";b.type="text/javascript";document.all?b.onreadystatechange=function(){var a;if(b.readyState==="complete"||b.readyState==="loaded"){c._data=data;c._dataLoaded=true;a=eval(c.type);d.activityObjects.push(a=new a(c._data,c._instName,m));a._zOffset=m.zOffset+c._zOffset;a.controllerActivity=c;c.objRef=a}}:b.onload=function(){var b;c._data=data;c._dataLoaded=true;b=eval(c.type);d.activityObjects.push(b=new b(c._data,c._instName,m));b._zOffset=m.zOffset+
c._zOffset;b.controllerActivity=c;c.objRef=b};OU.head.appendChild(b)});return c};OU.util.Controller.prototype.removeActivity=function(b){OU.removeActivity(b._zOffset,this.controllerId)};OU.util.Controller.prototype.activityFrame=function(b){b.frame=new OU.util.Div({x:b._dims.x-2*OU.dpr,y:b._dims.y-42*OU.dpr,w:b._dims.w,h:b._dims.h+40*OU.dpr,style:"border: 2px solid #444; background: #fff",container:{zOffset:b._zOffset,controller:this}});b.frame.div.innerHTML='<a onclick="OU.removeActivity('+b._zOffset+
","+this.controllerId+')" class="popupClose"></a>'};OU.util.Controller.prototype.processAPI=function(b){var a;if(b)for(a=b.length;a--;)this.API(b[a])};OU.util.Controller.prototype.API=function(b){var a,c;switch(b.type){case "activityAPI":for(a=OU._messengerRegister.length;a--;)if(c=OU._messengerRegister[a])if(b.targetInstance&&c.instance===b.targetInstance&&(b.details.activityId=a,OU._getSetMessengerParamInternal(b.details)),b.targetType&&c.controllerActivity&&c.controllerActivity.type===b.targetType)b.details.activityId=
a,OU._getSetMessengerParamInternal(b.details);break;case "header":this.header(b.details);break;case "addActivity":this.addActivity(b.details,!1);break;case "overrideSection":this.overrideSection(b.details)}};OU.util.Controller.prototype.header=function(b){var a="";this.baseController?(b?(this.headerDiv||(this.headerDiv=new OU.util.Div({container:this,y:this.y,h:"auto",htmlClass:"OUheader",showScroll:!1})),b.h1&&""!==b.h1&&(a=a+"<h1>"+b.h1+"</h1>"),b.h2&&""!==b.h2&&(a=a+"<h2>"+b.h2+"</h2>"),b.h3&&
""!==b.h3&&(a=a+"<h3>"+b.h3+"</h3>"),this.headerDiv.div.innerHTML=a,this.headerDiv.resize({h:"auto"}),this.headerHeight=this.headerDiv.div.clientHeight):(this.headerDiv&&this.headerDiv.remove(),this.headerDiv=null,this.headerHeight=0),this.resize()):OU.baseController.header(b)};OU.util.Controller.prototype.insertAudio=function(b){var a,c=OU.controlHeight,d=this,i;this.removeAudio();if(!(void 0===b||void 0===b.sources)){null===this.audioDiv&&(this.audioDiv=new OU.util.Div({id:"audioDiv",x:this.x+40,
y:this.y+this.h-c,w:this.w/2,h:c,zIndex:OU.CONTROLLER_LEVEL+1,container:this,style:"overflow:hidden; vertical-align:bottom"}));i=document.createElement("audio");i.setAttribute("id","_caud_"+this.instance);i.setAttribute("style","float:left;");i.controls="controls";for(a=b.sources.length;a--;){var j=document.createElement("source");j.type=b.sources[a].type;j.src=b.sources[a].src;i.appendChild(j)}i.load();this.audioDiv.div.appendChild(i);if(this.audio=i)a=(c-this.audio.offsetHeight)/2,a=0>a?0:a,b.hasSubTitles&&
(this.audioAnchors||(this.audioAnchors=[]),this.audioAnchors.push(new OU.util.Anchor({container:this,parent:this.audioDiv.div,classes:this.subtitleson_?"subtitleButton subtitlesOn":"subtitleButton",id:"subtitleButton_",tabIndex:2E4,txt:"Subs",onClick:function(){d.toggleSubtitles()}}))),b.hasTranscript&&(this.audioAnchors||(this.audioAnchors=[]),this.audioAnchors.push(new OU.util.Anchor({container:this,parent:this.audioDiv.div,classes:"subtitleButton",id:"transcriptButton_",tabIndex:20001,txt:"Transcript",
onClick:function(){d.toggleTranscript()}}))),this.audioDiv.resize({y:this.y+this.h-c+a,w:this.audio.offsetWidth+(b.hasSubTitles?60:0)+(b.hasTranscript?120:0)}),b.cues&&(b.cues.sort(function(b,a){return a.start-b.start}),this.audioListener=this.audio.addEventListener("timeupdate",this.audioListener=function(){d.audioTimeUpdate()},!1)),setTimeout(function(){d.audio.play()},1500)}};OU.util.Controller.prototype.audioTimeUpdate=function(){this.audioTime=this.audio.currentTime};OU.util.Controller.prototype.toggleSubtitles=
function(b){var a=document.getElementById("subtitleButton_");this.subtitleson_=void 0===b?!this.subtitleson_:b;OU.LocalStorage.save("OU.control.subtitlesOn",this.subtitleson_);a&&(this.subtitleson_?a.setAttribute("class","subtitleButton subtitlesOn"):a.setAttribute("class","subtitleButton"))};OU.util.Controller.prototype.toggleTranscript=function(){var b,a,c=this.section.audio[(this.audioStep||1)-1],d="",i=this;if(this.transcriptDiv&&this.transcriptDiv.html.div)this.transcriptDiv.remove(),this.transcriptDiv=
null;else if(c&&c.cues){for(a=c.cues.length;a--;)b=c.cues[a],b.subtitle&&(d=d+"<p>"+b.subtitle+"</p>");""!==d&&(this.transcriptDiv=new OU.util.PopUpInfo({container:this,txt:"<h1>Transcript</h1>"+d,onClose:function(){i.transcriptDiv=null}}))}};OU.util.Controller.prototype.watchAudio=function(){var b,a,c=this.section,d,i=null,j=this.audioTime,m=this;if(void 0!==c&&void 0!==c.audio&&null!==c.audio&&1<=this.audioStep&&void 0!==c.audio[this.audioStep-1]&&(a=c.audio[this.audioStep-1].cues,-1!==this.audioTime&&
void 0!==a)){for(b=a.length;b--;){d=a[b];if(d.start<j&&(i=null,void 0===d.end||d.end>j))i=d;d.start>j&&(b=0)}if(i){if(i.activity&&(b=c.activities[i.activity-1]))(b=b.objRef)&&b.step&&b.step(i.step);c.audio.hasSubTitles&&i&&(this.subtitleson_&&i.subtitle?(this.subtitleDiv||(this.subtitleDiv=new OU.util.Div({container:this,x:OU.baseController.x+20,y:OU.baseController.y+0.8*OU.baseController.h,w:OU.baseController.w-40,h:"auto",zIndex:OU.ABSOLUTE_TOP,htmlClass:"OUSubtitles",showScroll:!1})),this.subtitleDiv.div.innerHTML=
i.subtitle):this.subtitleDiv&&(this.subtitleDiv.remove(),this.subtitleDiv=void 0))}}setTimeout(function(){m.watchAudio()},40)};OU.util.Controller.prototype.removeAudio=function(){this.audio&&this.audio.pause();void 0!==this.audioListener&&this.audio.removeEventListener("timeupdate",this.audioListener,!1);this.audioTime=-1;this.audioDiv&&this.audioDiv.remove();this.audioListener=void 0;this.audioDiv&&(this.audioDiv.div.innerHTML="");this.audioDiv=null;this.subtitleDiv&&(this.subtitleDiv.remove(),this.subtitleDiv=
void 0);if(this.audioAnchors){for(var b=this.audioAnchors.length;b--;)this.audioAnchors[b].remove();this.audioAnchors.length=0}};OU.util.Controller.prototype.stepAudio=function(b){void 0===b&&(b=this.audioStep+1);this.audio&&void 0!==this.audio&&1<=b&&this.insertAudio(this.section.audio[b-1]);this.audioStep=b};OU.util.Controller.prototype.step=function(b){var a;b>this.sections.length&&(b=1);if(0<b&&b<=this.sections.length&&(this.clearSection(),void 0!==this.section)){for(a=this.section.activityObjects.length;a--;)this.section.activityObjects[a]=
null;this.section.activityObjects.length=0;this.sectionNum=b-1;this.section=this.sections[this.sectionNum];this.loadSection()}};OU.util.Controller.prototype.clearSection=function(){var b,a=this.section;OU.cleanSection(this);OU._overrideArray&&(OU._overrideArray.length=0);if(a){for(b=a.activityObjects.length;b--;)null!==a.activityObjects[b]&&(OU.obj[a.activityObjects[b].instance]=null,this.activityDefs[a.activityObjects[b].instance]=null,a.activityObjects[b].controller=null,a.activityObjects[b].controllerActivity=
null,a.activityObjects[b].data=null,delete a.activityObjects[b],a.activityObjects[b]=null);this.section.activityObjects.length=0;for(b=a.activities.length;b--;)delete a.activities[b].objRef,a.activities[b].objRef=null}};OU.util.Controller.prototype.chgSection=function(b){var a=this;if(!(0>b||b>this.sections.length-1)){if(void 0!==b){this.sectionNum=b;this.render();if(80<this.chgSectionCountdown_){this.chgSectionCountdown_=this.chgSectionMaxCountdown;return}this.chgSectionCountdown_=this.chgSectionMaxCountdown}else this.chgSectionCountdown_-=
40;40>this.chgSectionCountdown_?(this.clearSection(),this.section=this.sections[this.sectionNum],this.loadSection()):setTimeout(function(){a.chgSection()},40)}};OU.util.Controller.prototype.nextSection=function(){this.controlLayer.events.flush();this.chgSection(this.sectionNum+1)};OU.util.Controller.prototype.prevSection=function(){this.controlLayer.events.flush();this.chgSection(this.sectionNum-1)};if(!OU.baseController){OU.baseController=this;this.baseController=!0;if(this.constructor&&this.constructor.toString)var d=
/(OU\..*)\.prototype/.exec(this.constructor.toString())[1];this.controllerActivity={data:"data/",type:d||"Unknown Type"}}OU.base(this,a,b,c)};OU.inherits(OU.util.Controller,OU.util.Activity);
OU.util.Dial=function(a){this.params=a;this.context=a.layer.context;this.frames=2;this.x=a.x||0;this.y=a.y||0;this.w=a.w||100;this.h=a.h||20;this.callback=a.callback||function(){};this.callbackParam=a.callbackParam||void 0;this.position=a.position||0;this.target=a.position||0;this.disabled=this.halted=!1;this.container=a.container||{};OU.addRemovable(this,this.container.zOffset||0);a.layer.events.clickable.push(this);OU.util.Dial.prototype.hit=function(){return!1};OU.util.Dial.prototype.focus=function(){this.hasFocus=
!0;this.render();return!1};OU.util.Dial.prototype.blur=function(){this.hasFocus=void 0;this.render();return!1};OU.util.Dial.prototype.remove=function(){OU.util.Dial.superClass_.remove.call(this);OU.removables.removeType(this.instanceId);this.halted=!0};OU.util.Dial.prototype.resize=function(b){this.x=b.x||this.x;this.y=b.y||this.y;this.w=b.w||this.w;this.h=b.h||this.h;this.render()};OU.util.Dial.prototype.render=function(b){this.position=void 0===b?this.position:b;var b=this.context,a=this.x+this.w/
2,d=this.y+this.h/2,e=this.w>this.h?this.h/3:this.w/3;b.save();b.translate(a,d);b.strokeStyle="#999";b.lineWidth=0.1*e;b.lineCap="round";b.beginPath();e*=4;b.arc(0,0,0.3*e,-Math.PI,0.7*-Math.PI,!1);b.stroke();b.beginPath();b.arc(0,0,0.3*e,0.3*-Math.PI,0,!1);b.moveTo(0.35*-e,0.075*-e);b.lineTo(0.3*-e,0);b.lineTo(0.225*-e,0.05*-e);b.moveTo(0.35*e,0.075*-e);b.lineTo(0.3*e,0);b.lineTo(0.225*e,0.05*-e);b.stroke();e/=4;b.fillStyle=this.hasFocus?"#c00":"#666";b.rotate(this.position);b.beginPath();b.arc(0,
0,0.8*e,0,2*Math.PI,!1);b.rect(-e/5,1.15*-e,1+e/2.5,e);b.fill();b.closePath();b.scale(0.8,0.8);b.fillStyle="#ccc";b.beginPath();b.arc(0,0,0.8*e,0,2*Math.PI,!1);b.rect(-e/14,1.2*-e,1+e/7,e);b.fill();b.restore();b.save();b.lineWidth=0.075*e;b.lineCap="round";b.strokeStyle="#999";b.translate(a,d);b.beginPath();b.arc(0,0,0.3*e,-Math.PI,0,!1);b.moveTo(0.4*-e,0.15*-e);b.lineTo(0.3*-e,0);b.lineTo(0.15*-e,0.1*-e);b.moveTo(0.4*e,0.15*-e);b.lineTo(0.3*e,0);b.lineTo(0.15*e,0.1*-e);b.stroke();b.restore()};OU.util.Dial.prototype.animate=
function(){var b=this;!this.halted&&0.01<Math.abs(this.position-this.target)?(this.position+=(this.target-this.position)/this.frames,this.callback(this.position,this.callbackParam),setTimeout(function(){b.animate()},40)):(this.position!==this.target&&(this.position=this.target,this.callback(this.position,this.callbackParam)),this.halted=!1)};OU.util.Dial.prototype.isHit=function(b,a,d){if(!1===this.disabled&&d&&a>this.y&&a<this.y+this.h&&b>this.x&&b<this.x+this.w){var d=this.x+this.w/2,e=this.y+this.h/
2,f=this.w>this.h?this.h/3:this.w/3,a=Math.sqrt(Math.pow(b-d,2)+Math.pow(a-e,2));this.target=b>d?a>0.64*f?this.position+0.6:this.position+0.025:a>0.64*f?this.position-0.6:this.position-0.025;this.halted=!1;this.animate()}};OU.util.Dial.prototype.arrowKey=function(b){if(this.disabled)return!1;38===b&&(this.target=this.position+0.025);37===b&&(this.target=this.position-0.6);39===b&&(this.target=this.position+0.6);40===b&&(this.target=this.position-0.025);this.halted=!1;this.animate();return!0};OU.util.Dial.prototype.setTarget=
function(b){this.target=b;this.halted=!1;this.animate()};OU.base(this,a)};OU.inherits(OU.util.Dial,OU.util.Tabbable);
OU.util.Div=function(a){void 0===a&&(a={});this.div=null;this.container=a.container||{};this.zIndexStart=a.zIndex||OU.DATA_LEVEL;this.zOffset=this.container.zOffset||0;this.zIndexStart+=this.zOffset;this.params=a;this.style=a.style||"";this.addStyle="";this._scroll=null;this.showScroll=void 0===a.showScroll?!0:a.showScroll;a.overflow&&(this.addStyle="overflow:"+a.overflow+"; ");OU.util.Div.prototype.init=function(b){var a=this,d=this.container,e=b.x||0,f=b.y||0,g=b.w||d.w||window.innerWidth||480,
h=d=b.h||d.h||window.innerHeight||360;d!="auto"&&(h=d+"px");this.x=e;this.y=f;this.w=g;this.h=d;this.div=document.createElement("div");this.div.setAttribute("style",this.addStyle+"left:"+e+"px; top:"+f+"px;width:"+g+"px; height:"+h+"; "+this.style);this.div.setAttribute("class","_overlaydiv "+(this.params.htmlClass||""));this.div.style.zIndex=this.zIndexStart;b.beforeDiv?document.body.insertBefore(this.div,document.getElementById(b.beforeDiv)):document.body.appendChild(this.div);if(this.params.innerHTML)this.div.innerHTML=
this.params.innerHTML;if(this.showScroll&&OU.IS_IPAD){this._scroll=new OU.util.Layer({container:this.container,zIndex:1E4,x:e+g,y:f,w:20,h:d});this._scrollctx=this._scroll.context;this._scrollListener=function(){a.handleScroll()};this.div.addEventListener("scroll",this._scrollListener,false,0,true);this.div.addEventListener("DOMSubtreeModified",this._scrollListener,false,0,true);this.handleScroll()}(b.dontRegister===void 0||b.dontRegister===false)&&OU.addRemovable(this,this.zOffset)};OU.util.Div.prototype.resize=
function(b){var a=b.x||this.x,d=b.y||this.y,e=b.w||this.w,f=b=b.h||this.h;if(!(a===this.x&&d===this.y&&e===this.w&&b===this.h)){b!=="auto"&&(f=b+"px");this.div.setAttribute("style",this.addStyle+"left:"+a+"px; top:"+d+"px;width:"+e+"px; height:"+f+"; "+this.style);if(this.zIndexStart)this.div.style.zIndex=this.zIndexStart;this.x=a;this.y=d;this.w=e;this.h=b;if(this._scroll){this._scroll.resize({x:a+e,y:d,w:20,h:b});this.handleScroll()}}};OU.util.Div.prototype.move=function(b){return this.resize(b)};
OU.util.Div.prototype.slideTo=function(b){this.slideTargetX=b.x||this.x;this.slideTargetY=b.y||this.y;this.slideTargetW=b.w||this.w;this.slideTargetH=b.h||this.h;if(this.moving===void 0){this.moving=true;this.animate()}};OU.util.Div.prototype.animate=function(){var b=this,a={x:this.x+(this.slideTargetX-this.x)/2|0,y:this.y+(this.slideTargetY-this.y)/2|0,w:this.w+(this.slideTargetW-this.w)/2|0,h:this.h+(this.slideTargetH-this.h)/2|0};if(Math.abs(this.x-this.slideTargetX)>2||Math.abs(this.y-this.slideTargetY)>
2){this.move(a);setTimeout(function(){b.animate()},40)}else{this.move({x:this.slideTargetX,y:this.slideTargetY,w:this.slideTargetW,h:this.slideTargetH});this.moving=void 0}};OU.util.Div.prototype.opacity=function(b){this.div.style.opacity=b};OU.util.Div.prototype.zIndex=function(b){this.div.style.zIndex=b+this.zOffset};OU.util.Div.prototype.clear=function(){this.div.innerHtml=""};OU.util.Div.prototype.remove=function(){if(this._scroll){this.div.removeEventListener("scroll",this._scrollListener,false);
this.div.removeEventListener("DOMSubtreeModified",this._scrollListener,false);this._scroll.remove()}this._scroll=this._scrollctx=null;this.div.parentNode&&this.div.parentNode.removeChild(this.div)};OU.util.Div.prototype.handleScroll=function(){if(this._scroll&&this.h!=="auto"){var b=this.div.scrollHeight,a=this.h,d=a*(this.div.scrollTop/b),e=a*(a/b);this._scroll.clear();if(!(b<=a)){this.hasScrollBar=true;this._scrollctx.fillStyle="rgba(128,128,128,0.2)";this._scrollctx.fillRect(5,0,10,a);this._scrollctx.fillStyle=
"rgba(0,0,0,0.2)";this._scrollctx.fillRect(5,d,10,e)}}};this.init(a)};OU.util.Draggable=function(a){this.events=a.events;this.x=a.x;this.y=a.y;this.h=a.h;this.w=a.w;this.dragId=0;this.onStart=a.onStart||function(){};this.onMove=a.onMove||function(){};this.onEnd=a.onEnd||function(){};this.me=a.me;this.disabled=a.disabled||!1};
OU.util.Draggable.prototype.isHit=function(a,b,c){if(!this.disabled){if(c)if(0===this.dragId&&!this.events.dragTaken){if(a>this.x&&a<this.x+this.w&&b>this.y&&b<this.y+this.h){this.dragStart={x:a,y:b};this.dragId=this.events.dragId;this.events.dragTaken=!0;this.onStart({me:this.me,x:this.x,y:this.y});return}}else if(this.dragId===this.events.dragId){this.x+=a-this.dragStart.x;this.y+=b-this.dragStart.y;this.dragStart={x:a,y:b};this.onMove({me:this.me,x:this.x,y:this.y});return}0!==this.dragId&&(this.dragId=
0,this.onEnd({me:this.me,x:this.x,y:this.y}))}};OU.util.Draggable.prototype.resize=function(a){this.x=a.x||0;this.y=a.y||0;this.w=a.w||100;this.h=a.h||40};
OU.util.DynText=function(a){if(void 0===a.context)alert("Incorrect use of DynText Object - Context Required");else{this.context=a.context;this.params=a;this.txt=a.txt||"";this.x=a.x||0;this.y=a.y||0;this.w=a.w||200;this.h=a.h||100;this.maxLines=a.maxLines||1E3;this.relLineHeight=a.relLineHeight||1.1;this.paraBottomMargin=1;this.fontSize=void 0!==a.propTextHeight?this.h*a.propTextHeight*OU.dpr:a.fontSize||24*OU.dpr;this.font=new OU.font({family:a.fontFamily,size:this.fontSize,weight:a.fontWeight});
this.dynamic=!0===a.notDynamic?!1:!0;this.align=a.align||"center";this.padding=a.padding||10;this.verticalPadding=a.verticalPadding||0;this.alignPara=a.alignPara||"left";this.alpha=a.alpha||1;this.autoWidth=a.autoWidth||!1;this.autoCentre=a.autoCentre||!1;this.beenDisabled=!1;this.noBreak=a.noBreak||!1;this.measureOnly=a.measureOnly||!1;this.textMetrics=[];this.textBoxes=[];this.colour=a.colour||void 0;this.rgb=a.rgb||void 0;void 0===this.colour&&void 0===this.rgb&&(this.rgb="26,26,26");if("string"===
typeof this.txt||"number"===typeof this.txt)this.paras={},this.paras.p=[],this.paras.p.push({line:""+this.txt,colour:this.colour,rgb:this.rgb,alpha:this.alpha});else if("string"===typeof this.txt[0]||"number"===typeof this.txt[0]){this.paras={};this.paras.p=[];for(a=0;a<this.txt.length;a++)this.paras.p.push({line:""+this.txt[a],colour:this.colour,rgb:this.rgb,alpha:this.alpha})}else this.paras=this.txt;this.render()}};
OU.util.DynText.prototype.render=function(){var a=this.w-2*this.padding,b,c,d,e,f,g,h,i,j,m,k,p,x,P,z,A,l=this.paras.p,B=l.length;d=0.8*this.h-this.font.size*this.paraBottomMargin*(l.length-1)+this.font.size*(this.relLineHeight-1)-2*this.verticalPadding;var G=e=0,n,q=this.x+this.padding;k=!0;var o=this.context;o.save();if(this.noBreak){g=l[0];g.lines=[];g.lines.push(g.line);c=g.line;c=c.replace(/<\/?[a-z][a-z0-9]*[^<>]*>/ig,"");o.font=this.font.str();j=o.measureText(c,this.x,this.y).width;for(G=1;j>
a;)this.font.size--,o.font=this.font.str(),e=j=o.measureText(c,this.x,this.y).width}else{do{k=!1;o.font=this.font.str();for(h=e=G=0;h<B;h++){g=l[h];b=g.line;g.lines=[];i=0;for(g.lines[i]="";void 0!==b&&0<b.length;)if(m=b.split(" ",1),c=g.lines[i]+m[0],c=c.replace(/<\/?[a-z][a-z0-9]*[^<>]*>/ig,""),j=o.measureText(c,this.x,this.y),this.textMetrics.push(o.measureText(m[0].replace(/<\/?[a-z][a-z0-9]*[^<>]*>/ig,""),this.x,this.y)),a<j.width&&""!==g.lines[i]&&this.dynamic?(i++,g.lines[i]=""):j.width>e&&
(e=j.width),g.lines[i]+=m[0]+" ",b=b.substr(m[0].length+1),e>a){k=!0;h=B;break}G=G+i+1;if(G*this.font.size*this.relLineHeight>=d){k=!0;break}}this.font.size--}while(k&&5<this.font.size&&this.dynamic&&G<this.maxLines)}this.font.size++;if(this.autoWidth||this.measureOnly)this.autoCentre&&(this.x+=(this.w-(e+2*this.padding))/2),this.w=e+2*this.padding;this.params.background&&o.background(this.params.background,this);o.textAlign="center"===this.align?this.align:"left";"center"===this.alignPara&&(q=(this.w-
e)/2+this.x);g=G*this.font.size*this.relLineHeight;g-=this.font.size*(this.relLineHeight-1);g+=(l.length-1)*this.font.size*this.paraBottomMargin;if(this.measureOnly)this.h=(g+this.font.size*this.paraBottomMargin*(l.length-1)+this.font.size*(this.relLineHeight-1)-2*this.verticalPadding)/0.8;else{i="top"===this.params.verticalAlign?this.y+this.font.size/2:"bottom"===this.params.verticalAlign?this.y+(this.h-g)+this.font.size/2:this.y+(this.h-g)/2+this.font.size/2;j=this.font.size;for(h=G=0;h<B;h++){g=
l[h];g.colour&&(o.fillStyle=g.colour);g.rgb&&(o.fillStyle=g.alpha?"rgba("+g.rgb+","+g.alpha+")":"rgba("+g.rgb+",1)");m=g.lines.length;for(a=0;a<m;a++){b=""+g.lines[a];b=b.replace(/<\/?[a-z][a-z0-9]*[^<>]*>/ig,"");b=o.measureText(b,this.x,i).width;f="center"===this.align?this.x+(this.w-b)/2:"right"===this.align?this.x+this.w-this.padding-b:q;A=g.lines[a].split(" ");for(k=0;k<A.length;k++){n=A[k].split(/(<\/?[a-z][a-z0-9]*[^<>]*>)\s*/gi)||[g.lines[a]];d=f;for(b=0;b<n.length;b++){c=n[b];switch(c){case "<strong>":case "<b>":this.font.weight=
"bold";o.font=this.font.str();break;case "</strong>":case "</b>":this.font.weight="";o.font=this.font.str();break;case "<i>":case "<em>":this.font.style="italic";o.font=this.font.str();break;case "</i>":case "</em>":this.font.style="";o.font=this.font.str();break;case "<sub>":i+=0.4*this.font.size;this.font.size*=0.6;o.font=this.font.str();break;case "</sub>":this.font.size/=0.6;o.font=this.font.str();i-=0.4*this.font.size;break;case "<sup>":i-=0.4*this.font.size;this.font.size*=0.6;o.font=this.font.str();
break;case "</sup>":this.font.size/=0.6;o.font=this.font.str();i+=0.4*this.font.size;break;case "<br/>":case "<br>":e=o.measureText(" ",this.x,i).width;d+=e;break;default:e=o.measureText(c,this.x,i).width;"center"===this.align?(f=d+e/2,o.fillText(c,d+e/2,i+G*j*this.relLineHeight)):(f=d,o.fillText(c,d,i+G*j*this.relLineHeight));var Q=i+G*j*this.relLineHeight;0===b?(p=f,x=Q-this.font.size/2,P=f+e,z=Q-this.font.size/2+this.font.size):(f<p&&(p=f),Q-this.font.size/2<x&&(x=Q-this.font.size/2),f+e>P&&(P=
f+e),Q-this.font.size/2+this.font.size>z&&(z=Q-this.font.size/2+this.font.size));d+=e}f=d}e=o.measureText(" ",this.x,i).width;f+=e;this.textBoxes.push({seg:c,x:p,y:x,w:P-p,h:z-x})}G++}i+=j*this.paraBottomMargin}o.restore()}};
OU.util.pageTitle=function(a){var b=a.context,c=a.w||b.canvas.width,d=a.h||0.05*b.canvas.height,e=a.x||0,f=a.y||0;b.fillStyle=a.col||"rgba(255,255,255,1)";b.fillRect(e,f,c,d);new OU.util.DynText({txt:a.txt,x:e,y:f,w:c,h:d,context:b,propTextHeight:0.5,fontWeight:"bold",maxLines:1,align:"left"})};
OU.util.pageStrap=function(a){var b=a.context,c=a.w||b.canvas.width,d=a.h||0.05*b.canvas.height,e=a.x||0,f=a.y||0.05*b.canvas.height,g=b.createLinearGradient(e,f,c,d);g.addColorStop(0,a.col1||"rgba(255,255,255,0.5)");g.addColorStop(1,a.col2||"rgba(255,255,255,0)");b.fillStyle=g;b.fillRect(e,f,c,d);new OU.util.DynText({txt:a.txt,x:e,y:f,w:c,h:d,context:b,propTextHeight:0.2,maxLines:1,align:"left"})};
OU.util.Events=function(a){var b=this;this.y=this.x=0;this.touched=this.pressed=!1;this.dragStart=0;this.lastDrag=(new Date).getTime();this.clickable=new OU.util.TypedArray;this.dragId=0;this.dragTaken=!1;this.swipeEnabled=!0;this.doubleTap=!1;this.lastTouch={when:(new Date).getTime(),x:0,y:0};void 0===a.target?alert("Events Object requires a target"):(this.target=a.target,this.target.events=this,this.keyPressFn=a.keyPress||function(){},this.moveRight=a.moveRight||function(){},this.moveLeft=a.moveLeft||
function(){},this.pinch=a.pinch,this.pinchMe=a.pinchMe,this.clickTouch=void 0===a.clickTouch?function(){}:a.clickTouch,a.target.addEventListener("mousedown",this.mouseDown,!1,0,!0),a.target.addEventListener("dblclick",this.mouseDouble,!1,0,!0),a.target.addEventListener("mouseup",this.mouseUp,!1,0,!0),a.target.addEventListener("mouseout",this.mouseOut,!1,0,!0),a.target.addEventListener("mousemove",this.mouseMove,!1,0,!0),a.target.addEventListener("mousewheel",this.mouseWheel,!1,0,!0),a.target.addEventListener("touchstart",
this.touchStart,!1,0,!0),a.target.addEventListener("touchend",this.touchUp,!1,0,!0),a.target.addEventListener("touchmove",this.touchMove,!1,0,!0),a.target.addEventListener("gestureend",this.touchGesture,!1,0,!0),document.addEventListener("keydown",this.listener=function(a){b.keyDown(a)},!1,0,!0))};
OU.util.Events.prototype.remove=function(){document.removeEventListener("keydown",this.listener);this.target.removeEventListener("gestureend",this.touchGesture,!1);this.target.removeEventListener("touchmove",this.touchMove,!1);this.target.removeEventListener("touchend",this.touchUp,!1);this.target.removeEventListener("touchstart",this.touchStart,!1);this.target.removeEventListener("mousewheel",this.mouseWheel,!1);this.target.removeEventListener("mousemove",this.mouseMove,!1);this.target.removeEventListener("mouseout",
this.mouseOut,!1);this.target.removeEventListener("mouseup",this.mouseUp,!1);this.target.removeEventListener("dblclick",this.mouseDouble,!1);this.target.removeEventListener("mousedown",this.mouseDown,!1);for(var a=this.clickable.length;a--;)delete this.clickable[a];this.clickable.length=0;this.target.events=null};OU.util.Events.prototype.disableSwipe=function(){this.swipeEnabled=!1;this.dragStart=0};OU.util.Events.prototype.enableSwipe=function(){this.swipeEnabled=!0};
OU.util.Events.prototype.keyDown=function(a){var b=null;a._dealtWith||(window.event?b=window.event.keyCode:a&&(b=a.which||a.keyCode),39==b&&this.moveRight&&this.moveRight(),37==b&&this.moveLeft&&this.moveLeft(),this.keyPressFn&&this.keyPressFn(b))};OU.util.Events.prototype.mouseDouble=function(){this.events.doubleTap=!0;this.events.trigger();this.events.pinch&&this.events.pinch(this.width/10,0,this.events.x,this.events.y,0,0,this.events.pinchMe)};
OU.util.Events.prototype.mouseDown=function(a){a.preventDefault();a=OU.combineMouseTouch(a);this.events.x=a.pageX-this.offsetLeft;this.events.y=a.pageY-this.offsetTop;this.events.dragStart=this.events.x;this.events.dragId++;this.events.dragTaken=!1;this.events.pressed=!0;this.events.clickTouch();this.events.trigger("mouseDown")};
OU.util.Events.prototype.mouseOut=OU.util.Events.prototype.mouseUp=function(a){a.preventDefault();a=OU.combineMouseTouch(a);this.events.x=a.pageX-this.offsetLeft;this.events.y=a.pageY-this.offsetTop;this.events.pressed=!1;0<this.events.dragStart&&this.events.swipeX(this.events.dragStart,this.events.x);this.events.trigger("mouseUp")};
OU.util.Events.prototype.swipeX=function(a,b){if(this.swipeEnabled&&(b>a+10&&(this.moveLeft(),this.lastDrag=(new Date).getTime()),b<a-10))this.moveRight(),this.lastDrag=(new Date).getTime()};OU.util.Events.prototype.mouseMove=function(a){this.events.x=a.pageX-this.offsetLeft;this.events.y=a.pageY-this.offsetTop;this.events.trigger("mouseMove")};OU.util.Events.prototype.mouseWheel=function(a){a.preventDefault();0<a.wheelDelta&&this.events.moveLeft();0>a.wheelDelta&&this.events.moveRight()};
OU.util.Events.prototype.touchStart=function(a){var b,c=(new Date).getTime(),d=this.events.lastTouch;a.preventDefault();a=OU.combineMouseTouch(a);if(a.touches&&1<a.touches.length){this.events.startTouches=[];for(b=0;b<a.touches.length;b++)this.events.startTouches[b]={pageX:a.touches[b].pageX,pageY:a.touches[b].pageY}}else b=this.events.x=a.pageX-this.offsetLeft,a=this.events.y=a.pageY-this.offsetTop,this.events.dragStart=this.events.x,this.events.dragId++,this.events.dragTaken=!1,this.events.touched=
!0,this.events.clickTouch(),500>c-d.when&&-20<d.x-b&&20>d.x-b&&-20<d.y-a&&20>d.y-a&&(this.events.doubleTap=!0),this.events.lastTouch={when:c,x:b,y:a},this.events.trigger()};OU.util.Events.prototype.touchUp=function(a){a.preventDefault();a=OU.combineMouseTouch(a);this.events.touched=!1;a.touches&&1<a.touches.length?this.events.processTouches(a.touches,this):(this.events.x=a.pageX-this.offsetLeft,this.events.y=a.pageY-this.offsetTop,this.events.trigger())};
OU.util.Events.prototype.touchMove=function(a){var b=(new Date).getTime();a.preventDefault();a=OU.combineMouseTouch(a);a.touches&&1<a.touches.length?this.events.processTouches(a.touches,this):(this.events.x=a.pageX-this.offsetLeft,this.events.y=a.pageY-this.offsetTop,1E3<b-this.events.lastDrag&&(this.events.swipeX(this.events.dragStart,this.events.x),this.events.touched=!0),this.events.trigger())};
OU.util.Events.prototype.processTouches=function(a,b){if(this.startTouches){var c;c=this.startTouches;var d=c[1].pageX-c[0].pageX,e=c[1].pageY-c[0].pageY,f=Math.sqrt(d*d+e*e),g=a[1].pageX-a[0].pageX,h=a[1].pageY-a[0].pageY,i=Math.sqrt(g*g+h*h),j=a[1].pageX-g/2-b.offsetLeft,m=a[1].pageY-h/2-b.offsetTop;if(f!=i){for(c=this.startTouches.length=0;c<a.length;c++)this.startTouches[c]={pageX:a[c].pageX,pageY:a[c].pageY};this.pinch&&this.pinch(i,f,j,m,0==d?0:g/d,0==e?0:h/e,this.pinchMe)}}};
OU.util.Events.prototype.touchGesture=function(){};OU.util.Events.prototype.trigger=function(){var a;if(0<this.clickable.length)for(a=this.clickable.length;a--;)if(this.clickable[a]&&this.clickable[a].isHit(this.x,this.y,this.touched||this.pressed,this))this.touched=this.pressed=!1};OU.util.Events.prototype.active=function(){return this.touched||this.pressed};OU.util.Events.prototype.flush=function(){this.touched=this.pressed=!1};
OU.util.HtmlBox=function(a){var b=this;if(null==document.getElementById("htmlBox")){void 0===a&&(a={});var c=a.style||"";this.x=a.x||0;this.y=a.y||0;this.w=a.w||400;this.h=a.h||300;this.container=a.container||{};40<this.w&&(this.w-=40);40<this.h&&(this.h-=40);this.startY=-1;this.unclosable=this.dead=!1;void 0!==a.unclosable&&(this.unclosable=a.unclosable);this.handleScrolling=!0;void 0!==a.handleScrolling&&(this.handleScrolling=a.handleScrolling);this.div=document.createElement("div");this.showScroll=
!0;void 0!==a.showScroll&&(this.showScroll=a.showScroll);a.unclosable?this.div.setAttribute("id","uncloseableHtmlBox"):this.div.setAttribute("id","htmlBox");this.div.setAttribute("style","overflow:auto; position:absolute; top:"+this.y+"px; left:"+this.x+"px; width:"+this.w+"px; height:"+this.h+"px; padding:0 20px;"+c);this.zOffset=this.container.zOffset||0;this.div.style.zIndex=this.zOffset+OU.POP_UP_LEVEL;this.div.innerHTML=a.html;document.body.appendChild(this.div);this.showScroll&&OU.IS_IPAD&&
(this._scroll=document.createElement("canvas"),document.body.appendChild(this._scroll),this._scroll.height=this.h,this._scroll.width="20",this._scroll.top=this.y,this._scrollctx=this._scroll.getContext("2d"),this._scroll.setAttribute("style","z-index:10000;position:absolute;top:"+this.y+"px; left:"+(this.x+this.w+25)+"px; height:"+this.h+";width:20px;"));void 0===a.dontRegister&&OU.addRemovable(this,this.zOffset);OU.util.HtmlBox.prototype.resize=function(b){if(b.x!==void 0)this.div.style.left=b.x+
"px";if(b.y!==void 0)this.div.style.top=b.y+"px";if(b.w!==void 0)this.div.style.width=b.w+"px";if(b.h!==void 0)this.div.style.height=b.h+"px"};OU.util.HtmlBox.prototype.touchStart=function(a){a=OU.combineMouseTouch(a);b.startY=a.pageY};OU.util.HtmlBox.prototype.touchUp=function(a){OU.combineMouseTouch(a);b.startY=-1};OU.util.HtmlBox.prototype.touchMove=function(a){a.preventDefault();a=OU.combineMouseTouch(a);if(b.startY!=-1){a=b.div.scrollTop+(b.startY-a.pageY)*0.1;a<0&&(a=0);a>b.div.scrollHeight-
b.h&&(a=b.div.scrollHeight-b.h);b.div.scrollTop=a}};OU.util.HtmlBox.prototype.handleScroll=function(){var a=b.div.scrollHeight,c=b.div.scrollTop,f=b.div.clientHeight,g,h,i;h=b._scroll.width;i=b._scroll.height;g=f*(f/a);c=(f-g)*(c/(a-f));if(f!=a){b._scrollctx.clearRect(0,0,h,i);b._scrollctx.fillStyle="rgba(128,128,128,0.1)";b._scrollctx.fillRect(5,0,10,i);b._scrollctx.fillStyle="rgba(0,0,0,0.2)";b._scrollctx.fillRect(5,c,10,g)}};OU.util.HtmlBox.prototype.remove=OU.util.HtmlBox.prototype.close=function(){if(this.div!=
null){this.div.removeEventListener("mousedown",this.touchStart,false);this.div.removeEventListener("touchstart",this.touchStart,false);this.div.removeEventListener("touchend",this.touchUp,false);this.div.removeEventListener("touchmove",this.touchMove,false);this._scroll!=null&&this.div.removeEventListener("scroll",this.handleScroll,false);this.div.parentNode.removeChild(this.div);this.div=null;if(this._scroll!=null){document.body.removeChild(this._scroll);this._scroll=this._scrollctx=null}}};this.handleScrolling&&
(this.div.addEventListener("mousedown",this.touchStart,!1),this.div.addEventListener("touchstart",this.touchStart,!1),this.div.addEventListener("touchend",this.touchUp,!1),this.div.addEventListener("touchmove",this.touchMove,!1),null!=this._scroll&&(this.div.addEventListener("scroll",this.handleScroll,!1),this.handleScroll()))}};
OU.util.ImageLoader=function(a){this.loaded=this.required=0;this.complete=!1;this.jItems=[];this.started=(new Date).getTime();this.onLoadFn=a.onLoad;this.container=a.container||{};this.data=a.data;this.progressWindow=a.progressWindow;this.halted=!1;OU.addRemovable(this,this.container.zOffset);OU.util.ImageLoader.prototype.init=function(){this.progressLayer=new OU.util.Layer({container:this.container,id:"loadingLayer"+this.container.instance,zIndex:OU.CONTROLLER_LEVEL-10});var b=this.progressLayer.context;
b.font=16*OU.dpr+"px serif";b.textAlign="center";b.strokeStyle="#999";b.fillStyle="#0c0";this.dataDir=this.container.dataDir;this.progress();for(this.load(this.data);0<this.jItems.length;)this.load(this.jItems.pop());this.wait()};OU.util.ImageLoader.prototype.load=function(b){var a,d,e=this;if(null!=b){if("array"==typeof b)for(a=b.length;a--;)d=b[a],("object"==typeof d||"array"==typeof d)&&this.jItems.push(d);else if("object"==typeof b)for(a in b)a&&b.hasOwnProperty(a)&&(d=b[a])&&!d._imageLoaderBeenHere&&
("object"==typeof d||"array"==typeof d)&&this.jItems.push(d);d=b.fileName?b.fileName:"";d=""!=d?d:b.img?b.img:"";""!=d&&(this.required++,b.image=new Image,b.image.src=this.dataDir+d,b.image.onload=function(){e.loaded++;e.progress()});b._imageLoaderBeenHere=!0}};OU.util.ImageLoader.prototype.wait=function(){if(!this.halted){var b=this,a=(new Date).getTime();this.loaded>=this.required?(this.progressLayer.remove(),this.complete=!0,this.onLoadFn()):6E4<a-this.started?(alert("There was a problem loading files - load time exceeded. This activity may not work correctly."),
this.progressLayer.remove(),this.onLoadFn()):setTimeout(function(){b.wait()},40)}};OU.util.ImageLoader.prototype.remove=function(){this.required++;this.halted=!0;this.data=void 0};OU.util.ImageLoader.prototype.progress=function(){var b=this.progressLayer,a=b.context,d=100*(this.loaded/this.required)|0,e=b.w/4,f=b.h/2-40*OU.dpr,b=b.w/2,g=10*OU.dpr;a.clearRect(0,0,this.progressLayer.w,this.progressLayer.h);this.progressWindow?(this.progressWindow.txt="Loading... "+d+"%",this.progressWindow.context=
a,new OU.util.DynText(this.progressWindow)):(a.rect(e,f,b,g),a.stroke(),a.fillRect(e,f,b*d/100,g),a.save(),a.fillStyle="#222",a.fillText("Loading... "+d+"%",this.progressLayer.w/2,this.progressLayer.h/2),a.restore())};this.init()};
OU.util.Instruction=function(a){var b=a.container;this.container=b;this.message=a.message||"Oops! Undefined instruction";this.duration=a.duration||6E3;this.kill=!1;this.params=a;this.onClose=a.onClose||function(){};this.dims={x:a.x||0.3*b.w,y:a.y||0.4*b.h,w:a.w||0.4*b.w,h:a.h||0.2*b.h};OU.baseController.headerDiv?(this.shrinkArea={x:OU.baseController.w-1.5*OU.controlHeight,y:OU.baseController.headerHeight-OU.controlHeight,w:OU.controlHeight,h:OU.controlHeight},this.dims={x:OU.controlHeight,y:OU.baseController.headerHeight+
10,w:OU.baseController.w-2*OU.controlHeight,h:0.25*OU.baseController.h}):this.shrinkArea=a.shrinkArea||{x:OU.controlHeight,y:OU.controlHeight,w:OU.controlHeight,h:OU.controlHeight};this.bgCol=a.bgCol||OU.theme.instructionsBg;this.colour=a.colour||OU.theme.instructionsCol;OU.util.Instruction.prototype.init=function(){var b=this,a,e,f=this.container,g=OU.controlHeight;this.started=(new Date).getTime();this.layer=new OU.util.Layer({container:f,hasEvents:true,zIndex:OU.POP_UP_LEVEL});this.layer.events.clickable.push(this);
a=this.layer.context;this.layer.opacity(1);if(this.params.point){e=this.params.point;a.beginPath();a.moveTo(e.x,e.y);a.fillStyle=this.bgCol;this.dims.x=e.x<=f.w/2?e.x-this.dims.w/2<0?0:e.x-this.dims.w/2:e.x+this.dims.w/2>f.w?f.w-this.dims.w:e.x-this.dims.w/2;if(e.y<=f.h/2){this.dims.y=e.y+f.h*0.2;a.lineTo(this.dims.x+this.dims.w/2-15,this.dims.y);a.lineTo(this.dims.x+this.dims.w/2+15,this.dims.y)}else{this.dims.y=e.y-f.h*0.4;a.lineTo(this.dims.x+this.dims.w/2-15,this.dims.y+this.dims.h);a.lineTo(this.dims.x+
this.dims.w/2+15,this.dims.y+this.dims.h)}a.fill()}new OU.util.DynText({txt:this.message,context:a,x:this.dims.x,y:this.dims.y,w:this.dims.w,h:this.dims.h,align:"left",padding:g*2,background:{borderCol:"#296E8F",col:"#ccc",radius:5},colour:"#000"});this.infoButton=new OU.util.InfoButton({txt:"",x:this.dims.x+10,y:this.dims.y+10,w:this.shrinkArea.w,h:this.shrinkArea.h,layer:this.layer,background:{clear:false},onClick:function(){b.shrink()}});this.layer.context.closeIcon({x:this.dims.x+this.dims.w-
45,y:this.dims.y+10,r:30})};OU.util.Instruction.prototype.isHit=function(b,a,e){e&&this.shrink()};OU.util.Instruction.prototype.grow=function(){if(this.infoButton){this.infoButton.remove();this.infoButton=void 0}this.layer.events.flush();this.layer.remove();this.kill=false;this.init()};OU.util.Instruction.prototype.shrink=function(){var b=this;this.layer.events.flush();this.infoButton&&this.infoButton.remove();this.layer.clear();this.layer.resize({x:this.dims.x+10,y:this.dims.y+10,w:this.shrinkArea.w,
h:this.shrinkArea.h});this.infoButton=new OU.util.InfoButton({txt:"",x:0,y:0,w:this.shrinkArea.w,h:this.shrinkArea.h,layer:this.layer,onClick:function(){b.grow()}});this.layer.slideTo(this.shrinkArea);this.onClose()};OU.util.Instruction.prototype.remove=function(){this.infoButton&&this.infoButton.remove();this.layer.remove()};this.init()};
OU.util.JsonP=function(a){var b,c,d=a.data||"";OU._JsonPCallbackArray||(OU._JsonPCallbackArray=[]);c=OU._JsonPCallbackArray.length;OU._JsonPCallbackArray[c]=a.onSuccess;d=encodeURI(d);b=document.createElement("script");b.src=a.uri+"?callbackId="+c+"&"+d;b.id="jsonp"+c;b.type="text/javascript";OU.head.appendChild(b);setTimeout(function(){OU._cleanupJsonP(c)},5E3)};OU.jsonpCallback=function(a,b){if(OU._JsonPCallbackArray[a])OU._JsonPCallbackArray[a](b);OU._cleanupJsonP(a)};
OU._cleanupJsonP=function(a){var b=document.getElementById("jsonp"+a);b&&setTimeout(function(){try{OU.head.removeChild(b)}catch(a){}},1);OU._JsonPCallbackArray[a]=void 0};
OU.util.Keyboard=function(a){var b=this;void 0===a&&(a={});this.container=a.container||{};this.zIndexStart=(a.zIndex||OU.DATA_LEVEL)+100;this.zOffset=this.container.zOffset||0;this.zIndexStart=this.zIndexStart+this.zOffset+1E3;void 0!==this.container.controller&&void 0!==this.container.controller.activities&&void 0!==this.container.controller.activities[this.container.instance]&&void 0!==this.container.controller.activities[this.container.instance]._zOffset?(this.zOffset=this.container.controller.activities[this.container.instance]._zOffset,
this.zIndexStart+=this.zOffset):this.zOffset=this.zIndexStart;this.params=a;this.style=a.style||"";this.addStyle="";this.nChars=0;void 0!==a.overflow&&(this.addStyle="overflow:"+a.overflow+"; ");OU.util.Keyboard.prototype.init=function(b){var a,e;this.newLs=[];this.maxChars=this.params.maxChars;if(this.params.calculate){this.maxChars=10;this.keys0="7\u00a08\u00a09\u00a0+\u00a0\n 4\u00a05\u00a06\u00a0-\u00a0\n 1\u00a02\u00a03\u00a0\u00d7\u00a0\n 0\u00a0.\u00a0E\u00a0\u00f7\u00a0"}else if(this.params.numbers){this.maxChars=
10;this.keys0="7\u00a08\u00a09\u00a0\n 4\u00a05\u00a06\u00a0\n 1\u00a02\u00a03\u00a0\n 0\u00a0.\u00a0-\u00a0\n E\u00a0"}else this.keys0=this.params.keys||"`_1!2\"3??4$5%6^7&8*9(0)-_=+\n Q W E R T Y U I O P {[}]\n A S D F G H J K L ;:'@#~\n \\|Z X C V B N M ,<.>/?";e=0;this.nRows=1;for(a=0;a<this.keys0.length;a=a+2)if(this.keys0[a]==="\n"){this.newLs.push(e);this.nRows++}else e++;this.keys=this.keys0=this.keys0.replace(/\n /g,"");this.uniCOffs=0;this.space=b.space!==false;this.unicode=b.unicode!==
false;this.formatting=b.formatting!==false;this.shift=b.shift!==false;this.enter=b.enter!==false;this.isWeb=OU.isWeb===0||OU.isWeb===false?0:1;b===void 0&&(b={});a=b.x||0;e=b.y||0;var f=b.w*1.2||480,g=b.h||360;this.w=f*b.container.w;this._x=a;this._y=e;this._w=f;this._h=g;if(b.dontRegister===void 0||b.dontRegister===false)this.zOffset!==void 0?OU.removables.push(this,this.zOffset):OU.removables.push(this);this.layer=new OU.util.Layer({container:this.container,hasEvents:true,zIndex:this.zIndexStart+
1});this.selDiv=new OU.util.Div({container:this.container,zIndex:this.zIndexStart,showScroll:false});this.div=new OU.util.Div({container:this.container,zIndex:this.zIndexStart+2,style:"position:absolute;background:#fff;border:solid 1px;border-radius:3px;padding:0px;overflow:visible;display:block;",showScroll:false});this.div.div.tabIndex=1;this.selDiv.div.className="gpd";this.kb=[];this.shift=false;this.closeB=this.newButton("\u00d7",null,function(){h.nChars=0;if(OU.thsKP)OU.thsKP.dispDiv.style.border=
"solid 1px";h.setVisible(false)});for(a=0;a<this.keys.length/2;a++){e=a*2;b=this.keys[e]+(this.keys[e+1]!=="\u00a0"?" <sup>"+this.keys[e+1]+"</sup>":"");e=function(b){b[0].nChars++;if(!(b[0].maxChars&&b[0].nChars>b[0].maxChars)){var a=b[0].keys.charCodeAt(b[1]*2),c=b[0].keys.charCodeAt(b[1]*2+1),d=String.fromCharCode(a),c=String.fromCharCode(c);d==="<"&&(d="&lt;");c==="<"&&(c="&lt;");d===">"&&(d="&gt;");c===">"&&(c="&gt;");a=c===" "&&b[0].uniCOffs===0?b[0].shift?d:String.fromCharCode(a+32):b[0].shift?
c:d;b[0].html=b[0].html+a;b[0].div.div.innerHTML=b[0].html}};this.kb[a]=this.newButton(b,a,e)}if(this.unicode){this.nRows=this.nRows+4;this.changeUnic=function(){document.getElementById("kbSel")};b="<option value='0.1'>Unicode page...</option>";for(a=0;a<200;a++)b=b+("<option value='"+a+"'>"+a+"</option>");this.kbSel=document.createElement("select");this.kbSel.innerHTML=b;this.du=this.keys0.length;this.ind=0;this.kbSel.onchange=function(){if(this.value==="next"){h.ind++;h.uniCOffs=h.uniCOffs+h.du}else if(this.value===
"previous"){if(h.ind>0){h.ind--;h.uniCOffs=h.uniCOffs-h.du}}else{h.ind=parseInt(this.value);h.uniCOffs=parseInt(this.value)*h.du}this.value=h.ind;h.render()};this.kbSel.setAttribute("style","z-index:"+(this.zIndexStart+10)+";position:relative;");this.selDiv.div.appendChild(this.kbSel);this.prvUni=this.newButton("\u25c4",null,function(){if(h.ind!==0){h.ind--;h.kbSel.value=h.ind;h.uniCOffs=h.uniCOffs-h.du;h.render()}});this.nxtUni=this.newButton("\u25ba",null,function(){h.ind++;h.kbSel.value=h.ind;
h.uniCOffs=h.uniCOffs+h.du;h.render()})}this.delS=["leftarrow","\u2190",function(b){var a=b[0].html.length;if(!(a<0)){b[0].html[a-1]===">"&&(a=b[0].html.lastIndexOf("<")+1);var c=b[0].html.substring(a-4,a);if(c==="&gt;"||c==="&lt;")a=a-3;b[0].html=b[0].html.substring(0,a-1);b[0].div.div.innerHTML=b[0].html}}];this.setHtml=function(b){h.html=b;h.div.div.innerHTML=b};this.specs=this.params.specials!==false&&!this.params.numbers&&!this.params.calculate?[["uparrow","\u21e7",function(b){b[0].shift=!b[0].shift;
b[0].isWeb?b[0].specBs[0].style.backgroundImage="url('../library/css/bbg"+(b[0].shift?"h":"")+".png')":b[0].specBs[0].params.onOff=b[0].shift;b[0].specBs[0].render()}],this.delS]:[];this.specBs=[];for(a=0;a<this.specs.length;a++)this.specBs[a]=this.newButton(this.specs[a][1],a,this.specs[a][2]);var h=this;if(this.space){this.nRows++;this.space=this.newButton(" ",1,function(b){b[0].html=b[0].html+"\u00a0";h.div.div.innerHTML=b[0].html})}if(this.params.ok){this.nRows++;this.okB=this.newButton(this.params.scientific?
"Done":"OK",1,h.params.okFn)}this.clearB=this.newButton("C",1,function(){h.nChars=0;h.html="";h.div.div.innerHTML=""});if(this.params.calculate){this.nRows++;if(this.params.scientific){this.nRows=this.nRows+2;a=0;h.sciFs=["log","exp","sin","cos","tan"];h.sciBs=[];for(a=0;a<h.sciFs.length;a++){e=function(b){h.nChars=0;var a;try{var c=h.div.div.innerHTML.replace(/\&\#160\;/g,"").replace(/\u00D7/g,"*").replace(/\u00F7/g,"/");if(isNaN(c))a="Error";else{b[1]>1&&h.degrees&&(c=c/180*Math.PI);c=eval(c);a=
eval("Math."+h.sciFs[b[1]]+"("+c+")")}isFinite(a*1E5)&&(a=parseInt(a*1E5+(a<0?-0.5:0.5))/1E5)}catch(d){a="Error"}h.html=(""+a).replace("NaN","Error");h.div.div.innerHTML=h.html};h.sciBs[a]=h.newButton("\u00a0 "+h.sciFs[a].toUpperCase()+"\u00a0",a,e,"#111111")}h.degrees=false;h.sciBs[a]=h.newButton("RAD/deg",a,function(b){h.degrees=!h.degrees;h.sciBs[b[1]].setTxt(h.degrees?"DEG/rad":"RAD/deg")})}this.okB=this.newButton("=",1,function(){h.nChars=0;var b,a;try{b=h.div.div.innerHTML.replace(/\&\#160\;/g,
"").replace(/\u00d7/g,"*").replace(/\u00f7/g,"/");if(b.indexOf("rr")>0||b.indexOf("def")>0||b.indexOf("nfi")>0)b="Error";else{a=eval(b);b=isNaN(a)?"Error":isFinite(a*1E5)?(a*1E5+(a<0?-0.5:0.5)|0)/1E5:a}}catch(c){b="Error"}h.html=b;h.div.div.innerHTML=h.html});this.cancelB=this.newButton("Done",1,function(){h.nChars=0;h.params.okFn&&h.params.okFn();if(OU.thsKP)OU.thsKP.dispDiv.style.border="solid 1px";h.setVisible(false)})}this.extras=[["Subscript","<sub>",2],["Superscript","<sup>",1],["Bold","<b>"],
["Italic","<i>"],["Underline","<u>"]];this.extraBs=[];this.html="";if(this.formatting){this.nRows++;for(a=0;a<this.extras.length;a++){this.extraBs[a]=this.newButton(this.extras[a][0],a,function(b){var a=b[0].extraBs[b[1]],c=b[0].extras[b[1]][1];a.params.onOff=!a.params.onOff;if(a.style)a.style.backgroundImage="url('../library/css/bbg"+(a.params.onOff?"h":"")+".png')";a.params.onOff||(c=c.replace("<","</"));var d=b[0].extras[b[1]][2];if(d){b[0].extraBs[d-1].params.onOff=false;if(b[0].extraBs[d-1].style)b[0].extraBs[d-
1].style.backgroundImage="url('../library/css/bbg.png')";b[0].extraBs[d-1].render();b[0].html=b[0].html+b[0].extras[d-1][1].replace("<","</")}b[0].html=b[0].html+c;b[0].div.div.innerHTML=b[0].html;a.render()});if(this.isWeb)this.extraBs[a].params={onOff:false,hasOnOff:true,onOffIndicator:true}}}this.setVisible(false)};OU.util.Keyboard.prototype.render=function(){};OU.util.Keyboard.prototype.newButton=function(a,d,e){var f;if(a.indexOf("_ <sup>_")>=0)f={render:function(){},resize:function(){},setTxt:function(){}};
else{var g,h=e||function(){};if(b.isWeb){g=this.selDiv.div;f=document.createElement("a");f.th=[this,d];f.onclick=function(){h(this.th)};f.href="javascript:;";f.setAttribute("style","position:absolute;top:10px;left:20px;text-align:center;padding:0px;color:#eee;");f.style.border="solid 1px #eee";f.style.borderRadius="3px";f.style.background="#aaa";f.style.textDecoration="none";f.style.zIndex=this.zIndexStart+10;f.background={col:"#aaa"};f.render=function(){this.style.background=this.background.col};
f.resize=function(a){this.style.left=""+(parseInt(b.layer.canvas.style.left)+4+a.x|0)+"px";this.style.top=""+(parseInt(b.layer.canvas.style.top)+2+a.y|0)+"px";this.style.height=""+(a.h*0.6|0)+"px";this.style.width=""+(a.w*0.7|0)+"px";this.style.fontSize=""+(a.h/2.9|0)+"px"};g.appendChild(f);f.style.padding="0px";f.style.paddingTop="0.5%"}else{f=new OU.util.Button({txt:a,layer:this.layer,background:{col:"#aaaaaa",radius:2,borderCol:"#999999"},onClick:e,onClickParam:[this,d]});f.th=[this,d];f.params.onClick=
function(){e(this.th)}}f.setTxt=function(b){if(this.params){this.params.txt=b;this.render()}else if(this.th)this.innerHTML=b};f.setTxt(a)}return f};OU.util.Keyboard.prototype.setVisible=function(b,a){var e=b?"block":"none";if(!a)a=this.div.div.innerHTML;if(a===""||a===" "){a="&#160;";this.div.div.innerHTML=a}a=a.replace(/ /g,"").replace(/\&\#160\;/g," ").replace(/\&nbsp\;/g," ");this.nChars=0;if(b&&a){this.nChars=a.length;this.html=a;this.div.div.innerHTML=a}this.layer.canvas.style.display=e;this.layer.canvas.style.zIndex=
this.zIndexStart+1;this.div.div.style.display=e;this.selDiv.div.style.display=e};OU.util.Keyboard.prototype.resize=function(){var a=window.innerWidth*this._x,d=window.innerHeight*this._y,e=window.innerHeight*this._h/(this.nRows+1)*0.95,f=e,g=e*0.8,h=e*0.88,i,j=1,m,k,p=5+a;i=g*1.2+e+e*(this.unicode?3.3:1)*0.7;k=this.params.scientific||this.params.calculate?e*2.65:this.params.numbers?e*1.75:this.params.w?this.params.w*window.innerWidth:e*10.5;this.div.resize({x:p+e*0.1,y:d+e*0.96,w:k+e*0.8,h:e*(this.unicode?
3.3:1)*0.57});this.layer.resize({x:a,y:d,w:k+e*1.3,h:e*(this.nRows+(this.params.scientific?0.3:-0.05))});j=p;f=f*0.9;m=(f/2.2|0)+"px";this.div.div.style.fontSize=m;this.closeB.background.col="#222222";this.closeB.resize({x:k+e*0.2,y:e*0.1,w:e*0.8,h:f*0.8});this.closeB.render();if(this.unicode){this.kbSel.style.fontSize=m;this.selDiv.div.style.fontSize=m;this.prvUni.resize({x:j,y:i-e*0.85,w:e*0.8,h:f*0.8});this.prvUni.render();j=j+e;this.kbSel.style.left=j+e*0.2+"px";this.kbSel.style.top=d+e*2.6+"px";
j=j+e*4.5;this.nxtUni.resize({x:j,y:i-e*0.85,w:e*0.8,h:f*0.8});this.nxtUni.render();j-a>k&&(k=j-a)}else i=i-e;j-a>k&&(k=j-a+e);p=p-parseInt(b.layer.canvas.style.left);j=p-3;if(this.sciBs)for(d=0;d<this.sciBs.length;d++){this.sciBs[d].resize({x:j,y:i,w:e*2.07,h:f});this.sciBs[d].render();j-a+e>k&&(k=j-a+e);j=j+h*2;if(d%2===1){j=p-3;i=i+g}}j=p;for(d=0;d<this.keys.length/2;d++){for(m=this.newLs.length;m--;)if(d===this.newLs[m]){j=p;i=i+g}this.kb[d].resize({x:j,y:i,w:e,h:f});if(this.params.scientific){if(this.kb[d].background&&
d%4!==3)this.kb[d].background.col="#bbb"}else if(this.kb[d].background)this.kb[d].background.col="#bbb";this.kb[d].render();j-a>k&&(k=j-a);j=j+h}for(d=0;d<this.specBs.length;d++){this.specBs[d].resize({x:j,y:i,w:e,h:f});this.specBs[d].background.col="#111111";this.specBs[d].render();j-a>k&&(k=j-a-e/3);j=j+h}i=i+g;if(this.space){j=p+e*3;this.space.resize({x:j,y:i,w:e*4,h:f});this.space.render();j=j+e*3.1;j-a>k&&(k=j-a)}else j=p;if(this.clearB){this.params.keys&&(j=k-h*2);this.clearB.resize({x:j+h,
y:i-(this.params.scientific?0:g),w:e,h:f});this.clearB.render();j=j+h}if(this.okB){this.okB.background.col="#222222";if(this.params.scientific){j=j-h;this.okB.resize({x:j,y:i,w:e,h:f});j=j+h*2}else{this.okB.resize({x:j+h,y:i-g,w:e,h:f});j=j+h}this.okB.render()}if(this.cancelB){this.cancelB.background.col="#222222";this.cancelB.resize({x:j-e*0.1,y:i,w:e*2.1,h:f});this.cancelB.render()}j-a>k&&(k=j-a+e);i=i+g;j=p;for(d=0;d<this.extraBs.length;d++){this.extraBs[d].resize({x:j,y:i,w:e*2.6,h:f*0.97});this.extraBs[d].render();
j-a>k&&(k=j-a+e);j=j+(h*2.5+3)}this.layer.canvas.style.border="solid 1px #ccc";this.layer.canvas.style.background="#6f7072";this.layer.canvas.style.borderRadius="4px";this.setVisible(false)};OU.util.Keyboard.prototype.remove=function(){this.layer.remove();this.selDiv.remove();this.div.remove()};this.init(a)};
OU.util.Keypad=function(a){var b=this;this.inputField=a.inputField;a.x=a.x||0.01;a.y=a.y||0.01;a.w=a.w||0.7;a.h=a.h||0.7;a.numbers=a.calculate=a.scientific=!1;switch(a.type){default:case "numeric":a.numbers=!0;break;case "calculator":a.calculate=!0;break;case "scientific":a.calculate=!0,a.scientific=!0}a.unicode=!1;a.ok=!0;a.space=!1;a.specials=!1;a.background="#fcfcfc";a.formatting=!1;a.zIndex=a.container.zOffset+OU.OVERLAY_CONTROLLER_LEVEL;a.ok=!0;a.okFn=function(){b.inputField.value=b.keyboard.div.div.innerHTML;
b.keyboard.remove();b.keyboard=void 0};this.keyboardParams=a;this.startFn=function(a){a.preventDefault();void 0===b.keyboard&&(b.keyboard=new OU.util.Keyboard(b.keyboardParams),b.keyboard.div.div.innerHTML=b.keyboard.html=b.inputField.value,b.keyboard.resize(),b.keyboard.setVisible(!0))};this.inputField.addEventListener("mousedown",this.startFn,!1,0,!0);this.inputField.addEventListener("dblclick",this.startFn,!1,0,!0);this.inputField.addEventListener("touchstart",this.startFn,!1,0,!0);OU.util.Keypad.prototype.resize=
function(){};OU.util.Keypad.prototype.remove=function(){this.inputField.removeEventListener("mousedown",this.startFn);this.inputField.removeEventListener("mdblclick",this.startFn);this.inputField.removeEventListener("touchstart",this.startFn)}};
OU.util.Layer=function(a){a=a||{};this.container=a.container||{};this.events=this.context=this.canvas=null;this._zIndex=void 0===a.zIndex?OU.DATA_LEVEL:a.zIndex;this.zOffset=this.container.zOffset||0;this._zIndex+=this.zOffset;this.addCanvas(a);a.hasEvents&&(this.events=new OU.util.Events({target:this.canvas,pinch:a.pinch,pinchMe:a.pinchMe,keyPress:a.keyPress}));void 0===a.dontRegister&&OU.addRemovable(this,this.zOffset)};
OU.util.Layer.prototype.resize=function(a){this.move(this.getDims(a));this.context.textBaseline="middle"};OU.util.Layer.prototype.move=function(a){this.x=void 0===a.x?this.x:a.x;this.y=void 0===a.y?this.y:a.y;this.w=a.w||this.w;this.h=a.h||this.h;this.canvas.setAttribute("style","left:"+this.x+"px; top:"+this.y+"px;");a.h&&this.canvas.setAttribute("height",this.h);a.w&&this.canvas.setAttribute("width",this.w);this._zIndex&&(this.canvas.style.zIndex=this._zIndex);this.context.textBaseline="middle"};
OU.util.Layer.prototype.slideTo=function(a){this.slideTargetX=void 0===a.x?this.x:a.x;this.slideTargetY=void 0===a.y?this.y:a.y;void 0===this.moving&&(this.moving=!0,this.animate())};
OU.util.Layer.prototype.animate=function(){var a=this,b={x:this.x+(this.slideTargetX-this.x)/8|0,y:this.y+(this.slideTargetY-this.y)/8|0};this.canvas&&(2<Math.abs(this.x-this.slideTargetX)||2<Math.abs(this.y-this.slideTargetY)?(this.move(b),setTimeout(function(){a.animate()},40)):(this.move({x:this.slideTargetX,y:this.slideTargetY}),this.moving=void 0))};
OU.util.Layer.prototype.getDims=function(a){a=a||{};return{x:void 0===a.x?this.container.x||0:a.x,y:void 0===a.y?this.container.y||0:a.y,w:a.w||this.container.w||window.innerWidth||480,h:a.h||this.container.h||window.innerHeight||360}};
OU.util.Layer.prototype.addCanvas=function(a){var a=a||{},b=this.container,c=this.getDims(a),d=c.x,e=c.y,f=c.w,c=c.h,g=b.instance||"";this.id=a.id||"";this.canvas=document.createElement("canvas");this.canvas.setAttribute("id",g+this.id);this.canvas.setAttribute("style","left:"+d+"px; top:"+e+"px;");this.canvas.setAttribute("height",c);this.canvas.setAttribute("width",f);void 0!==a.themeClass&&this.canvas.setAttribute("class",a.themeClass);this._zIndex&&(this.canvas.style.zIndex=this._zIndex);void 0===
a.insertInside&&(a.insertInside=document.body);this.parentNode=a.insertInside;void 0!==a.beforeDiv?a.insertInside.insertBefore(this.canvas,document.getElementById(a.beforeDiv)):a.insertInside.appendChild(this.canvas);this.context=this.canvas.getContext("2d");this.context.lineWidth=0.75;this.context.textBaseline="middle";OU.closeButton(b);this.x=d;this.y=e;this.w=f;this.h=c};OU.util.Layer.prototype.opacity=function(a){this.canvas.style.opacity=a};
OU.util.Layer.prototype.zIndex=function(a){this._zIndex=a;this.canvas.style.zIndex=a};OU.util.Layer.prototype.clear=function(a,b,c,d){this.context&&this.context.clearRect(a||0,b||0,c||this.w,d||this.h)};OU.util.Layer.prototype.remove=function(){this.events&&this.events.remove();this.canvas&&this.parentNode&&this.parentNode.removeChild(this.canvas);delete this.canvas;delete this.context;delete this.events;this.container=this.context=this.canvas=null};
OU.util.Menu=function(a){this.menus=a.menus;this.container=a.container;this.controller=a.container.controller;this.register=a.dontRegister||!1;this.x=a.x||this.container.x||0;this.y=a.y||this.container.y||0;this.w=a.w||this.container.w;this.h=a.h||this.container.h;this.showHighlight=!1===a.showHighlight?!1:!0;this.style=this.menus.style||"horizontal";this.shadow=this.menus.shadow||!1;this.title=a.title||"";this.zIndex=a.zIndex||OU.CONTROLLER_LEVEL-1;this.Anchors=[];OU.util.Menu.prototype.init=function(){var b=
this.menus,a,d=this.menus.autoLoad;this.menuId=OU.menus.length;OU.menus[this.menuId]=this;this.menuDiv=new OU.util.Div({dontRegister:this.register,x:this.x,y:this.y,w:this.w,h:"auto",zIndex:this.zIndex,container:this.container,showScroll:!1});OU.nobbleDoneBar(this.menuDiv.div);b.selected=[];for(a=b.levels;a--;)b.selected[a]=OU.LocalStorage.load("ou.menus."+this.container.instance+"."+this.menuId+"._"+a)||0;this.render(0==this.menuId&&d)};OU.util.Menu.prototype.removeAnchors=function(){var b;for(b=
this.Anchors.length;b--;)this.Anchors[b].remove();this.Anchors=[]};OU.util.Menu.prototype.remove=function(){this.removed=!0;this.removeAnchors()};OU.util.Menu.prototype.resize=function(b){this.x=b.x||this.container.x||0;this.y=b.y||this.container.y||0;this.w=b.w||this.container.w;this.h=b.h||this.container.h;this.menuDiv.resize({x:this.x,y:this.y,w:this.w,h:"auto"})};OU.util.Menu.prototype.render=function(b){var a=this.menus,d=OU.controlHeight,e,f,g,h=a,i,j,m=this,k;if(!this.removed){j=function(){var b=
this.getAttribute("id").split("."),a=b.length;m.step(parseInt(b[a-2]),parseInt(b[a-1]))};this.removeAnchors();this.menuDiv.div.innerHTML="";for(e=0;e<a.levels;e++){k=document.createElement("div");k.setAttribute("style","height: "+d+"px");this.menuDiv.div.appendChild(k);""!=this.title&&(k.innerHTML="<strong>"+this.title+"</strong><br/>");for(f=0;f<h.sections.length;f++)i=h.sections[f],"button"==i.type?(g=i,i=i.step==parseInt(h.selected[0])+1&&this.showHighlight?"_abutton highlighted":"_abutton",this.Anchors.push(new OU.util.Anchor({container:this.container,
parent:k,classes:i,id:"ou.menu."+this.menuId+"."+e+"."+f,tabIndex:20*e+f+10,txt:g.title,img:g.img,onClick:j})),"vertical"==this.style&&(i=document.createElement("br"),i.setAttribute("clear","left"),k.appendChild(i)),b&&f==a.selected[e]&&void 0===g.menu&&this.loadContent(g)):(g=document.createElement(i.type),g.innerHTML=i.content,k.appendChild(g));h=h.sections[a.selected[e]].menu;void 0===h&&(e=a.levels)}}};OU.util.Menu.prototype.loadContent=function(b){void 0!==b.step&&this.container.controller.step(b.step);
void 0!==b.controller&&this.container.controller.overrideSection(b.controller);void 0!==b.activityPopup&&this.container.controller.addActivity(b.activityPopup)};OU.util.Menu.prototype.step=function(b,a){var d=this.menus,e,f,g;d.selected[b]=a;e=d;for(f=0;f<d.levels;f++)d.selected[f]>e.sections.length-1&&(d.selected[f]=e.sections.length-1),g=e.sections[d.selected[f]],void 0===g.menu?this.loadContent(g):e=g.menu;this.render(!1);for(f=d.levels;f--;)OU.LocalStorage.save("ou.menus."+this.container.instance+
"."+this.menuId+"._"+f,d.selected[f])};this.init()};
OU.util.Messagebox=function(a){var b=this;void 0===a&&(a={});this.container=a.container||{};this.zIndexStart=a.zIndex||OU.POP_UP_LEVEL;this.zOffset=this.container.zOffset||0;this.zIndexStart=this.zIndexStart+this.zOffset+10;void 0!==this.container.controller&&void 0!==this.container.controller.activities&&void 0!==this.container.controller.activities[this.container.instance]&&void 0!==this.container.controller.activities[this.container.instance]._zOffset?(this.zOffset=this.container.controller.activities[this.container.instance]._zOffset,
this.zIndexStart+=this.zOffset):this.zOffset=this.zIndexStart;this.params=a;this.dims=a.dims||{x:0.1,y:0.1,w:0.4,h:0.4};this.style=a.style||"";this.addStyle="";void 0!==a.overflow&&(this.addStyle="overflow:"+a.overflow+"; ");OU.util.Messagebox.prototype.init=function(a){this.isWeb=0;a===void 0&&(a={dims:{}});var d=a.dims.y||0,e=a.dims.w*1||480,f=a.dims.h||360;this._x=a.dims.x||0;this._y=d;this._w=e;this._h=f;(a.dontRegister===void 0||a.dontRegister===false)&&OU.addRemovable(this,this.zOffset);this.layer=
new OU.util.Layer({container:this.container,hasEvents:true,zIndex:this.zIndexStart});this.div=new OU.util.Div({container:this.container,zIndex:this.zIndexStart,style:"padding:12px;overflow:visible;"});this.div.div.innerHTML=a.html||"";this.yes=this.newButton("Yes",null,function(){b.fn();b.setVisible(false)});this.no=this.newButton("No",null,function(){b.setVisible(false)});this.setVisible(false)};OU.util.Messagebox.prototype.confirm=function(b,a){this.div.div.innerHTML=b;this.setVisible(true);this.fn=
a};OU.util.Messagebox.prototype.render=function(){};OU.util.Messagebox.prototype.newButton=function(a,d,e){var f;if(a.indexOf("_ <sup>_")>0)f={render:function(){},resize:function(){},setTxt:function(){}};else{var g,h=e||function(){};if(this.isWeb){g=this.div.div;f=document.createElement("a");f.th=[this,d];f.onclick=function(){h(this.th)};f.href="javascript:;";f.setAttribute("style","position:absolute;top:10px;left:20px; font-size:90%;text-align:center;background:#efefef;border:solid 1px;border-radius:3px;text-decoration:none;");
f.style.zIndex=this.zIndexStart+10;f.render=function(){};f.resize=function(a){this.style.left=""+(parseInt(b.layer.canvas.style.left)+a.x|0)+"px";this.style.top=""+(parseInt(b.layer.canvas.style.top)+a.y|0)+"px";this.style.height=""+(a.h*0.7|0)+"px";this.style.width=""+(a.w*0.7|0)+"px";this.style.fontSize=""+(a.h/2.3|0)+"px"};g.appendChild(f);f.style.padding="0px";f.style.paddingTop="0.5%"}else{f=new OU.util.Button({txt:a,layer:this.layer,background:{col:"#dddddd",radius:2,borderCol:"#999999"},onClick:e,
onClickParam:[this,d]});f.th=[this,d];f.params.onClick=function(){e(this.th)}}f.setTxt=function(b){if(this.params){this.params.txt=b;this.render()}else if(this.th)this.innerHTML=b};f.setTxt(a)}return f};OU.util.Messagebox.prototype.setVisible=function(b,a){var e=(this.visible=b)?"block":"none";if(b&&a!==void 0){this.html=a;this.div.div.innerHTML=a}this.layer.canvas.style.display=e;this.div.div.style.display=e;this.resize()};OU.util.Messagebox.prototype.resize=function(){if(this.visible){var b=window.innerWidth,
a=window.innerHeight,e=b*this._x,f=a*this._y,b=b*this._w,a=a*this._h;this.div.resize({x:e,y:f,w:b,h:0.01});this.layer.resize({x:e,y:f,w:b,h:a});this.yes.resize({x:b*0.1,y:a-50,w:b*0.35});this.yes.render();this.no.resize({x:b*0.6,y:a-50,w:b*0.35});this.no.render();this.layer.canvas.style.background="#fcfcfc";this.layer.canvas.style.border="solid 1px #999";this.layer.canvas.style.borderRadius="8px"}};OU.util.Messagebox.prototype.remove=function(){this.div.parentNode&&this.div.parentNode.removeChild(this.div)};
this.init(a)};
OU.util.NavButtons=function(a){this.x=a.x||0;this.y=a.y||0;this.w=a.w||400;this.h=a.h||60;this.bw=a.bw||this.h;this.pad=a.pad||0;this.context=a.context;this.layer=a.layer;this.leftFunc=a.leftFunc||function(){};this.rightFunc=a.rightFunc||function(){};this.leftOn=void 0===a.leftOn?!0:a.leftOn;this.rightOn=void 0===a.rightOn?!0:a.rightOn;OU.util.NavButtons.prototype.render=function(){this.context.clearRect(this.x,this.y,this.w,this.h);this.leftOn?this.leftButton?this.leftButton.render():this.leftButton=
new OU.util.PrevButton({x:this.x+this.pad,y:this.y+this.pad,w:this.bw-2*this.pad,h:this.h-2*this.pad,tabIndex:10,layer:this.layer,onClick:this.leftFunc}):this.leftButton&&(this.leftButton.remove(),this.leftButton=null);this.rightOn?this.rightButton?this.rightButton.render():this.rightButton=new OU.util.NextButton({x:this.x+this.w-this.bw+this.pad,y:this.y+this.pad,w:this.bw-2*this.pad,h:this.h-2*this.pad,tabIndex:20,layer:this.layer,onClick:this.rightFunc}):this.rightButton&&(this.rightButton.remove(),
this.rightButton=null)};OU.util.NavButtons.prototype.move=function(b){this.x=b.x||this.x;this.y=b.y||this.y;this.w=b.w||this.w;this.h=b.h||this.h;this.leftButton&&this.leftButton.resize({x:this.x+this.pad,y:this.y+this.pad,w:this.bw-2*this.pad,h:this.h-2*this.pad});this.rightButton&&this.rightButton.resize({x:this.x+this.w-this.bw+this.pad,y:this.y+this.pad,w:this.bw-2*this.pad,h:this.h-2*this.pad})}};
OU.util.PopUpInfo=function(a){var b=this;this.container=a.container||this;this.zIndex=(a.zIndex||OU.POP_UP_LEVEL)-1;this.layer=new OU.util.Layer({container:this.container,hasEvents:!0,id:"popup",zIndex:this.zIndex});this.context=this.layer.context;this.events=this.layer.events;this.events.clickable.push(this);this.onClose=a.onClose;this.txt=a.txt||"";this.w=a.w||0.8*this.context.canvas.width;this.h=a.h||0.8*this.context.canvas.height;this.x=a.x||0.1*this.context.canvas.width;this.y=a.y||0.1*this.context.canvas.height;
this.render();window.addEventListener("keydown",this.listener=function(a){b.keyPress(a)},!1,0,!0)};OU.util.PopUpInfo.prototype.keyPress=function(a){var b=null;window.event?b=window.event.keyCode:a&&(b=a.which||a.keyCode);27==b&&this.remove()};
OU.util.PopUpInfo.prototype.render=function(){var a,b=this.context,c=0.025*this.w,c=15<c?15:c;b.save();b.fillStyle="rgba(0,0,0,0.3)";b.fillRect(this.x+10,this.y+10,this.w,this.h);b.restore();a=b.createLinearGradient(this.x,this.y,this.x,this.y+this.h);a.addColorStop(0,"#afdae7");a.addColorStop(0.41,"#bedfe9");a.addColorStop(1,"#98ccdb");b.background({RGB:"235,244,251",borderCol:"#666",gradient:a},{x:this.x,y:this.y,w:this.w,h:this.h});b.save();b.strokeStyle="rgba(255,255,255,0.3)";b.beginPath();b.moveTo(this.x+
this.w,this.y+1);b.lineTo(this.x+1,this.y);b.lineTo(this.x+1,this.y+this.h-1);b.stroke();b.strokeStyle="rgba(0,0,0,0.3)";b.beginPath();b.moveTo(this.x+1,this.y+this.h-1);b.lineTo(this.x+this.w-1,this.y+this.h-1);b.lineTo(this.x+this.w-1,this.y+1);b.stroke();b.closeIcon({x:this.x+this.w-2*c,y:this.y+c/2,r:c});this.htmlDiv=new OU.util.Div({container:this.container,innerHTML:this.txt,zIndex:this.zIndex+1,style:"padding: 0 20px;",overflow:"auto",x:this.container.x+this.x|0,y:this.container.y+this.y+2*
c|0,w:this.w-20|0,h:this.h-2*c-10|0})};OU.util.PopUpInfo.prototype.remove=OU.util.PopUpInfo.prototype.close=function(){if(0<this.events.clickable.length&&(this.events.clickable.length=0,this.htmlDiv.remove(),this.layer.remove(),this.htmlDiv=this.layer=null,window.removeEventListener("keydown",this.listener),this.onClose))this.onClose()};
OU.util.PopUpInfo.prototype.resize=function(a){var b=0.025*this.w,b=15<b?15:b;this.w=a.w||0.8*this.context.canvas.width;this.h=a.h||0.8*this.context.canvas.height;this.x=a.x||0.1*this.context.canvas.width;this.y=a.y||0.1*this.context.canvas.height;this.htmlDiv.resize({x:this.container.x+this.x,y:this.container.y+this.y+2*b,w:this.w-20,h:this.h-2*b-10})};
OU.util.PopUpInfo.prototype.isHit=function(a,b){if(this.events.pressed||this.events.touched)a<this.x+0.9*this.w||a>this.x+this.w||b<this.y||b>this.y+this.h||this.remove()};
OU.util.ScrubBar=function(a){this.params=a;this.x=a.x||0;this.y=a.y||0;this.w=a.w||0;this.h=a.h||0;this.context=a.context;this.sliderX=0;this.sliderWidth=20;this.sliderSpeed=4;this.numPoints=a.points;this.currentPoint=0;this.highlightColour=a.highlightColour||"rgba(41,171,225,1)";void 0!==a.startPos&&(this.currentPoint=a.startPos);this.labels=a.labels;this.labelHeight=a.labelHeight||0;this.newPointFunc=a.newPointFunc||function(){};this.callbackParam=a.callbackParam;this.resize(a)};
OU.util.ScrubBar.prototype.newTarget=function(a){this.currentPoint=a;this.targetX=a*this.pointWidth};OU.util.ScrubBar.prototype.resize=function(a){this.context.clearRect(this.x,this.y,this.w,this.h);this.x=a.x||this.x||0;this.y=a.y||this.y||0;this.w=a.w||this.w||0;this.h=a.h||this.h||0;this.lineStart=this.x+this.sliderWidth/2;this.lineEnd=this.x+this.w-this.sliderWidth/2;this.pointWidth=(this.lineEnd-this.lineStart)/(this.numPoints-1);this.targetX=this.currentPoint*this.pointWidth;this.render()};
OU.util.ScrubBar.prototype.render=function(){var a,b=this.y+this.labelHeight,c=this.h-this.labelHeight,d,e=100;this.params.background&&this.context.background(this.params.background,this);this.sliderX!==this.targetX&&(this.sliderX+=(this.targetX-this.sliderX)/this.sliderSpeed);this.context.strokeStyle="#666";this.context.beginPath();this.context.moveTo(this.lineStart,b+c/2);this.context.lineTo(this.lineEnd,b+c/2);this.context.stroke();if(this.labels)for(a=this.numPoints;a--;)this.labels[a]&&(d=new OU.util.DynText({context:this.context,
txt:this.labels[a],x:this.lineStart+this.pointWidth*a-this.pointWidth/2+5,y:this.y+0.1*this.labelHeight,w:this.pointWidth-10,h:0.8*this.labelHeight,fontSize:e,measureOnly:!0,padding:0.1*this.pointWidth,autoWidth:!0,autoCentre:!0}),d.font.size<e&&(e=d.font.size));for(a=this.numPoints;a--;)this.context.beginPath(),this.context.moveTo(this.lineStart+this.pointWidth*a,b+3*c/8),this.context.lineTo(this.lineStart+this.pointWidth*a,b+5*c/8),this.context.stroke(),this.labels&&this.labels[a]&&(d=this.currentPoint===
a?{radius:this.labelHeight/4,col:this.highlightColour}:null,new OU.util.DynText({context:this.context,txt:this.labels[a],x:this.lineStart+this.pointWidth*a-this.pointWidth/2+5,y:this.y+0.1*this.labelHeight,w:this.pointWidth-10,h:0.8*this.labelHeight,fontSize:e,background:d,padding:0.1*this.pointWidth,autoWidth:!0,autoCentre:!0}));this.context.roundRect(this.x+this.sliderX,b+c/4,this.sliderWidth,c/2,this.sliderWidth/2);this.context.fillStyle="rgba( 144, 144, 144, 0.5 )";this.context.strokeStyle="#000";
this.context.fill();this.context.stroke()};OU.util.ScrubBar.prototype.isHit=function(a,b,c){c&&a>this.x&&a<this.x+this.w&&b>this.y&&b<this.y+this.h&&(this.sliderX=a-this.x-this.sliderWidth/2,a=(a-this.lineStart)/this.pointWidth+0.5|0,a!==this.currentPoint&&(this.currentPoint=a,this.newTarget(a),this.newPointFunc(a,this.callbackParam)))};
OU.util.Slider=function(a){this.params=a;this.context=a.context;this.frames=OU.IS_IPAD?2:5;this.x=a.x||0;this.y=a.y||0;this.w=a.w||100;this.h=a.h||20;this.titlePosition=a.titlePosition;this.valueUnits=a.valueUnits;this.scrubX=this.x+this.w/10;this.scrubY=this.y+this.h/2;this.scrubWidth=a.scrubWidth||this.w-2*(this.w/10);this.callback=a.callback||function(){};this.callbackParam=a.callbackParam||void 0;this.sliderStyle=a.sliderStyle||"circle";this.sliderHeight=a.sliderHeight||0.95*this.h;this.sliderWidth=
this.sliderHeight/2;this.orient=a.orientation||"horizontal";this.sliderPos=a.sliderPos||0;this.target=a.sliderPos||0;this.title=a.title;this.disabled=this.halted=!1;this.showValue=a.showValue||!1;this.range=a.range||{},this.range.dx=this.range.max-this.range.min;this.container=a.container||{};OU.addRemovable(this,this.container.zOffset||0);void 0===a.background&&(this.params.background="horizontal"===this.orient?"#CCCCCC":"rgba(26,26,26,0.9)");OU.util.Slider.prototype.hit=function(){this.onClick(this.onClickParam);
return false};OU.util.Slider.prototype.focus=function(){this.hasFocus=true;this.render();return false};OU.util.Slider.prototype.blur=function(){this.hasFocus=void 0;this.render();return false};OU.util.Slider.prototype.remove=function(){OU.util.Slider.superClass_.remove.call(this);OU.removables.removeType(this.instanceId);this.halted=true};OU.util.Slider.prototype.resize=function(b){this.x=b.x||this.x;this.y=b.y||this.y;this.w=b.w||this.w;this.h=b.h||this.h;this.scrubX=this.x+this.w/10;this.scrubY=
this.y+this.h/2;this.scrubWidth=this.w-2*(this.w/10)};OU.util.Slider.prototype.render=function(b){this.sliderPos=b===void 0?this.sliderPos:b;this.sliderPos=this.sliderPos>1?1:this.sliderPos;this.sliderPos=this.sliderPos<0?0:this.sliderPos;this.params.background!==void 0&&this.context.background(this.params.background,this);this.orient==="vertical"?this.renderVertical():this.renderHorizontal()};OU.util.Slider.prototype.renderVertical=function(){var b=this.x+this.w/2,a=this.y+this.h*0.1,d=this.y+this.h*
0.9,e=a+(d-a)/2,f=this.w/4,g=this.w/2,h=this.context,i=Math.PI*2,j=g/10;h.save();if(this.disabled)h.globalAlpha=1;if(this.hasFocus){h.fillStyle="#c00";h.roundRect(this.x+2,this.y+2,this.w-4,this.h-4,5)}else{h.fillStyle="#ccc";h.roundRect(this.x,this.y,this.w,this.h,5)}h.fill();h.lineWidth=1;h.strokeStyle="#666";h.beginPath();h.moveTo(b-8*j,d+0.5);h.lineTo(b-4*j,d+0.5);h.moveTo(b+4*j,d+0.5);h.lineTo(b+8*j,d+0.5);h.moveTo(b-8*j,e+0.5);h.lineTo(b-6*j,e+0.5);h.moveTo(b+6*j,e+0.5);h.lineTo(b+8*j,e+0.5);
h.moveTo(b-8*j,a+0.5);h.lineTo(b-4*j,a+0.5);h.moveTo(b+4*j,a+0.5);h.lineTo(b+8*j,a+0.5);h.closePath();h.stroke();h.strokeStyle="#fff";h.beginPath();h.moveTo(b-0.5,a);h.lineTo(b-0.5,d);h.closePath();h.stroke();h.restore();h.save();if(this.disabled)h.globalAlpha=0.25;if(this.sliderStyle==="circle"){h.save();h.fillStyle="#ccc";h.strokeStyle="#000";h.beginPath();h.arc(b,d-this.sliderPos*(d-a),this.w/6,0,i,false);h.fill();h.closePath();h.restore();h.fillStyle="#556688";h.beginPath();h.arc(b,d-this.sliderPos*
(d-a),this.w/10,0,i,false);h.fill();h.fillStyle="#ffffff";h.beginPath();h.arc(b,d-this.sliderPos*(d-a),this.w/24,0,i,false)}else{h.fillStyle="rgba( 144, 144, 144, 0.8 )";h.strokeStyle="#000";h.roundRect(b-g/2,d-f/2-this.sliderPos*this.h*0.8,g,f,f/2);h.stroke()}h.fill();h.restore()};OU.util.Slider.prototype.renderHorizontal=function(){var b=this.x+this.w*0.1,a=this.x+this.w*0.9,d=this.y+this.h/2,e=this.h/2-2,f=this.sliderWidth,g=this.context,h=Math.PI*2,i=e/10;g.save();g.fillStyle="#CCCCCC";if(this.params.background.color!==
void 0)g.fillStyle=this.params.background.color;if(this.params.background.RGB)g.fillStyle=this.params.background.alpha?"rgba("+this.params.background.RGB+","+this.params.background.alpha+")":"rgba("+this.params.background.RGB+",1)";if(this.hasFocus)g.fillStyle="#c00";if(this.params.drawContainer!==false||this.hasFocus){g.roundRect(b-f+1,d-e+1,a-b+f*2-2,e*2-2,3);g.fill()}else g.clearRect(b-f,d-e,a-b+f*2,e*2);if(this.disabled)g.globalAlpha=0.5;g.lineWidth=1;g.strokeStyle="#888";g.beginPath();g.moveTo(b+
0.5,d-8*i);g.lineTo(b+0.5,d-4*i);g.moveTo(b+0.5,d+8*i);g.lineTo(b+0.5,d+4*i);g.moveTo(a+0.5,d-8*i);g.lineTo(a+0.5,d-4*i);g.moveTo(a+0.5,d+8*i);g.lineTo(a+0.5,d+4*i);g.moveTo(b+0.5,d);g.lineTo(a,d);g.closePath();g.stroke();if(this.disabled)g.globalAlpha=0.25;if(this.sliderStyle==="circle"){g.save();g.fillStyle="#333333";g.strokeStyle="#333333";g.beginPath();g.arc(b+this.sliderPos*(a-b),d,this.h/4,0,h,false);g.fill();g.closePath();g.restore();g.fillStyle="#888888";g.beginPath();g.arc(b+this.sliderPos*
(a-b),d,this.h/8,0,h,false);g.fill();g.fillStyle="#ffffff";g.beginPath();g.arc(b+this.sliderPos*(a-b),d,this.h/16,0,h,false)}else{g.roundRect(b-f/2+this.sliderPos*(a-b),d-e/2,f,e,f/2);g.fillStyle="rgba( 144, 144, 144, 0.8 )";g.strokeStyle="#000";g.stroke()}g.fill();g.restore();if(this.title||this.showValue){g.save();g.font=this.h/2+"px "+OU.theme.font;this.title&&(this.titlePosition==="above"?new OU.util.DynText({context:g,txt:this.title,notDynamic:true,fontSize:this.h*0.4,x:this.x+this.w*0.05,y:this.y,
w:this.scrubWidth,h:this.h/2,align:"left",padding:0}):new OU.util.DynText({context:g,txt:this.title,notDynamic:true,fontSize:this.h*0.4,x:this.x,y:this.y,w:this.w*0.1,h:this.h}));if(this.showValue){b=this.range.min+this.sliderPos*this.range.dx;b=b.nDecimals(this.range.nDecimals===void 0?3:this.range.nDecimals);this.valueUnits!==void 0&&(b=b+this.valueUnits);new OU.util.DynText({context:g,notDynamic:true,fontSize:this.h*0.4,align:"left",txt:b,x:this.scrubX+this.scrubWidth*1.05,y:this.y,w:this.w*0.3,
h:this.h})}g.restore()}};OU.util.Slider.prototype.animate=function(){var b=this;if(!this.halted&&Math.abs(this.sliderPos-this.target)>1.0E-4){this.sliderPos=this.sliderPos+(this.target-this.sliderPos)/this.frames;this.callback(this.sliderPos,this.callbackParam);setTimeout(function(){b.animate()},40)}else{if(this.sliderPos!==this.target){this.sliderPos=this.target;this.callback(this.sliderPos,this.callbackParam)}this.halted=false}};OU.util.Slider.prototype.isHit=function(b,a,d){if(this.disabled===
false&&d&&a>this.y&&a<this.y+this.h&&b>this.x&&b<this.x+this.w){this.target=this.orient==="vertical"?(this.y+this.h*0.9-a)/(this.h*0.8):(b-this.scrubX)/this.scrubWidth;if(this.target<0)this.target=0;if(this.target>1)this.target=1;this.halted=false;this.animate()}};OU.util.Slider.prototype.arrowKey=function(b){if(this.disabled)return false;if(b===38||b===39)this.target=this.sliderPos+0.1;if(b===37||b===40)this.target=this.sliderPos-0.1;if(this.target<0)this.target=0;if(this.target>1)this.target=1;
this.halted=false;this.animate();return true};OU.util.Slider.prototype.setTarget=function(b){this.target=b;this.halted=false;this.animate()};OU.base(this,a)};OU.inherits(OU.util.Slider,OU.util.Tabbable);
OU.util.Slideshow=function(a){this.container=a.container;this.context=a.context;this.x=a.x||0;this.y=a.y||0;this.w=a.w||this.container.w;this.h=a.h||this.container.h;this.images=a.images;this.numImages=this.images.length;this.shownImage=a.startImage||0;OU.util.Slideshow.prototype.resize=function(b){var a,b=b||{};this.x=b.x||this.x;this.y=b.y||this.y;this.w=b.w||this.w;this.h=b.h||this.h;this.maxW=this.maxH=0;for(b=this.numImages;b--;)if(a=this.images[b],void 0!==a.image)if(a.w=a.image.width,a.h=a.image.height,
a.w>this.w&&(a.h*=this.w/a.w,a.w=this.w),a.h>this.h&&(a.w*=this.h/a.h,a.h=this.h),a.x=this.x+(this.w-a.w)/2,a.y=this.y+(this.h-a.h)/2,a.w>this.maxW&&(this.maxW=a.w),a.h>this.maxH)this.maxH=a.h;this.render()};OU.util.Slideshow.prototype.render=function(){var a=this.images[this.shownImage];void 0!==a.image&&(this.context.clearRect(this.x,this.y,this.w,this.h),this.context.drawImage(a.image,a.x,a.y,a.w,a.h))};OU.util.Slideshow.prototype.move=function(a){this.shownImage=a;this.render()};this.resize()};
OU.util.Spinner=function(a){void 0===a.context?alert("Incorrect use of Spinner Object - Context Required"):(this.instance="spinner",this.params=a,this.x=a.x||1,this.x=0>this.x?1:this.x,this.y=a.y||0,this.w=a.w||200,this.h=a.h||100,this.spinnerLayer=new OU.util.Layer({container:a.container,hasEvents:!0,instance:this.instance}),this.context=this.spinnerLayer.context,this.layer=this.spinnerLayer,this.maxH=a.maxH||100,this.font=a.font||20,this.execute=a.execute||null,this.min=a.min||1,this.max=a.max||
20,this.currentVal=a.currentVal||1,this.feather=a.feather||50,this.yO=0,this.bounceBack=this.animationstop=this.doanimation=this.flicked=this.touchReady=this.touched=this.displayed=!1,this.cur=this.currentVal,this.context.font=this.font.size+"px "+OU.theme.font,this.tripWidth=this.context.measureText(this.max).width,this.nudge=0.1*this.font.size,this.xOffset=50,this.sizeRegulator=4.4631,this.font.size*this.sizeRegulator>this.maxH&&(this.font.size=this.maxH/this.sizeRegulator),this.bigBox={w:1.629*
this.tripWidth,h:4.4631*this.font.size,x:this.xOffset+(0>this.x-1.629*this.tripWidth?1:this.x-1.629*this.tripWidth),y:this.y},this.inBox={w:this.bigBox.w-2*this.nudge,h:this.bigBox.h-2*this.nudge,x:this.nudge,y:this.nudge},this.lensBox={w:this.inBox.w,h:this.font.size+this.nudge,x:this.inBox.x,y:this.bigBox.h/2-this.font.size/2},this.touchBubble={x:this.bigBox.x-this.feather,y:this.bigBox.y-this.feather,w:this.bigBox.w+2*this.feather,h:this.bigBox.h+2*this.feather},this.innertouchBubble={x:this.bigBox.x+
this.inBox.x,y:this.bigBox.y+this.inBox.y,w:this.inBox.w,h:this.inBox.h},this.FrictionEpsilon=0.01,this.boxH=Math.floor(this.inBox.h/3),this.yO=-1*(this.cur-1)*Math.floor(this.boxH),this.noTouching=this.hold=this.closeTimer=0,this.virgin=!0,this.spinnerLayer.events.moveRight=function(){return null},this.spinnerLayer.events.moveLeft=function(){return null},this.onReturn=this.params.onReturn||function(){},this.cl1=["rgba(119,123,137,1)","rgba(49,55,77,1)","rgba(29,36,60,1)","rgba(33,34,41,1)"],this.cl2=
["#38393E","#F2F3F3","#ffffff","#D3D3D3"],this.cl3=["rgba(110,130,229,0.22)","rgba(110,130,229,0.36)","rgba(255,255,255,0.59)","rgba(110,130,229,0.43)","rgba(110,130,229,0.56)"],this.cl4=["rgba(28,28,28,0.75)","rgba(210,210,210,0.75)","#1F2335"],this.friction=0.97,this.doRender=!0,this.tutor=this.params.tutor||0,this.parent=this.params.parent||void 0,this.prevCur=this.d=0,this.buildGradients(),this.renderLoop(),this.called=0)};
OU.util.Spinner.prototype.buildGradients=function(){var a=this.context,b;void 0===this.gBig&&(b=a.createLinearGradient(this.bigBox.x,this.bigBox.y,this.bigBox.x,this.bigBox.y+this.bigBox.h),b.addColorStop(0,this.cl1[0]),b.addColorStop(0.5,this.cl1[1]),b.addColorStop(0.51,this.cl1[2]),b.addColorStop(1,this.cl1[3]),this.gBig=b);void 0===this.gWheel&&(b=a.createLinearGradient(this.inBox.x,this.inBox.y,this.inBox.x,this.inBox.y+this.inBox.h),b.addColorStop(0,this.cl2[0]),b.addColorStop(0.21,this.cl2[1]),
b.addColorStop(0.32,this.cl2[2]),b.addColorStop(0.47,this.cl2[3]),b.addColorStop(0.63,this.cl2[3]),b.addColorStop(0.68,this.cl2[2]),b.addColorStop(0.79,this.cl2[1]),b.addColorStop(1,this.cl2[0]),this.gWheel=b);void 0===this.gLens&&(a=a.createLinearGradient(this.lensBox.x,this.lensBox.y,this.lensBox.x,this.lensBox.y+this.lensBox.h),a.addColorStop(0,this.cl3[0]),a.addColorStop(0.49,this.cl3[1]),a.addColorStop(0.5,this.cl3[2]),a.addColorStop(0.51,this.cl3[3]),a.addColorStop(1,this.cl3[4]),this.gLens=
a)};
OU.util.Spinner.prototype.render=function(){var a=this.context,b,c,d,e,f=this.boxH/2,g=this.boxH,h,i=OU.dpr;a.font=this.font.size+"px "+this.font.family;c=this.gBig;d=this.gWheel;e=this.gLens;a.save();a.fillStyle=c;a.roundRect(this.bigBox.x,this.bigBox.y,this.bigBox.w,this.bigBox.h,5);a.fill();a.translate(this.bigBox.x,this.bigBox.y);a.fillStyle=d;a.strokeStyle="#778396";a.roundRect(this.inBox.x,this.inBox.y,this.inBox.w,this.inBox.h,5);a.save();a.translate(this.inBox.x,this.inBox.y);a.clip();a.stroke();
a.fill();a.strokeStyle="rgba(255,255,255,0.20)";a.lineWidth="1";a.strokeStyle="#ff0000";a.fillStyle="#1F2335";for(h=this.min;h<=this.max;h++)d=h,c=g+this.boxH*(h-1)+this.yO,c>-1*this.boxH&&c<4*this.boxH&&(b=a.measureText(d).width,b=(this.inBox.w-b)/2,c+f<this.boxH?(a.fillStyle=this.cl4[0],a.fillText(d,b,c+f+i),a.fillStyle=this.cl4[1],a.fillText(d,b,c+f-i)):c+f>=this.boxH&&c+f<this.boxH?(a.fillStyle=this.cl4[1],a.fillText(d,b+i,c+f),a.fillStyle=this.cl4[0],a.fillText(d,b-i,c+f)):(a.fillStyle=this.cl4[1],
a.fillText(d,b,c+f+i),a.fillStyle=this.cl4[0],a.fillText(d,b,c+f-i)),a.fillStyle=this.cl4[2],a.fillText(d,b,c+f));a.restore();a.strokeStyle="#778396";a.fillStyle=e;a.fillRect(this.lensBox.x,this.lensBox.y,this.lensBox.w,this.lensBox.h);a.strokeRect(this.lensBox.x,this.lensBox.y,this.lensBox.w,this.lensBox.h);a.restore();this.called+=1;this.touchReady=!0};OU.util.Spinner.prototype.removeSpinner=function(){this.doRender=!1;this.layer.remove()};
OU.util.Spinner.prototype.returnValue=function(){var a=this.cur;this.removeSpinner();this.onReturn(a)};OU.util.Spinner.prototype.findCur=function(){this.prevCur=this.cur;for(var a=this.min,b,c;a<=this.max;a++)if(b=(a-1)*this.boxH,c=Math.abs(this.yO),c>b-3&&c<b+3){this.cur=a;1==this.cur&&this.prevCur==this.max&&(this.cur=this.max,b=(this.cur-1)*this.boxH,this.yO=-1*b);break}};
OU.util.Spinner.prototype.renderLoop=function(a){var b=a||this,c,a=this.layer.events,d=a.x,e=a.y,f=a.pressed||a.touched,g=this.touchBubble;c=this.innertouchBubble;if(this.doRender){if(f){if(this.noTouching=0,this.virgin=!1,this.touchReady)if(d>g.x&&d<g.x+g.w&&e>g.y&&e<g.y+g.h)this.touched=!0,this.bounceBack=this.flicked=!1,null===this.prevY&&(this.prevY=a.y),this.d=this.yO<-1*this.max*this.boxH||0<this.yO?0.15*(this.layer.events.y-this.prevY):(a.y-this.prevY)*this.friction,this.prevY=a.y;else{a.flush();
this.doRender=!1;setTimeout(function(){b.returnValue()},5);return}}else{if(this.touched&&(d=Math.abs(this.yO),0<d%this.boxH||d>this.boxH*(this.max-1)))this.doanimation=!0,this.touched=!1;this.prevY=null;this.noTouching++;if(!this.virgin&&20<this.noTouching){a.flush();this.doRender=!1;setTimeout(function(){b.returnValue()},5);return}}d=Math.abs(this.d);!f&&5<d&&!this.flicked&&(this.flicked=!0,this.doanimation=this.bounceBack=!1,this.hold=0);f&&0===d&&!this.flicked&&this.hold++;if(!f&&0===d&&!this.flicked){if(0<
this.hold&&5>this.hold){c=(a.lastTouch.y-c.y)/this.boxH|0;0===c&&(this.d=this.boxH/3,this.flicked=!0,this.doanimation=this.bounceBack=!1);if(1===c){a.flush();this.doRender=!1;setTimeout(function(){b.returnValue()},5);return}2<=c&&(this.d=-1*(this.boxH/3),this.flicked=!0,this.doanimation=this.bounceBack=!1)}this.hold=0}this.bounceBack||this.calculate();this.doanimation&&!f?(f=!1,d=Math.abs(this.yO),d>this.boxH*(this.max-1)?(c=d-this.boxH*(this.max-1),f=!0):c=this.yO%this.boxH,a=Math.abs(c),c=c&&c/
a,1>this.boxH-a&&!f||this.animationstop)?(this.animationstop=this.doanimation=!1,this.yO=c*(d|0)/this.boxH*this.boxH,this.findCur()):(a=a>this.boxH/2&&!f?c*((this.boxH-a)/2):a/2,Math.abs(a)<this.FrictionEpsilon&&(this.animationstop=!0),this.yO+=a):this.doanimation=!1;0<this.yO&&(this.yO=0);this.yO<-1*this.max*this.boxH&&0!==this.yO&&(this.yO=-1*(this.max-1)*this.boxH);this.prevCur=this.cur;this.findCur();this.render();2==this.cur&&2==this.tutor&&(this.parent.killTutorPopup(),this.parent.tutorPopup({x:this.parent.tutorSteps[2].x,
y:this.parent.tutorSteps[2].y,w:this.parent.tutorSteps[2].w,h:this.parent.tutorSteps[2].h,txt:this.parent.tutorSteps[2].txt,k:3}),this.parent.tutor=this.tutor=3);this.displayed||(this.displayed=!0);this.doRender&&setTimeout(function(){b.renderLoop()},40)}};
OU.util.Spinner.prototype.calculate=function(){var a,b=this.boxH;if(0<Math.abs(this.d)&&(this.flicked||(this.yO+=this.d),this.flicked))(this.yO+=this.d,1.9>Math.abs(this.d))?(a=this.yO%b,Math.abs(a)<3*(b/4)&&(this.doanimation||(this.doanimation=!0,this.flicked=!1,this.d=0),this.d/=2,0.01>Math.abs(this.d)&&(this.d=0,this.bounceBack=!1,this.yO=Math.floor(this.yO)),this.d*=-1),Math.abs(Math.floor(this.yO%b))===Math.abs(b)&&(0>this.d&&(this.yO-=b),this.d=0,this.flicked=!1)):this.d*=0.75;0<this.yO&&(this.yO=
0);this.yO<-1*this.max*this.boxH&&0!==this.yO&&(this.yO=-1*(this.max-1)*this.boxH);this.findCur()};
OU.util.TabSlide=function(a){var b=OU.controlHeight;this.params=a;this.title=a.title||"Info";this.html=a.html||"<h1>Oops!</h1><p>Should be some content here...</p>";this.tabCol=a.tabCol||"#444";this.textCol=a.textCol||"#fff";this.container=a.container;this.zIndex=a.zIndex||OU.DATA_LEVEL+1;this.w=a.w||this.container.w-2*b;this.h=a.h||this.container.h-2*b;this.x=b-this.w-1;this.y=a.y||b;this.isOpen=!1;OU.util.TabSlide.prototype.init=function(){this.div=new OU.util.Div({x:this.x,y:this.y,w:this.w,h:this.h,
htmlClass:"tabSlide",zIndex:this.zIndex,container:this.container});void 0===OU._tSlides&&(OU._tSlides=[]);OU._tSlides.push(this);this.slideIdx=OU._tSlides.length-1;this.div.div.innerHTML="<div onclick='OU._tSlides["+this.slideIdx+"].toggle();' class='tabSlideTab tsClosed' style='background: "+this.tabCol+"; color: "+this.textCol+"; width:"+(this.h-30)+"px; margin:"+(this.h/2-20)+"px -"+(this.h/2-20)+"px;'>"+this.title+"<span style='padding-left:30px;'>\u2195</span></div><div class='content'>"+this.html+
"</div>"};OU.util.TabSlide.prototype.toTop=function(){var a,d;for(a=OU._tSlides.length;a--;)d=OU._tSlides[a],d.div.opacity(0),d.div.zIndex(d.zIndex),d.targX=d.x=b-d.w-1,d.div.div.style.left=b-d.w-1+"px";this.div.opacity(1);this.div.zIndex(OU.CONTROL_LEVEL-1)};OU.util.TabSlide.prototype.slide=function(){var a=this;OU.disableResize();0.01>this.x-this.targX&&-0.01<this.x-this.targX?(this.x=this.targX,OU.enableResize()):(this.x+=(this.targX-this.x)/2,this.div.div.style.left=this.x+"px",setTimeout(function(){a.slide()},
40))};OU.util.TabSlide.prototype.toggle=function(){this.targX=this.isOpen?b-this.w-1:(this.container.w-this.w)/2;this.slide();this.isOpen=!this.isOpen};this.init()};
OU.util.ThumbControls=function(a){this.container=a.container;this.context=a.context;this.leftOn=void 0===a.leftOn?!0:a.leftOn;this.rightOn=void 0===a.rightOn?!0:a.rightOn;this.stickCallback=a.stickCallback||function(){};this.stickLabel=a.stickLabel;OU.addRemovable(this,this.container.zOffset);OU.util.ThumbControls.prototype.init=function(){var a=this.container;this.leftOn&&(this.leftLayer=new OU.util.Layer({container:a,y:a.h-120,w:120,h:120,hasEvents:!0}),this.stick=new this.stick({controller:this,
context:this.leftLayer.context}),this.leftLayer.events.clickable.push(this.stick));this.rightOn&&(this.rightLayer=new OU.util.Layer({container:a,x:a.w-120,y:a.h-120,w:120,h:120,hasEvents:!0}));this.render()};OU.util.ThumbControls.prototype.render=function(){var a,c=2*Math.PI,d=this;this.leftOn&&(a=this.leftLayer.context,a.save(),a.beginPath(),a.lineWidth=2,a.arc(40,82,80,0,c,!1),a.strokeStyle="#777",a.fillStyle="#fff",a.fill(),a.stroke(),a.restore(),a.fillStyle="#fff",a.fillRect(0,80,120,40),this.stick.render(),
void 0!==this.stickLabel&&(a.textAlign="center",a.fillText(this.stickLabel,50,110)));this.rightOn&&(a=this.rightLayer.context,a.save(),a.beginPath(),a.lineWidth=2,a.arc(80,82,80,0,c,!1),a.strokeStyle="#777",a.fillStyle="#fff",a.fill(),a.stroke(),a.restore(),a.fillStyle="#fff",a.fillRect(0,80,120,40),this.dPadU=new OU.util.ControlButton({txt:"Select",x:30,y:15,w:90,h:30,layer:this.rightLayer,onClick:function(){d.dPadActionU()}}),this.dPadL=new OU.util.ControlButton({txt:"Select",x:5,y:49,w:60,h:30,
layer:this.rightLayer,onClick:function(){d.dPadActionL()}}),this.dPadR=new OU.util.ControlButton({txt:"Select",x:60,y:49,w:60,h:30,layer:this.rightLayer,onClick:function(){d.dPadActionL()}}),this.dPadD=new OU.util.ControlButton({txt:"Select",x:20,y:84,w:90,h:30,layer:this.rightLayer,onClick:function(){d.dPadActionL()}}))};OU.util.ThumbControls.prototype.stick=function(a){var c=2*Math.PI,d;this.params=a;this.controller=a.controller;this.position={x:0,y:0};OU.util.ThumbControls.prototype.stick.prototype.render=
function(){var a=this.params.context,b=this.position.x,g=this.position.y;a.beginPath();a.arc(50,60,40,0,c,!1);d=a.createRadialGradient(50+b/2,60+g/2,0,50,60,40);d.addColorStop(0,"#000");d.addColorStop(0.5,"#999");d.addColorStop(0.85,"#444");d.addColorStop(1,"#fff");a.fillStyle=d;a.fill();a.beginPath();a.arc(51+b,61+g,30,0,c,!1);d=a.createRadialGradient(36+b,46+g,0,51+b,61+g,30);d.addColorStop(0,"#444");d.addColorStop(0.4,"#666");d.addColorStop(0.85,"#ccc");d.addColorStop(1,"#000");a.fillStyle=d;a.fill();
a.gripPattern({col:"#ccc",x:40+b,y:50+g,w:20,h:20})};OU.util.ThumbControls.prototype.stick.prototype.isHit=function(a,b,c){a-=51;b-=61;this.position=c?{x:-15>a?-15:15<a?15:a,y:-15>b?-15:15<b?15:b}:{x:0,y:0};this.controller.render()};OU.util.ThumbControls.prototype.stick.prototype.cycle=function(){var a=this;(0!=this.position.x||0!=this.position.y)&&this.controller.stickCallback({x:this.position.x/15,y:this.position.y/15});setTimeout(function(){a.cycle()},40)};this.cycle()};OU.util.ThumbControls.prototype.resize=
function(){var a=this.container;this.leftOn&&this.leftLayer.resize({x:0,y:a.h-120,w:120,h:120});this.rightOn&&this.rightLayer.resize({x:a.w-120,y:a.h-120,w:120,h:120});this.render()};this.init()};
OU.util.TiledMenu=function(a){this.menus=a.menus;this.container=a.container;this.register=a.dontRegister||!1;this.x=a.x||this.container.x||0;this.y=a.y||this.container.y||0;this.w=a.w||this.container.w;this.h=a.h||this.container.h;this.showHighlight=!1===a.showHighlight?!1:!0;this.style=this.menus.style||"horizontal";this.shadow=this.menus.shadow||!1;this.title=a.title||"";this.zIndex=a.zIndex||OU.CONTROLLER_LEVEL-1;OU.util.TiledMenu.prototype.init=function(){var a=this.menus,c,d=this.menus.autoLoad;
this.menuId=OU.menus.length;OU.menus[this.menuId]=this;this.menuDiv=new OU.util.Div({dontRegister:this.register,x:this.x,y:this.y,w:this.w,h:"auto",zIndex:this.zIndex,container:this.container,showScroll:!1});OU.nobbleDoneBar(this.menuDiv.div);a.selected=[];for(c=a.levels;c--;)a.selected[c]=OU.LocalStorage.load("ou.menus."+this.container.instance+"."+this.menuId+"._"+c)||0;this.render(0==this.menuId&&d)};OU.util.TiledMenu.prototype.resize=function(a){this.x=a.x||this.container.x||0;this.y=a.y||this.container.y||
0;this.w=a.w||this.container.w;this.h=a.h||this.container.h;this.menuDiv.resize({x:this.x,y:this.y,w:this.w,h:"auto"})};OU.util.TiledMenu.prototype.render=function(a){var c=this.menus,d=OU.controlHeight,e,f,g="",h=c,i,j,m=this;for(e=0;e<c.levels;e++){g=c.shadow?g+("<div class='_menudivShadow' style='height: "+d+"px'>"):g+("<div class='_menudiv' style='height: "+d+"px'>");""!=this.title&&(g+="<strong>"+this.title+"</strong><br/>");for(f=0;f<h.sections.length;f++)j=h.sections[f],"button"==j.type?(i=
j,g+="<a href='' ",g=j.step==parseInt(h.selected[0])+1&&this.showHighlight?g+"class='_abutton highlighted' ":g+"class='_abutton' ",g+="id='ou.menu."+this.menuId+"."+e+"."+f+"' ",g=i.img?g+("><img src='"+i.img+"' alt='"+i.title+"' title='"+i.title+"'/></a>"):g+(">"+i.title+"</a>"),"vertical"==this.style&&(g+="<br clear='left'/>"),a&&f==c.selected[e]&&void 0===i.menu&&this.loadContent(i)):g+="<"+j.type+">"+j.content+"</"+j.type+">";g+="</div>";h=h.sections[c.selected[e]].menu;void 0===h&&(e=c.levels)}this.menuDiv.div.innerHTML=
g;a=function(){var a=this.getAttribute("id").split("."),b=a.length;m.step(parseInt(a[b-2]),parseInt(a[b-1]))};h=c;for(e=0;e<c.levels;e++){for(f=0;f<h.sections.length;f++)if(j=h.sections[f],"button"==j.type&&(j=document.getElementById("ou.menu."+this.menuId+"."+e+"."+f)))j.addEventListener("mousedown",a,!1),j.addEventListener("touchstart",a,!1);h=h.sections[c.selected[e]].menu;void 0===h&&(e=c.levels)}};OU.util.TiledMenu.prototype.loadContent=function(a){void 0!==a.step&&this.container.controller.step(a.step);
void 0!==a.controller&&this.container.controller.overrideSection(a.controller);void 0!==a.activityPopup&&this.container.controller.addActivity(a.activityPopup)};OU.util.TiledMenu.prototype.step=function(a,c){var d=this.menus,e,f,g;d.selected[a]=c;e=d;for(f=0;f<d.levels;f++)d.selected[f]>e.sections.length-1&&(d.selected[f]=e.sections.length-1),g=e.sections[d.selected[f]],void 0===g.menu?this.loadContent(g):e=g.menu;this.render(!1);for(f=d.levels;f--;)OU.LocalStorage.save("ou.menus."+this.container.instance+
"."+this.menuId+"._"+f,d.selected[f])};this.init()};
OU.util.TileRotation=function(a){this.context=a.context;this.container=a.container;this.imageBase=a.imageBase||[];this.numImages=this.imageBase.length;this.imageIdx=0;this.window=a.window||{w:1024,h:768};this.v={};this.dims=a.image||{};this.useTileGroups=void 0===a.useTileGroups?!0:a.useTileGroups;this.tileSize=a.tileSize||256;this.nZ=a.zoomLevels||0;this.x=this.y=this.s=this.z=0;this.doRender=!1;this.zoomCallback=a.zoomCallback||function(){};this.mouseDown=this.inDrag=this.hasDragged=!1;this.history=
[];this.inertia={x:0,y:0};this.dataDir=this.container.dataDir;OU.util.TileRotation.prototype.init=function(){var a,c,d=this.nZ,e=this.tileSize*Math.pow(2,d-1),f,g,h,i,j=1,m=1,k,p,j=this.imageBase[this.imageIdx].pixelsPerMM,m=OU.getUrlVars();p=k=0;var x;if(!this.dims.w||1>this.dims.w||!this.dims.h||1>this.dims.h)this.dims.w=this.dims.h=e;x=this.propX=this.dims.w/e;e=this.propY=this.dims.h/e;a=this.uncroppedW=this.dims.w;c=this.uncroppedH=this.dims.h;k=this.window.w/a;p=this.window.h/c;this.viewAllScale=
k<p?k:p;this.scaleFactor=1-this.viewAllScale;m.zoom&&(this.s=parseFloat(m.zoom),this.s=0>this.s?0:1<this.s?1:this.s);this.x=m.x?this.container.w/2-parseFloat(m.x)*j*(this.s*this.scaleFactor+this.viewAllScale):(this.window.w-a*this.viewAllScale)/2;this.y=m.y?(this.container.h-OU.controlHeight)/2-parseFloat(m.y)*j*(this.s*this.scaleFactor+this.viewAllScale):(this.window.h-c*this.viewAllScale)/2;for(f=this.numImages;f--;){j=1;k=p=0;this.imageBase[f]._tiles=[];c=this.imageBase[f].fileType||".jpg";for(g=
0;g<d;g++){this.imageBase[f]._tiles[g]=[];for(h=0;h<j*x+1;h++)this.imageBase[f]._tiles[g][h]=[];j*=2}j=m=1;for(g=0;g<d;g++){for(i=0;i<m*e;i++)for(h=0;h<j*x;h++)this.useTileGroups?(a=this.dataDir+this.imageBase[f].fileBase+"/TileGroup"+k+"/"+g+"-"+h+"-"+i+c,p++,255<p&&(p=0,k++)):a=this.dataDir+this.imageBase[f].fileBase+g+"_"+h+"_"+i+c,this.imageBase[f]._tiles[g][h][i]={file:a,loadState:0};j*=2;m*=2}this.loadTile(this.imageBase[f]._tiles[0][0][0])}this._tiles=this.imageBase[this.imageIdx]._tiles;this.rough=
this._tiles[0][0][0].image;this.roughSF=this.dims.w>this.dims.h?this.rough.width/this.tileSize:this.rough.height/this.tileSize;this.context.font="18px "+OU.theme.font;this.context.lineWidth=2;this.context.strokeStyle="#c00";this.context.fillStyle="#c00";this.context.textAlign="center";this.renderCycle();this.purge()};OU.util.TileRotation.prototype.changeImage=function(a){this.imageIdx=0>a?this.numImages-1:a>this.numImages-1?0:a;this._tiles=this.imageBase[this.imageIdx]._tiles;this.rough=this._tiles[0][0][0].image;
this.doRender=!0};OU.util.TileRotation.prototype.enableLoading=function(){this.disableLoad=!1;this.doRender=!0};OU.util.TileRotation.prototype.disableLoading=function(){this.disableLoad=!0};OU.util.TileRotation.prototype.loadTile=function(a){if(0==a.loadState&&!0!==this.disableLoad){var c=this;a.loadState=1;a.image=new Image;a.image.src=a.file;a.image.onload=function(){a.loadState=2;a.width=a.image.width;a.height=a.image.height;c.doRender=!0};a.image.onerror=function(){}}};OU.util.TileRotation.prototype.purge=
function(){var a=this,c,d,e,f,g,h,i,j=(new Date).getTime();for(c=this.numImages;c--;){e=1;d=this.imageBase[c]._tiles;for(f=0;f<this.nZ;f++){for(g=e;g--;)for(h=e;h--;)if(i=d[f]?d[f][g]?d[f][g][h]:void 0:void 0,void 0!==i&&void 0!==i.image&&2==i.loadState&&i.lastUsed<j-1E3&&(0!=f||0!=g||0!=h))i.lastUsed=j,i.loadState=0,i.image=void 0;e*=2}}setTimeout(function(){a.purge()},40)};OU.util.TileRotation.prototype.isHit=function(a,c,d){var e,f=this.uncroppedW,g=this.uncroppedH,h=this.s*this.scaleFactor+this.viewAllScale;
e=this.x;var i=this.y;void 0!==d&&(this.mouseDown=d);if(this.mouseDown)this.inDrag?(this.measureOn?(this.renderMeasure=!0,this.measureEndX=(a-e)/h,this.measureEndY=(c-i)/h):(d=a-this.dragStartX,e=c-this.dragStartY,this.x=(this.x+d)%(f*h),this.y=(this.y+e)%(g*h),this.dragStartX=a,this.dragStartY=c),this.doRender=!0):(this.inertia={x:0,y:0},this.dragStartX=a,this.dragStartY=c,this.inDrag=!0,this.measureOn&&(this.measureStartX=(a-e)/h,this.measureStartY=(c-i)/h));else if(this.inDrag&&0<this.history.length&&
(this.inertia={x:(this.x-this.history[0].x)/4,y:(this.y-this.history[0].y)/4}),this.inDrag=!1,this.circleOn)this.doRender=!0};OU.util.TileRotation.prototype.stop=function(){this.inertia={x:0,y:0};this.doRender=!1};OU.util.TileRotation.prototype.scale=function(a,c){var d=1<a?1:0>a?0:a,e=(d*this.scaleFactor+this.viewAllScale)/(this.s*this.scaleFactor+this.viewAllScale),f=this.window.w/2,g=this.window.h/2;c&&(f=c.x,g=c.y,this.history.length=0);f-=this.x;g-=this.y;this.x+=f-f*e;this.y+=g-g*e;this.s=d;
this.doRender=!0};OU.util.TileRotation.prototype.renderCycle=function(){var a=this,c,d=this.dims.w,e=this.dims.h;4<this.history.length&&this.history.shift();this.history.push({x:this.x,y:this.y});if(!this.mouseDown&&(0!=this.inertia.x||0!=this.inertia.y))c=this.s*this.scaleFactor+this.viewAllScale,this.x=(this.x+this.inertia.x)%(d*c),this.y=(this.y+this.inertia.y)%(e*c),this.inertia.x*=0.9,this.inertia.y*=0.9,this.inertia.x=2>this.inertia.x&&-2<this.inertia.x?0:this.inertia.x,this.inertia.y=2>this.inertia.y&&
-2<this.inertia.y?0:this.inertia.y,this.doRender=!0;this.doRender&&this.render();setTimeout(function(){a.renderCycle()},40)};OU.util.TileRotation.prototype.render=function(){var a,c,d,e,f,g,h,i,j,m,k,p;e=this.nZ;var x=(new Date).getTime(),P=this.context;h=this.uncroppedW;i=this.uncroppedH;var z=this.s*this.scaleFactor+this.viewAllScale,A=e*((1-this.viewAllScale)*z+this.viewAllScale)|0,A=A>=e-1?e-1:A;if(this.rough){if(this.dims.w<this.dims.h){do A++,a=Math.pow(2,A),j=h/a/this.propX;while(j*z>1.05*
this.tileSize&&A<e-1);A==e&&(a/=2);c=a*i/h|0;j=h/a/this.propX}else{do A++,c=Math.pow(2,A),j=i/c/this.propY;while(j*z>1.05*this.tileSize&&A<e-1);A==e&&(c/=2);a=c*h/i|0;j=i/c/this.propY}this.z=A=A>=e-1?e-1:A;0<this.y&&(this.y=0);this.y<this.window.h-this.dims.h*z&&(this.y=this.window.h-this.dims.h*z);this.v.x=-this.x/z;this.v.y=-this.y/z;this.v.w=this.window.w/z;this.v.h=this.window.h/z;d=this.v.x/j|0;e=((this.v.x+this.v.w)/j|0)+1;f=this.v.y/j|0;g=((this.v.y+this.v.h)/j|0)+1;d=0>d?0:d>a-1?a-1:d;e=0>
e?0:e>a-1?a-1:e;f=0>f?0:f>c-1?c-1:f;g=0>g?0:g>c?c:g;P.clearRect(0,0,this.window.w,this.window.h);P.drawImage(this.rough,this.x,this.y,h*z,i*z);for(c=d;c<=e;c++)for(h=f;h<=g;h++)if(i=c,i=0>i?i+a:i,this._tiles[A][i]&&(i=this._tiles[A][i][h]))2==i.loadState?(i.lastUsed=x,d=this.x+c*j*z,m=this.y+h*j*z,k=i.width/this.tileSize*j*z,p=i.height/this.tileSize*j*z,P.drawImage(i.image,d,m,k,p)):0==i.loadState&&this.loadTile(i);this.doRender=!1}};this.init()};OU.require("OU.util.Vector2D");OU.require("OU.util.Blur");
OU.util.TileViewer=function(a){this.context=a.context;this.container=a.container;this.imageBase=a.imageBase||[];this.renderAngle=a.renderAngle||!1;this.rotationImageFile=a.rotationImage;this.numberMarkers=a.numberMarkers;this.showHotspots=a.showHotspots||!1;this.hotspotOutlineColour=a.hotspotOutlineColour;this.numImages=this.imageBase.length;this.requireDouble=a.requireDouble||!1;this.vectorAngles=a.vectorAngles||!0;this.micronThreshold=void 0===a.micronThreshold?1:a.micronThreshold;this.numDecimals=
void 0===a.numDecimals?2:a.numDecimals;this.horizontalStitch=a.horizontalStitch||!1;this.useGoogleMapsFileConvention=a.useGoogleMapsFileConvention||!1;this.markerCallback=a.markerCallback||function(){};this.imageIdx=0;this.window=a.window||{w:1024,h:768};this.fitScreen=a.fitScreen||!1;this.v={};this.crop=a.crop||{x:0,y:0};this.dims=a.image||{};this.useTileGroups=a.useTileGroups;this.tileSize=a.tileSize||256;this.nZ=a.zoomLevels||0;this.measureMM=this.x=this.y=this.s=this.z=0;this.doRender=!1;this.zoomCallback=
a.zoomCallback||function(){};this.extendDrag=a.extendDrag;this.mouseDown=this.inDrag=this.hasDragged=!1;this.history=[];this.inertia={x:0,y:0};this.lastTouch={x:0,y:0};this.blurRadius=0;this.brightenFactor=1;this.showRulers=a.showRulers||!1;this.rulerGuide={out:!1,x:0,y:0};this.dragRuler=!1;this.dataDir=this.container.dataDir;this.uncroppedW=this.dims.w+2*this.crop.x;this.uncroppedH=this.dims.h+2*this.crop.y;a.thumbnail&&(a.thumbnail.tileViewer=this,this.thumbnail=new this.Thumbnail(a.thumbnail));
OU.util.TileViewer.prototype.init=function(){var a,c,d=this.nZ,e=this.tileSize*Math.pow(2,d-1);c=OU.getUrlVars();var f=this,g,h,i,j,m=1,k=1,m=this.imageBase[this.imageIdx].pixelsPerMM,p=0,x=0,p=this.uncroppedW,x=this.uncroppedH,P;g=this.showRulers?30:0;this.imageIdx=c.s||0;if(!this.dims.w||this.dims.w<1||!this.dims.h||this.dims.h<1)this.dims.w=this.dims.h=e;P=this.propX=this.dims.w/e;e=this.propY=this.dims.h/e;if(this.horizontalStitch)this.viewAllScale=(this.window.h-g)/x;else{k=(this.window.w-g)/
p;g=(this.window.h-g)/x;this.viewAllScale=this.fitScreen?k>g?k:g:k<g?k:g}this.scaleFactor=1-this.viewAllScale;if(c.zoom){this.s=parseFloat(c.zoom);this.s=this.s<0?0:this.s>1?1:this.s}this.x=c.x?this.window.w/2-parseFloat(c.x)*m*(this.s*this.scaleFactor+this.viewAllScale):this.horizontalStitch?0:(this.window.w-p*this.viewAllScale)/2;this.y=c.y?this.window.h/2-parseFloat(c.y)*m*(this.s*this.scaleFactor+this.viewAllScale):(this.window.h-x*this.viewAllScale)/2;for(g=this.numImages;g--;){m=k=1;p=x=0;this.imageBase[g]._tiles=
[];c=this.imageBase[g].fileType||".jpg";for(h=0;h<d;h++){this.imageBase[g]._tiles[h]=[];for(i=0;i<m*P+1;i++)this.imageBase[g]._tiles[h][i]=[];m=m*2}m=k=1;for(h=0;h<d;h++){for(j=0;j<k*e;j++)for(i=0;i<m*P;i++){if(this.useGoogleMapsFileConvention){a=this.getTileURL({x:i,y:j},h);a=this.dataDir+this.imageBase[g].fileBase+a+c}else if(this.useTileGroups){a=this.dataDir+this.imageBase[g].fileBase+"/TileGroup"+p+"/"+h+"-"+i+"-"+j+c;x++;if(x>255){x=0;p++}}else a=this.dataDir+this.imageBase[g].fileBase+h+"_"+
i+"_"+j+c;this.imageBase[g]._tiles[h][i][j]={file:a,loadState:0}}m=m*2;k=k*2}this.loadTile(this.imageBase[g]._tiles[0][0][0])}this.rotationImageLoaded=false;if(this.rotationImageFile){this.rotationImage=new Image;this.rotationImage.src=this.dataDir+this.rotationImageFile;this.rotationImage.onload=function(){f.rotationImageLoaded=true;f.doRender=true}}this._tiles=this.imageBase[this.imageIdx]._tiles;this.rough=this._tiles[0][0][0].image;this.roughSF=this.dims.w>this.dims.h?this.rough.width/this.tileSize:
this.rough.height/this.tileSize;this.hotspots=this.imageBase[this.imageIdx].rotations||this.imageBase[this.imageIdx].layers||this.imageBase[this.imageIdx].hotspots||void 0;this.context.font="18px "+OU.theme.font;this.context.lineWidth=2;this.context.strokeStyle="#c00";this.context.fillStyle="#c00";this.context.textAlign="center";this.renderCycle()};OU.util.TileViewer.prototype.resize=function(a){this.window.w=a.w||this.window.w;this.window.h=a.h||this.window.h;this.thumbnail&&a.thumbnail&&this.thumbnail.resize(a.thumbnail)};
OU.util.TileViewer.prototype.getTileURL=function(a,c){var d=Math.pow(2,c),e=a.x,f=a.y,g="t",h;for(h=0;h<c;h++){d=d/2;if(f<d)if(e<d)g=g+"q";else{g=g+"r";e=e-d}else{if(e<d)g=g+"t";else{g=g+"s";e=e-d}f=f-d}}return g};OU.util.TileViewer.prototype.changeImage=function(a){this.imageIdx=a<0?0:a>this.numImages?this.numImages:a;this._tiles=this.imageBase[this.imageIdx]._tiles;this.rough=this._tiles[0][0][0].image;this.doRender=true};OU.util.TileViewer.prototype.loadTile=function(a){if(a.loadState===0){var c=
this;a.loadState=1;a.image=new Image;a.image.src=a.file;a.image.onload=function(){a.loadState=2;a.width=a.image.width;a.height=a.image.height;c.doRender=true};a.image.onerror=function(){}}};OU.util.TileViewer.prototype.isHit=function(a,c,d,e){var f,g;f=false;var h=this.uncroppedW,i=this.uncroppedH,j=this.s*this.scaleFactor+this.viewAllScale;g=this.x+this.crop.x*j;var m,k=this.y+this.crop.y*j;m=this.imageBase[this.imageIdx].pixelsPerMM;if(d!==void 0)this.mouseDown=d;if(e.doubleTap){e.doubleTap=false;
if(this.requireDouble){this.markerHit(a,c);return}}if(this.mouseDown){this.lastTouch.x=a;this.lastTouch.y=c;if(this.showRulers&&!this.dragRuler)if(this.rulerGuide.out){d=this.x+this.rulerGuide.x*m*j;m=this.y+this.rulerGuide.y*m*j;if(Math.abs(a-d)<25&&Math.abs(c-m)<25)this.dragRuler=true}else{if(a<30&&c<30)this.dragRuler=this.rulerGuide.out=true}else{this.rulerGuide.x=(a-this.x)/j/m;this.rulerGuide.y=(c-this.y)/j/m;this.doRender=true}if(!this.dragRuler)if(this.inDrag){if(this.measureOn){this.renderMeasure=
true;this.measureEndX=(a-g)/j;this.measureEndY=(c-k)/j}else{f=a-this.dragStartX;g=c-this.dragStartY;this.x=(this.x+f)%(h*j);this.y=(this.y+g)%(i*j);this.dragStartX=a;this.dragStartY=c}this.doRender=true}else{this.requireDouble||(f=this.markerHit(a,c));if(!f){this.inertia={x:0,y:0};this.dragStartX=a;this.dragStartY=c;this.inDrag=true;if(this.measureOn){if(this.measurePrevStartX)this.measurePrevStartX=null;else{this.measurePrevStartX=this.measureStartX;this.measurePrevStartY=this.measureStartY;this.measurePrevEndX=
this.measureEndX;this.measurePrevEndY=this.measureEndY}this.measureStartX=(a-g)/j;this.measureStartY=(c-k)/j}}}}else{this.dragRuler=false;if(a==0&&c==0){a=this.lastTouch.x;c=this.lastTouch.y}if(a<30&&c<30&&(a>0||c>0)){if(this.rulerGuide.out)this.doRender=true;this.rulerGuide.out=false}if(this.inDrag&&this.history.length>0)this.inertia={x:(this.x-this.history[0].x)/4,y:(this.y-this.history[0].y)/4};this.inDrag=false;if(this.circleOn)this.doRender=true}};OU.util.TileViewer.prototype.markerHit=function(a,
c){var d,e,f=this.s*this.scaleFactor+this.viewAllScale,g=this.x+this.crop.x*f,h=this.y+this.crop.y*f,i,j,m,k=false,p=this.hotspots;if(p&&p.length>0)for(i=p.length;i--;){j=p[i];m=false;if(j.hotspot!==void 0)if(j.hotspot.radius!==void 0){d=g+j.hotspot.x*f;e=h+j.hotspot.y*f;Math.sqrt((d-a)*(d-a)+(e-c)*(e-c))<=j.hotspot.radius*f&&(m=true)}else{d=g+j.hotspot.x*f;e=h+j.hotspot.y*f;a>d&&a<d+j.hotspot.w&&c>e&&c<e+j.hotspot.h&&(m=true)}else{d=g+j.x*f-this.rotationImage.width/2;e=h+j.y*f-this.rotationImage.height/
2;a>d&&a<d+this.rotationImage.width&&c>e&&c<e+this.rotationImage.height&&(m=true)}if(m){k=true;this.mouseDown=false;j.arrayIndex=i;this.markerCallback(j,this.container)}}return k};OU.util.TileViewer.prototype.stop=function(){this.inertia={x:0,y:0};this.doRender=false};OU.util.TileViewer.prototype.setFeatures=function(a){if(a.showRulers!==void 0)this.showRulers=a.showRulers;if(a.measure!==void 0)this.measureOn=a.measure;this.render()};OU.util.TileViewer.prototype.setPosition=function(a){var c=this.imageBase[this.imageIdx].pixelsPerMM;
if(a.zoom){this.s=a.zoom;this.s=this.s<0?0:this.s>1?1:this.s}if(a.xMM&&a.yMM){this.x=this.window.w/2-a.xMM*c*(this.s*this.scaleFactor+this.viewAllScale);this.y=this.window.h/2-a.yMM*c*(this.s*this.scaleFactor+this.viewAllScale)}if(a.xPixels&&a.yPixels){this.x=this.window.w/2-a.xPixels*(this.s*this.scaleFactor+this.viewAllScale);this.y=this.window.h/2-a.yPixels*(this.s*this.scaleFactor+this.viewAllScale)}this.render()};OU.util.TileViewer.prototype.getPositionPixels=function(){var a=this.s*this.scaleFactor+
this.viewAllScale;return{x:(this.window.w/2-this.x)/a|0,y:(this.window.h/2-this.y)/a|0,zoom:((a-this.viewAllScale)/(1-this.viewAllScale)).nDecimals(6)}};OU.util.TileViewer.prototype.getPositionMM=function(){var a=this.s*this.scaleFactor+this.viewAllScale,c=this.imageBase[this.imageIdx].pixelsPerMM,d=(this.window.h/2-this.y)/(c*a),e=(a-this.viewAllScale)/(1-this.viewAllScale);return{x:((this.window.w/2-this.x)/(c*a)).nDecimals(6),y:d.nDecimals(6),zoom:e.nDecimals(6)}};OU.util.TileViewer.prototype.getMeasureMM=
function(){return{distance:this.measureMM}};OU.util.TileViewer.prototype.getDirectParams=function(){var a=this.s*this.scaleFactor+this.viewAllScale,c=this.imageBase[this.imageIdx].pixelsPerMM,d=(this.window.h/2-this.y)/(c*a),e=(a-this.viewAllScale)/(1-this.viewAllScale);return"x="+((this.window.w/2-this.x)/(c*a)).nDecimals(6)+"&y="+d.nDecimals(6)+"&zoom="+e.nDecimals(6)+"&s="+this.imageIdx};OU.util.TileViewer.prototype.scale=function(a,c){var d=a>1?1:a<0?0:a,e=(d*this.scaleFactor+this.viewAllScale)/
(this.s*this.scaleFactor+this.viewAllScale),f=this.window.w/2,g=this.window.h/2;if(c){f=c.x;g=c.y;this.history.length=0}f=f-this.x;g=g-this.y;this.x=this.x+(f-f*e);this.y=this.y+(g-g*e);this.s=d;this.doRender=true};OU.util.TileViewer.prototype.renderCycle=function(){var a=this,c,d=this.uncroppedW,e=this.uncroppedH;this.history.length>4&&this.history.shift();this.history.push({x:this.x,y:this.y});if(!this.mouseDown&&(this.inertia.x!==0||this.inertia.y!==0)){c=this.s*this.scaleFactor+this.viewAllScale;
this.x=(this.x+this.inertia.x)%(d*c);this.y=(this.y+this.inertia.y)%(e*c);this.inertia.x=this.inertia.x*0.9;this.inertia.y=this.inertia.y*0.9;this.inertia.x=this.inertia.x<2&&this.inertia.x>-2?0:this.inertia.x;this.inertia.y=this.inertia.y<2&&this.inertia.y>-2?0:this.inertia.y;this.doRender=true}this.doRender&&this.render();setTimeout(function(){a.renderCycle()},40)};OU.util.TileViewer.prototype.render=function(){var a,c,d,e,f,g,h,i,j,m,k,p,x,P;f=this.nZ;var z=this.context;g=this.showRulers?30:0;
i=this.uncroppedW;j=this.uncroppedH;var A=this.hotspots,l=this.s*this.scaleFactor+this.viewAllScale;if(this.rough){c=f*((1-this.viewAllScale)*l+this.viewAllScale)|0;c=c>=f-1?f-1:c;if(this.dims.w<this.dims.h){do{c++;a=Math.pow(2,c);k=i/a/this.propX}while(k*l>1.5*this.tileSize&&c<f-1);c===f&&(a=a/2);d=a*j/i|0;k=i/a/this.propX}else{do{c++;d=Math.pow(2,c);k=j/d/this.propY}while(k*l>1.5*this.tileSize&&c<f-1);c===f&&(d=d/2);a=d*i/j|0;k=j/d/this.propY}for(this.z=c=c>=f-1?f-1:c;(this._tiles[c][a]===void 0||
this._tiles[c][a][0]===void 0)&&a>0;)a--;for(a++;(this._tiles[c][0][d]===void 0||this._tiles[c][0][d]===void 0)&&d>0;)d--;d++;if(this.extendDrag){if(this.y>this.window.h/2+g-this.crop.y*l)this.y=this.window.h/2+g-this.crop.y*l;if(this.y<this.window.h-(this.dims.h+this.crop.y)*l-this.window.h/2)this.y=this.window.h-(this.dims.h+this.crop.y)*l-this.window.h/2}else{if(this.y>g-this.crop.y*l)this.y=g-this.crop.y*l;if(this.y<this.window.h-(this.dims.h+this.crop.y)*l)this.y=this.window.h-(this.dims.h+this.crop.y)*
l<0?this.window.h-(this.dims.h+this.crop.y)*l:(this.window.h-(this.dims.h+this.crop.y)*l)/2}this.v.x=-this.x/l;this.v.y=-this.y/l;this.v.w=this.window.w/l;this.v.h=this.window.h/l;e=(this.v.x/k|0)-1;f=((this.v.x+this.v.w)/k|0)+1;g=this.v.y/k|0;h=((this.v.y+this.v.h)/k|0)+1;if(this.horizontalStitch){e=e<=0?e-1:e;f=f<=0?f-1:f}else{e=e<0?0:e>a-1?a-1:e;f=f<0?0:f>a-1?a-1:f}g=g<0?0:g>d-1?d-1:g;h=h<0?0:h>d?d:h;z.clearRect(0,0,this.window.w,this.window.h);z.drawImage(this.rough,this.x,this.y,i*l,j*l);if(this.horizontalStitch){this.x>
0&&z.drawImage(this.rough,this.x-i*l,this.y,i*l,j*l);this.x<0-(this.dims.w*l-this.window.w)&&z.drawImage(this.rough,this.x+i*l,this.y,i*l,j*l)}d=(this.tileSize-this._tiles[c][a-1][0].width)/this.tileSize*k*l;isNaN(d)&&this._tiles[c][a-2]&&(d=(this.tileSize-this._tiles[c][a-2][0].width)/this.tileSize*k*l);isNaN(d)&&(d=0);for(i=e;i<=f;i++)for(j=g;j<=h;j++){m=this.horizontalStitch?i%a:i;m=m<0?m+a:m;if(this._tiles[c][m])if(e=this._tiles[c][m][j])if(e.loadState===2){p=this.x+i*k*l;x=this.y+j*k*l;i<0&&
(p=p+d);i>m&&(p=p-d);m=e.width/this.tileSize*k*l;P=e.height/this.tileSize*k*l;z.drawImage(e.image,p,x,m,P)}else e.loadState===0&&this.loadTile(e)}this.filters();if(A&&A.length>0){if(this.rotationImageLoaded)for(a=A.length;a--;){c=A[a].hotspot?A[a].hotspot:A[a];k=this.x+c.x*l;c=this.y+c.y*l;if(k){z.drawImage(this.rotationImage,k-this.rotationImage.width/2,c-this.rotationImage.height/2,this.rotationImage.width,this.rotationImage.height);this.numberMarkers&&z.fillText(a+1,k,c)}}this.showHotspots&&this.renderHotspotOutlines()}this.showRulers&&
this.renderRulers();this.renderMeasure&&this.measureOn&&this.renderMeasurements();this.thumbnail&&this.thumbnail.render();this.monitorPositionPixels&&this.monitorPositionPixels(this.getPositionPixels());this.doRender=false}};OU.util.TileViewer.prototype.renderHotspotOutlines=function(){var a,c,d=this.hotspots,e=this.context,f=this.s*this.scaleFactor+this.viewAllScale;e.save();e.strokeStyle=this.hotspotOutlineColour||"rgba(200,0,0,0.5)";e.lineWidth=4;for(a=d.length;a--;){c=d[a].hotspot?d[a].hotspot:
d[a];e.beginPath();c.radius?e.arc(this.x+(this.crop.x+c.x)*f,this.y+(this.crop.y+c.y)*f,c.radius*f,Math.PI*2,0,false):e.roundRect(this.x+(this.crop.x+c.x)*f,this.y+(this.crop.y+c.y)*f,c.w,c.h,c.w/20);e.stroke()}e.restore()};OU.util.TileViewer.prototype.filters=function(){OU.util.Blur({context:this.context,radius:this.blurRadius});OU.util.brighten({context:this.context,factor:this.brightenFactor})};OU.util.TileViewer.prototype.renderMeasurements=function(){var a,c,d,e,f=this.s*this.scaleFactor+this.viewAllScale;
a=this.imageBase[this.imageIdx].pixelsPerMM;var g=this.context,h=new OU.util.Vector2D({x1:this.measureStartX,y1:this.measureStartY,x2:this.measureEndX,y2:this.measureEndY});c=this.measureEndX-this.measureStartX;d=this.measureEndY-this.measureStartY;if(h.hypotenuse>0){this.measureMM=h.hypotenuse/a;this.measureMicrons=this.measureMM*1E3;this.measureMM=this.measureMM.toFixed(this.numDecimals);this.measureMicrons=this.measureMicrons.toFixed(this.numDecimals);a=this.measureMM<this.micronThreshold?this.measureMicrons+
" \u03bcm":this.measureMM+" mm";this.monitorMeasureMM&&this.monitorMeasureMM({distance:this.measureMM});if(this.vectorAngles&&this.measurePrevStartX){d=new OU.util.Vector2D({x1:this.measurePrevStartX,y1:this.measurePrevStartY,x2:this.measurePrevEndX,y2:this.measurePrevEndY});c=h.intersectPoint(d);g.beginPath();g.moveTo(this.x+d.x1*f,this.y+d.y1*f);g.lineTo(this.x+d.x2*f,this.y+d.y2*f);g.moveTo(this.x+h.x1*f,this.y+h.y1*f);g.lineTo(this.x+h.x2*f,this.y+h.y2*f);g.stroke();if(c){g.beginPath();g.moveTo(this.x+
h.x1*f,this.y+h.y1*f);g.lineTo(this.x+c.x*f,this.y+c.y*f);g.lineTo(this.x+d.x1*f,this.y+d.y1*f);g.stroke();g.beginPath();g.arc(this.x+c.x*f,this.y+c.y*f,h.radius*f,h.trigRadians,d.trigRadians,false);if(!isNaN(c.x)){h=this.x+c.x*f-20;d=this.y+c.y*f+20;h=h<60?60:h;h=h>this.window.w-60?this.window.w-60:h;d=d<30?30:d;d=d>this.window.h-30?this.window.h-30:d;g.fillStyle="#fff";g.fillRect(h-30,d-10,60,20);g.fillStyle="#c00";g.fillText(c.angle.degrees.nDecimals(2)+"\u00b0",h,d)}}g.stroke()}else if(this.renderAngle){g.beginPath();
g.moveTo(this.x+this.measureStartX*f,this.y+this.measureStartY*f);g.lineTo(this.x+this.measureEndX*f,this.y+this.measureEndY*f);this.measureStartY>this.measureEndY?g.lineTo(this.x+this.measureEndX*f,this.y+this.measureStartY*f):g.lineTo(this.x+this.measureStartX*f,this.y+this.measureEndY*f);g.closePath();g.stroke();g.beginPath();if(this.measureStartY>this.measureEndY){if(this.measureStartX<this.measureEndX){g.arc(this.x+this.measureStartX*f,this.y+this.measureStartY*f,h.radius*f,-h.trigRadians,0,
false);e=-h.trigRadians}else{g.arc(this.x+this.measureStartX*f,this.y+this.measureStartY*f,h.radius*f,Math.PI,Math.PI+h.trigRadians,false);e=h.trigRadians}g.fillStyle="#fff";g.fillRect(this.x+this.measureStartX*f-50,this.y+this.measureStartY*f+10,60,20);g.fillStyle="#c00";g.fillText(h.trigDegrees.nDecimals(2)+"\u00b0",this.x+this.measureStartX*f-20,this.y+this.measureStartY*f+20)}else{if(this.measureStartX>this.measureEndX){g.arc(this.x+this.measureEndX*f,this.y+this.measureEndY*f,h.radius*f,-h.trigRadians,
0,false);e=-h.trigRadians}else{g.arc(this.x+this.measureEndX*f,this.y+this.measureEndY*f,h.radius*f,Math.PI,Math.PI+h.trigRadians,false);e=h.trigRadians}g.fillStyle="#fff";g.fillRect(this.x+this.measureEndX*f-50,this.y+this.measureEndY*f+10,60,20);g.fillStyle="#c00";g.fillText(h.trigDegrees.nDecimals(2)+"\u00b0",this.x+this.measureEndX*f-20,this.y+this.measureEndY*f+20)}g.save();g.translate(this.x+(this.measureStartX+c/2)*f,this.y+(this.measureStartY+d/2)*f);g.rotate(e);g.fillStyle="#fff";g.fillRect(-50,
-27,100,20);g.fillStyle="#c00";g.fillText(a,0,-16);g.restore();g.stroke()}else{g.beginPath();g.moveTo(this.x+this.measureStartX*f,this.y+this.measureStartY*f);g.lineTo(this.x+this.measureEndX*f,this.y+this.measureEndY*f);g.stroke();g.beginPath();e=this.measureStartY>this.measureEndY?this.measureStartX<this.measureEndX?-h.trigRadians:h.trigRadians:this.measureStartX>this.measureEndX?-h.trigRadians:h.trigRadians;g.save();g.translate(this.x+(this.measureStartX+c/2)*f,this.y+(this.measureStartY+d/2)*
f);g.rotate(e);g.fillStyle="#fff";g.fillRect(-50,-27,100,20);g.fillStyle="#c00";g.fillText(a,0,-16);g.restore()}}if(this.mouseDown&&this.measureOn){g.save();g.globalAlpha=0.5;g.beginPath();g.arc(this.x+f*this.measureEndX,this.y+f*this.measureEndY,50,0,Math.PI*2,false);g.moveTo(0,this.y+f*this.measureEndY);g.lineTo(this.window.w,this.y+f*this.measureEndY);g.moveTo(this.x+f*this.measureEndX,0);g.lineTo(this.x+f*this.measureEndX,this.window.h);g.stroke();g.restore();this.circleOn=true}};OU.util.TileViewer.prototype.renderRulers=
function(){var a=this.context,c=this.s*this.scaleFactor+this.viewAllScale,d,e=this.imageBase[this.imageIdx].pixelsPerMM,f=(0-this.y)/(e*c),g,h=((0-this.x)/(e*c)).nDecimals(1)-0.1,i=f.nDecimals(1)-0.1;a.save();a.font="12px "+OU.theme.font;a.lineWidth=0.5;a.fillStyle="rgba(255,255,255,0.7)";a.strokeStyle="#00c";a.fillRect(0,0,this.window.w,30);a.fillRect(0,30,30,this.window.h);a.fillStyle="#00c";a.beginPath();d=50/(e*c)|0;d=d<1?1:d;do{f=this.x+h*e*c;if(f>30){a.moveTo(f,30);g=h|0;if(h===g){a.lineTo(f,
12);g%d==0&&a.fillText(h,f,7.5)}else h*2-1==g*2||h*2+1==g*2?a.lineTo(f,18):a.lineTo(f,22.5)}h=(h+0.1).nDecimals(1)}while(f<this.window.w);a.stroke();a.fillStyle="#fff";a.beginPath();a.roundRect(this.window.w-60,15,40,15,5);a.fill();a.fillStyle="#00c";a.fillText("mm",this.window.w-40,22.5);do{h=this.y+i*e*c;if(h>30){a.moveTo(30,h);f=i|0;if(i===f){a.lineTo(12,h);f%d==0&&a.fillText(i,7.5,h)}else i*2-1==f*2||i*2+1==f*2?a.lineTo(18,h):a.lineTo(22.5,h)}i=(i+0.1).nDecimals(1)}while(h<this.window.h);a.stroke();
if(this.rulerGuide.out){f=this.x+this.rulerGuide.x*e*c;h=this.y+this.rulerGuide.y*e*c;a.lineWidth=1;a.beginPath();a.moveTo(0,h);a.lineTo(this.window.w,h);a.moveTo(f,0);a.lineTo(f,this.window.h);a.stroke();a.beginPath();a.arc(f,h,25,0,Math.PI*2,false);a.stroke();a.globalAlpha=0.4;a.fillStyle="#fff";a.fill();a.globalAlpha=1;c=this.rulerGuide.x.nDecimals(2)+", "+this.rulerGuide.y.nDecimals(2)+" mm";e=a.measureText(c,0,0);if(f<this.window.w/2)if(h<this.window.h/2){f=f+e.width/2+35;h=h+35}else{f=f+e.width/
2+35;h=h-35}else if(h<this.window.h/2){f=f-e.width/2-35;h=h+35}else{f=f-e.width/2-35;h=h-35}a.roundRect(f-e.width/2-10,h-10,e.width+20,20,5);a.fill();a.fillStyle="#00c";a.fillText(c,f,h)}else{a.fillStyle="#fff";a.fillRect(0,0,30,30);a.beginPath();a.arc(15,15,7.5,0,Math.PI*2,false);a.moveTo(0,15);a.lineTo(30,15);a.moveTo(15,0);a.lineTo(15,30);a.stroke()}a.restore()};this.init()};
OU.util.TileViewer.prototype.Thumbnail=function(a){this.view=a.view||"rectangle";this.tileViewer=a.tileViewer;this.context=a.layer.context;a.layer.events.clickable.push(this);OU.util.TileViewer.prototype.Thumbnail.prototype.render=function(){var a=this.context,c=this.tileViewer,d=c.uncroppedW,e=c.s*c.scaleFactor+c.viewAllScale,f=this.w/d,g=this.x+-c.x/e*f,h=this.y+-c.y/e*f,d=c.window.w/(d*e),i=c.window.h/(c.uncroppedH*e),j=this.w*d,m=this.h*i;this.thumbScale=f;this.windowScale=e;void 0!==a&&(this.tX=
g,this.tY=h,this.tW=j,this.tH=m,this.wPerc=d,this.hPerc=i,"rectangle"===this.view&&(g<this.x?(j-=this.x-g,g=this.x):g>this.x+this.w&&(j=0,g=this.x+this.w),h<this.y?(m-=this.y-h,h=this.y):h>this.y+this.h&&(m=0,h=this.y+this.h),g+j>this.x+this.w&&(j=this.x+this.w-g),h+m>this.y+this.h&&(m=this.y+this.h-h)),a.save(),a.beginPath(),a.strokeStyle="#000",a.drawImage(c.rough,this.x,this.y,this.w,this.h),a.rect(this.x,this.y,this.w,this.h),a.stroke(),a.beginPath(),a.lineWidth=2,a.strokeStyle="#f22","rectangle"===
this.view?a.rect(g,h,j,m):a.arc(g+j/2,h+m/2,j/3,0,2*Math.PI,!1),a.stroke(),a.restore())};OU.util.TileViewer.prototype.Thumbnail.prototype.move=function(a,c){var d=this.tileViewer;d.x=-((a-this.x)/this.thumbScale)*this.windowScale;d.y=-((c-this.y)/this.thumbScale)*this.windowScale;d.render()};OU.util.TileViewer.prototype.Thumbnail.prototype.isHit=function(a,c,d){var e;if(d)this.drag?(d=a-this.startDragX,e=c-this.startDragY,(0!==d||0!==e)&&!isNaN(d)&&!isNaN(e)&&this.move(this.tX+d,this.tY+e)):this.drag=
!0,this.startDragX=a,this.startDragY=c;else if(this.drag&&(this.drag=!1,0<a||0<c))d=a-this.startDragX,e=c-this.startDragY,(0!==d||0!==e)&&!isNaN(d)&&!isNaN(e)&&this.move(this.tX+d,this.tY+e)};OU.util.TileViewer.prototype.Thumbnail.prototype.resize=function(a){a.x=void 0===a.x?this.x:a.x;a.y=void 0===a.y?this.y:a.y;a.w=void 0===a.w?this.w:a.w;a.h=void 0===a.h?this.h:a.h;var c=this.tileViewer.uncroppedW/this.tileViewer.uncroppedH;a.w/this.tileViewer.uncroppedW<a.h/this.tileViewer.uncroppedH?(this.w=
a.w,this.h=this.w/c,this.x=a.x,this.y=a.y+(a.h-this.h)/2):(this.h=a.h,this.w=this.h*c,this.x=a.x+(a.w-this.w)/2,this.y=a.y)};this.resize(a)};
OU.util.Transitions=function(a,b){this.config={fps:20};this.yOffset=this.xOffset=0;this.slideSpeed=2;this.fadeSpeed=3;this.display=null;this.canvas=a;this.context=b;OU.util.Transitions.prototype.slideLeft=function(a){this.xOffset=this.canvas.width;this.yOffset=0;this.display=a;this._slideToTarget()};OU.util.Transitions.prototype.slideRight=function(a){this.xOffset=0-this.canvas.width;this.yOffset=0;this.display=a;this._slideToTarget()};OU.util.Transitions.prototype.circles=function(a,b){this.display=
a;if(void 0===b){var e=Math.floor(256*Math.random()),f=Math.floor(256*Math.random()),g=Math.floor(256*Math.random());this.colour="rgba("+e+","+f+","+g+",1)"}else this.colour=b;this.xOffset=100;this.yOffset=75;this.radius=0;this.fadeBack=this._reducingCircles;this._growingCircles()};OU.util.Transitions.prototype.fade=function(a,b){void 0===b&&(b="255,255,255");0==this.yOffset&&(this.display=a,this.rgb=b,this.xOffset=5,this.yOffset=0,this.fadeBack=this._fadeIn,this.transLayer=new OU.util.Layer,this._fadeOut())};
OU.util.Transitions.prototype._slideToTarget=function(){var a=this;1>Math.abs(this.xOffset)&&1>Math.abs(this.yOffset)?(this.yOffset=this.xOffset=0,this.display(this.xOffset,this.yOffset)):(this.display(this.xOffset,this.yOffset),this.xOffset-=this.xOffset/this.slideSpeed,this.yOffset-=this.yOffset/this.slideSpeed,setTimeout(function(){a.slideToTarget()},this.config.fps))};OU.util.Transitions.prototype._reducingCircles=function(){var a=this,b,e;this.display(0,0);if(1>this.yOffset)this.yOffset=0;else{this.context.fillStyle=
this.colour;for(b=0;b<this.canvas.width+this.xOffset;b+=this.xOffset)for(e=0;e<this.canvas.height+this.xOffset;e+=this.xOffset)this.context.beginPath(),this.context.arc(b,e,this.yOffset,0,2*Math.PI,!1),this.context.closePath(),this.context.fill();this.yOffset-=this.yOffset/this.fadeSpeed;setTimeout(function(){a._reducingCircles()},this.config.fps)}};OU.util.Transitions.prototype._growingCircles=function(){var a=this,b,e;if(this.radius>this.yOffset-1)this.fadeBack();else{this.context.fillStyle=this.colour;
for(b=0;b<this.canvas.width+this.xOffset;b+=this.xOffset)for(e=0;e<this.canvas.height+this.xOffset;e+=this.xOffset)this.context.beginPath(),this.context.arc(b,e,this.radius,0,2*Math.PI,!1),this.context.closePath(),this.context.fill();this.radius+=(this.yOffset-this.radius)/this.fadeSpeed;setTimeout(function(){a._growingCircles()},this.config.fps)}};OU.util.Transitions.prototype._fadeIn=function(){var a=this,b=this.transLayer.context;1>this.yOffset?(this.yOffset=0,this.transLayer&&this.transLayer.remove()):
(b.fillStyle="rgba("+this.rgb+","+this.yOffset/this.xOffset+")",b.fillRect(0,0,this.canvas.width,this.canvas.height),this.yOffset--,setTimeout(function(){a._fadeIn()},this.config.fps))};OU.util.Transitions.prototype._fadeOut=function(){var a=this,b=this.transLayer.context;this.yOffset>this.xOffset-1?(this.display(),this.fadeBack()):(b.fillStyle="rgba("+this.rgb+","+this.yOffset/this.xOffset+")",b.fillRect(0,0,this.canvas.width,this.canvas.height),this.yOffset++,setTimeout(function(){a._fadeOut()},
this.config.fps))}};
OU.util.varControl=function(a){this.x=a.x||0;this.y=a.y||0;this.w=a.w||0;this.h=a.h||0;this.tabIndex=a.tabIndex||0;this.layerOffset=a.layerOffset||0;this.variable=a.variable;this.valInButton=a.valInButton||!1;this.clickable=a.clickable;this.callback=a.callback||function(){};this.parent=a.parent;this.bank=a.bank;this.context=a.layer.context;this.layer=a.layer;this.instance=a.instance||"lc1";this.sW=50<this.w?50:this.w;this.sX=this.parent.x+this.x+this.w/2-this.sW/2;this.sOff=this.sX-this.x;this.isOpen=
!1;this.stackH=a.stackH||0;this.hasOnOff=this.bank.hasOnOff;this.hasSlider=this.bank.hasSlider;this.hasVal=this.bank.hasVal;this.hasGrip=this.bank.hasGrip;this.sortOrder=a.sortOrder;this.showOnOff=this.hasOnOff&&!this.hasSlider;OU.util.varControl.prototype.init=function(){this.isOpen=!1;this.button=new OU.util.ControlButton({layer:this.layer,x:this.x,y:this.y,w:this.w,h:this.h,txt:this.variable.name,onClick:this.toggle,onClickParam:this,onOffIndicator:this.showOnOff,tabIndex:this.tabIndex});this.hasGrip&&
(this.draggable=new OU.util.Draggable({me:this,x:this.sX-this.parent.x,y:this.bank.y-this.stackH,w:this.sW,h:0.8*this.h,disabled:!0,onStart:this.startDrag,onEnd:this.endDrag,onMove:this.newPos}))};OU.util.varControl.prototype.resize=function(a){this.close();this.x=a.x||this.x||0;this.y=a.y||this.y||0;this.w=a.w||this.w||100;this.h=a.h||this.h||OU.controlHeight;this.layerOffset=a.layerOffset||this.layerOffset||0;this.sW=50<this.w?50:this.w;this.sX=this.parent.x+this.x+this.w/2-this.sW/2;this.button.resize({x:this.x,
y:this.y,w:this.w,h:this.h});void 0!==this.draggable&&this.draggable.resize({x:this.sX-this.parent.x,y:this.bank.y-this.stackH,w:this.sW,h:0.8*this.h})};OU.util.varControl.prototype.render=function(){var a=this.variable,c=(100*a.val|0)/100,d=0.1*this.h,e=0.8*this.h,f=this.hasGrip?this.sX-this.parent.x:0,g=this.hasGrip?this.bank.y-this.stackH:0,h,i;this.button.params.onOff=a.val>a.min+(a.max-a.min)/2;this.valInButton&&(this.button.params.txt=a.name+": "+c);this.isOpen?(i=this.openLayer.events.clickable,
i.removeType("vcTmp"),h=this.openLayer.context,h.beginPath(),h.roundRect(f,g,this.sW,this.stackH,5),h.fillStyle="#ddd",h.fill(),h.fillStyle="#000",h.strokeStyle="#0f0",h.textAlign="center",this.hasGrip&&(h.gripPattern({x:f+this.sW/4,y:g+0.25*e,w:this.sW/2,h:0.5*e}),g+=e,i.push(this.draggable,"vcTmp")),this.hasVal&&(h.save(),h.fillStyle="rgba(26,26,26,0.95)",h.roundRect(0,7,this.sW,g+2*(e/3),3),h.fill(),h.fillStyle="#AFDFE4",h.font=this.sW/4+"px "+OU.theme.font,h.fillText(c,f+this.sW/2,g+e/3+7),g+=
e,h.roundRect(f,g,this.sW,this.stackH-e,3),h.fillStyle="rgba(26,26,26,0.95)",h.fill(),h.restore()),this.hasSlider&&(i.push(this.slider,"vcTmp"),this.slider.render((a.val-a.min)/(a.max-a.min)),g+=3*this.h),this.hasOnOff&&(a.val<a.min+(a.max-a.min)/2?(h.untickedBox({x:f+this.sW/4,y:g+e/4,w:this.sW/2,h:e/2}),a=new OU.util.InvisibleButton({x:f,y:g,w:this.sW,h:e,onClick:this.onOff,onClickParam:{me:this,val:a.max}})):(h.tickBox({x:f+this.sW/4,y:g+e/4,w:this.sW/2,h:e/2}),a=new OU.util.InvisibleButton({x:f,
y:g,w:this.sW,h:e,onClick:this.onOff,onClickParam:{me:this,val:a.min}})),i.push(a,"vcTmp")),this.context.clearRect(this.x+0.1*this.w,this.y,0.8*this.w,this.h),this.button.render(),h=this.context,h.fillStyle=this.button.params.colour,h.beginPath(),h.moveTo(this.x+this.w/2-d/2,this.y+d),h.lineTo(this.x+this.w/2+d/2,this.y+d),h.lineTo(this.x+this.w/2,this.y+2*d)):(this.context.clearRect(this.x+0.1*this.w,this.y,0.8*this.w,this.h),this.button.render(),h=this.context,h.fillStyle=this.button.params.colour,
h.beginPath(),h.moveTo(this.x+this.w/2-d/2,this.y+2*d),h.lineTo(this.x+this.w/2+d/2,this.y+2*d),h.lineTo(this.x+this.w/2,this.y+d));h.closePath();h.fill()};OU.util.varControl.prototype.toggle=function(a){var c=a.variable;!a.hasSlider&&!a.hasGrip&&!a.hasVal?(c.val=c.max,a.highlander(a),a.callback(a.parent)):(a.isOpen?a.closeControls():(a.closeControls(),a.open()),a.render())};OU.util.varControl.prototype.open=function(){var a=this.hasGrip?this.bank.y-this.stackH:0,c=0.8*this.h;this.hasGrip&&(a+=c);
this.hasVal&&(a+=c);this.openLayer=this.hasGrip?this.bank.layer:new OU.util.Layer({container:this,x:this.sX,y:this.y-this.stackH+this.layerOffset-1,w:this.sW,h:this.stackH,id:"varControlSlider",hasEvents:!0});c=this.openLayer.events.clickable;this.hasSlider&&(this.slider=new OU.util.Slider({x:this.hasGrip?this.sX:0,y:a,w:this.sW,h:3*this.h,context:this.openLayer.context,orientation:"vertical",frames:10,callback:this.varValue,callbackParam:this,instance:"s"+this.instance,sliderPos:(this.variable.val-
this.variable.min)/(this.variable.max-this.variable.min),sliderStyle:"circle",tabIndex:this.tabIndex+1}),c.push(this.slider,"vcTmp"));this.hasGrip&&(this.draggable.events=this.openLayer.events,this.draggable.disabled=!1,c.push(this.draggable,"vcTmp"));this.isOpen=!0};OU.util.varControl.prototype.close=function(){this.slider&&this.slider.remove();!this.hasGrip&&void 0!==this.openLayer&&null!=this.openLayer&&this.openLayer.remove();this.openLayer=null;this.isOpen=!1};OU.util.varControl.prototype.startDrag=
function(a){a.me.bank.controls.sort(function(a,b){return b.draggable.dragId-a.draggable.dragId});a.me.bank.doRender=!0};OU.util.varControl.prototype.endDrag=function(a){a.me.bank.doRender=!0};OU.util.varControl.prototype.newPos=function(a){var c=a.me,d=c.bank.controls,e=d.length;a.x<c.bank.x&&(a.x=c.bank.x);a.x>c.bank.x+c.bank.w-c.w&&(a.x=c.bank.x+c.bank.w-c.w);c.move(a.x);c.draggable.x=a.x;c.draggable.y=c.bank.y-c.stackH;d.sort(function(a,b){return a.x-b.x});for(a=e;a--;)d[a].sortOrder=a;d.sort(function(a,
b){return b.draggable.dragId-a.draggable.dragId});c.bank.doRender=!0};OU.util.varControl.prototype.move=function(a){a&&(this.x=a,this.button.move({x:this.x}),this.sX=this.parent.x+this.x+this.w/2-this.sW/2,this.slider&&this.slider.resize({x:this.hasGrip?this.sX:0}),this.draggable.x=this.x)};OU.util.varControl.prototype.closeControls=function(){var a=this.bank.controls,c,d;for(c=a.length;c--;)d=a[c],d.close(),d.disabled=!0;this.bank.render()};OU.util.varControl.prototype.highlander=function(a){var c=
this.bank.controls,d,e;for(d=c.length;d--;)e=c[d],e!==a&&(e.variable.val=e.variable.min);this.bank.render()};OU.util.varControl.prototype.onOff=function(a){if(void 0!==a.me){var c=a.me.variable;c.val=a.val;void 0!==a.me.slider&&(a.me.slider.halted=!0,a.me.slider.sliderPos=(c.val-c.min)/(c.max-c.min));a.me.bank.render();a.me.callback(a.me.parent)}};OU.util.varControl.prototype.varValue=function(a,c){void 0!==c&&(c.variable.val=c.variable.min+a*(c.variable.max-c.variable.min),c.callback(c.parent),c.bank.render())};
this.init()};
OU.util.varControlBank=function(a){this.params=a;this.x=a.x||0;this.y=a.y||0;this.w=a.w||300;this.h=a.h||100;this.tabIndex=a.tabIndex||100;this.fillWidth=a.fillWidth||!1;this.vars=a.vars||[];this.valInButton=a.valInButton||!1;this.stackH=0;this.numVars=this.vars.length;this.layer=a.layer;this.doRender=!1;this.hasOnOff=void 0!==a.hasOnOff?a.hasOnOff:!1;this.hasSlider=void 0!==a.hasSlider?a.hasSlider:!0;this.hasVal=void 0!==a.hasVal?a.hasVal:!0;this.hasGrip=void 0!==a.hasGrip?a.hasGrip:!1;this.init()};
OU.util.varControlBank.prototype.init=function(){var a;this.controlW=this.w/this.numVars;!this.fillWidth&&80<this.controlW&&(this.controlW=80);this.hasOnOff&&(this.stackH+=0.8*this.h);this.hasSlider&&(this.stackH+=3*this.h);this.hasVal&&(this.stackH+=0.8*this.h);this.hasGrip&&(this.stackH+=0.8*this.h);this.controls=[];for(a=this.numVars;a--;)this.controls.push(new OU.util.varControl({x:a*this.controlW+this.x,y:this.y,w:this.controlW,h:this.h,stackH:this.stackH,layerOffset:this.params.layerOffset,
variable:this.vars[a],valInButton:this.valInButton,layer:this.layer,instance:"cont"+a,bank:this,clickable:this.params.clickable,callback:this.params.callback,hasGrip:this.params.hasGrip,hasVal:this.params.hasVal,hasSlider:this.params.hasSlider,hasOnOff:this.params.hasOnOff,parent:this.params.parent,sortOrder:a,tabIndex:this.tabIndex+10*a}));this.w=this.numVars*this.controlW;if(this.params.hasGrip){var b=this;setInterval(function(){b.doRender&&b.performRender();b.params.callback(b.params.parent)},
20)}};
OU.util.varControlBank.prototype.resize=function(a){var b;this.x=a.x||this.x||0;this.y=a.y||this.y||0;this.w=a.w||this.w||300;this.h=a.h||this.h||OU.controlHeight;this.controlW=this.w/this.numVars;!this.fillWidth&&80<this.controlW&&(this.controlW=80);this.w=this.numVars*this.controlW;this.hasOnOff&&(this.stackH+=0.8*this.h);this.hasSlider&&(this.stackH+=3*this.h);this.hasVal&&(this.stackH+=0.8*this.h);this.hasGrip&&(this.stackH+=0.8*this.h);for(b=this.numVars;b--;)this.controls[b].resize({x:(this.numVars-b-
1)*this.controlW+this.x,y:this.y,w:this.controlW,h:this.h,layerOffset:a.layerOffset})};OU.util.varControlBank.prototype.render=function(){this.hasGrip?this.doRender=!0:this.performRender()};
OU.util.varControlBank.prototype.performRender=function(){var a,b;a=this.controls.length;var c=!1;this.layer.clear(this.x,this.y-this.stackH,this.w,this.h+this.stackH);if(this.params.hasGrip){for(b=a;b--;){a=this.controls[b];if(0==a.draggable.dragId){var d=a.sortOrder*this.controlW;if(a.x!=d){var c=!0,e=a.x+(d-a.x)/2;0.2>Math.abs(d-e)&&(e=d);a.move(e)}}else c=!0;a.render()}c||(this.doRender=!1)}else for(b=a;b--;)this.controls[b].render()};
OU.util.varControlBank.prototype.close=function(){0<this.controls.length&&this.controls[0].closeControls()};
OU.util.VarHist=function(a){this.params=a;this.x=a.x||0;this.y=a.y||0;this.w=a.w||100;this.h=a.h||40;this.min=a.min;this.max=a.max;this.h-=20;this.title=a.title||"";OU.util.VarHist.prototype.init=function(){var a=this.val=this.params.val||0;this.hist=[];this.hist.push(a);a<this.min&&(this.min=a);a>this.max&&(this.max=a);this.numPoints=this.w-60|0};OU.util.VarHist.prototype.resize=function(a){this.x=a.x||0;this.y=a.y||0;this.w=a.w||100;this.h=a.h||40;this.h-=20;this.numPoints=this.w-60|0;this.render()};
OU.util.VarHist.prototype.update=function(a){this.hist.push(a);this.val=a;a<this.min&&(this.min=a);a>this.max&&(this.max=a)};OU.util.VarHist.prototype.render=function(){var a=this.params.context,c,d;d=this.x;c=this.y;var e=this.w,f=this.h,g=this.max-this.min,h=this.hist.length,g=0==g?1:g;a.save();a.textAlign="center";a.strokeStyle="#999";a.fillStyle="#999";a.fillRect(d,c+f,e,20);a.strokeRect(d,c,e,f+20);a.font="12px "+OU.theme.font;a.fillStyle="#fff";a.fillText(this.title,this.x+this.w/2,this.y+this.h+
10);a.strokeStyle="#c00";a.font="bold 16px "+OU.theme.font;a.fillStyle="#444";a.fillText(this.val,this.x+30,this.y+this.h/2);a.beginPath();c=this.h*(this.hist[h-1]-this.min)/g;a.moveTo(this.x+this.w,this.y+this.h-c);for(d=this.numPoints-1;d--;)c=h-(this.numPoints-d)-1,0<=c?(c=this.h*(this.hist[c]-this.min)/g,a.lineTo(this.x+d+60,this.y+this.h-c)):d=0;a.stroke();a.restore()};OU.util.VarHist.prototype.reset=function(){this.init()};this.init()};
OU.util.Vector2D=function(a){var b=180/Math.PI;this.x1=a.x1||0;this.x2=a.x2||0;this.y1=a.y1||0;this.y2=a.y2||0;this.dX=this.x2-this.x1;this.dY=this.y2-this.y1;this.opposite=Math.abs(this.dY);this.adjacent=Math.abs(this.dX);this.hypotenuse=Math.sqrt(this.opposite*this.opposite+this.adjacent*this.adjacent);this.a=this.dY/this.dX;this.b=this.y1-this.a*this.x1;0<this.hypotenuse&&(this.trigRadians=Math.asin(this.opposite/this.hypotenuse),this.trigDegrees=this.trigRadians*b);this.radians=this.x1>this.x2?
this.y1>this.y2?this.trigRadians+1.5*Math.PI:1.5*Math.PI-this.trigRadians:this.y1>this.y2?0.5*Math.PI-this.trigRadians:this.trigRadians+0.5*Math.PI;this.degrees=this.radians*b;OU.util.Vector2D.prototype.Yvalue=function(a){return this.a*a+this.b};OU.util.Vector2D.prototype.angleToVector=function(a){var d;d=this.degrees>a.degrees?this.radians-a.radians:a.radians-this.radians;d>Math.PI&&(d=Math.PI*2-d);a=d*b;if(a>90){a=180-a;d=Math.PI-d}return{radians:d,degrees:a}};OU.util.Vector2D.prototype.intersectPoint=
function(a){var b,e;if(this.a-a.a===0)return null;b=(a.b-this.b)/(this.a-a.a);a=this.angleToVector(a);e=180-a;return{x:b,y:this.Yvalue(b),angle:a,oppositeAngle:e}}};
OU.util.ViewSlider=function(a){this.events=a.events;this.instance=a.instance||"s1";void 0===OU.sliders&&(OU.sliders=[]);OU.sliders[this.instance]=this;this.params=a;this.container=a.container;this.context=a.context;this.frames=OU.IS_IPAD?data.SLIDER_RATE_IPAD||2:data.SLIDER_RATE_PC||10;this.x=a.x||0;this.y=a.y||0;this.w=a.w||100;this.h=a.h||20;this.map=a.map;this.callback=a.callback||function(){};this.target=0;this.timer=null;this.slider={x:this.x,y:this.y,w:this.w*this.map.vpW/this.map.w,h:this.h*
this.map.vpH/this.map.h};this.slider.w>this.w&&(this.slider.w=this.w);this.halted=!1;this.init()};OU.util.ViewSlider.prototype.init=function(){this.draggable=new OU.util.Draggable({me:this,events:this.events,x:this.slider.x,y:this.slider.y,h:this.slider.h,w:this.slider.w,onStart:this.startDrag,onEnd:this.endDrag,onMove:this.newPos});this.events.clickable.push(this.draggable)};OU.util.ViewSlider.prototype.startDrag=function(){};OU.util.ViewSlider.prototype.endDrag=function(){};
OU.util.ViewSlider.prototype.newPos=function(a){var b=a.me;b.slider.x=a.x;b.slider.y=a.y;b.render();b.callback({x:(b.slider.x-b.x)*b.map.w/b.w,y:(b.slider.y-b.y)*b.map.h/b.h,me:b.container})};
OU.util.ViewSlider.prototype.render=function(a){var b=this.context;void 0!==a&&(void 0!==a.propHeight&&(this.slider.h=this.h*a.propHeight,this.slider.h>this.h&&(this.slider.h=this.h)),void 0!==a.propWidth&&(this.slider.w=this.w*a.propWidth,this.slider.w>this.w&&(this.slider.w=this.w)),this.slider.x=this.x+a.x*this.w/this.map.w,this.slider.y=this.y+a.y*this.h/this.map.h);this.slider.x<this.x&&(this.slider.x=this.x);this.slider.x>this.x+this.w-this.slider.w&&(this.slider.x=this.x+this.w-this.slider.w);
this.slider.y<this.y&&(this.slider.y=this.y);this.slider.y>this.y+this.h-this.slider.h&&(this.slider.y=this.y+this.h-this.slider.h);this.draggable.x=this.slider.x;this.draggable.y=this.slider.y;b.background({clear:!0,RGB:"255,255,255",alpha:0.8},{x:this.x-1,y:this.y-1,w:this.w+2,h:this.h+2});b.save();b.lineWidth=0.25;b.beginPath();b.fillStyle="#ccc";b.fillRect(this.slider.x,this.slider.y,this.slider.w,this.slider.h);b.strokeStyle="#444";b.strokeRect(this.slider.x,this.slider.y,this.slider.w,this.slider.h);
b.closePath();b.restore();b.gripPattern(this.calcGrip())};OU.util.ViewSlider.prototype.calcGrip=function(){var a=30<this.slider.w/2?30:this.slider.w/2,b=40<this.slider.h/2?40:this.slider.h/2;return{x:this.slider.x+(this.slider.w-a)/2,y:this.slider.y+(this.slider.h-b)/2,w:a,h:b}};